<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฎุทุฉ ุงููุดุงุท ุงูุทูุงุจู - ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
        }

        .gradient-header {
            background: linear-gradient(135deg, #00A383 0%, #0093B5 100%);
        }

        .dropdown-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .dropdown-content.active {
            max-height: 5000px; /* Adjusted for large content */
            transition: max-height 0.5s ease-in;
        }

        .rotate-arrow {
            transform: rotate(180deg);
            transition: transform 0.3s ease;
        }

        .header-input {
            background-color: transparent;
            border: none;
            color: white;
            padding: 0;
            margin: 0;
            width: 100%;
            text-align: right;
        }
        .header-input::placeholder {
            color: rgba(255, 255, 255, 0.8);
            opacity: 1;
        }

        summary {
            list-style: none;
            cursor: pointer;
        }
        summary::-webkit-details-marker {
            display: none;
        }

        .pillar-card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            border-right: 4px solid transparent;
        }
        .pillar-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .pillar-card .arrow {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.3s ease;
        }
        .pillar-card:hover .arrow {
            transform: translateY(-50%) translateX(-5px);
        }

        #updateModalContent { 
            transition: transform 0.3s ease, opacity 0.3s ease; 
        }

        @media print {
            .no-print {
                display: none !important;
            }
            .print-header, .print-footer, .print-signatures {
                display: block !important;
            }
            @page {
                size: A4 landscape;
                margin: 10mm;
            }
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Update Notification Modal -->
    <div id="updateModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 no-print hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md mx-4 text-center transform transition-all scale-95 opacity-0" id="updateModalContent">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">๐ ุชู ุชุญุฏูุซ ุงููููุน!</h2>
            <p class="text-gray-600 mb-6">โจ ูุณุนุฏูุง ุฅุจูุงุบู ุจุฃููุง ุฃุถููุง ูููุฒุงุช ุฌุฏูุฏุฉ:</p>
            <ul class="text-right list-disc list-inside mb-6 space-y-2 text-gray-700">
                <li> ุงุฎุชูุงุฑ ุฃุณุงุจูุน ูุชุนุฏุฏุฉ ูููุณ ุงูุจุฑูุงูุฌ.</li>
                <li> ููุฒุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ูุถูุงู ุนุฏู ููุฏุงู ูุนูููุงุชู.</li>
            </ul>
            <p class="font-semibold text-gray-800 mb-6">โ ุงุณุชูุชุน ุจุงูุชุฌุฑุจุฉ ุงูุฌุฏูุฏุฉ ุงูุขู!</p>
            <button onclick="closeUpdateModal()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-full hover:bg-blue-700 transition-colors duration-300">
                ููุงูู
            </button>
        </div>
    </div>

    <div id="main-content" class="transition-opacity duration-500">
        <header class="gradient-header text-white py-4 shadow-lg no-print">
            <div class="container mx-auto px-6 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <img src="https://j.top4top.io/p_3516qltr40.png" alt="ุดุนุงุฑ ุงููุฒุงุฑุฉ" class="h-16 sm:h-20">
                    <div class="flex flex-col gap-0 w-full max-w-xs sm:max-w-sm">
                        <input type="text" id="education-admin" placeholder="ุฃุฏุฎู ุงูุฅุฏุงุฑุฉ ุงูุชุนููููุฉ" class="header-input text-sm font-semibold" oninput="saveState()">
                        <input type="text" id="education-region" placeholder="ุฃุฏุฎู ุงูููุทูุฉ ุงูุชุนููููุฉ" class="header-input text-sm font-semibold" oninput="saveState()">
                        <input type="text" id="school-name" placeholder="ุฃุฏุฎู ุงุณู ุงููุฏุฑุณุฉ" class="header-input text-sm font-semibold" oninput="saveState()">
                    </div>
                </div>
                <div class="text-center">
                    <h1 id="main-title" class="text-xl sm:text-3xl font-bold">ุฎุทุฉ ุงููุดุงุท ุงูุทูุงุจู</h1>
                    <p id="subtitle" class="text-md sm:text-lg opacity-90">ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู ููุนุงู ุงูุฏุฑุงุณู 1447ูู</p>
                </div>
            </div>
        </header>

        <section class="py-8 bg-gray-50 no-print">
            <div class="container mx-auto px-6">
                <details class="rounded-lg shadow-md mb-8" style="background-color: #5a7b84;">
                    <summary class="text-2xl font-bold text-white text-center p-4 focus:outline-none flex justify-center items-center gap-3">
                        ูุฑุชูุฒุงุช ุงูุฃูุดุทุฉ ุงูุทูุงุจูุฉ
                        <svg class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="p-6 border-t border-gray-200 bg-white">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Pillar cards here -->
                            <div class="pillar-card" style="border-right-color: #981E47;">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 text-white rounded-full flex items-center justify-center ml-3 font-bold" style="background-color: #981E47;">1</div>
                                    <h3 class="font-semibold" style="color: #981E47;">ุชุญููู ูุณุชูุฏูุงุช ุงููุฏุฑุณุฉ ุงูุฌุงุฐุจุฉ</h3>
                                </div>
                                <div class="arrow" style="color: #981E47;">โ</div>
                            </div>
                            <div class="pillar-card" style="border-right-color: #FF7145;">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 text-white rounded-full flex items-center justify-center ml-3 font-bold" style="background-color: #FF7145;">2</div>
                                    <h3 class="font-semibold" style="color: #FF7145;">ุงูุฑุจุท ุจููุงุชุฌ ุงูุชุนูู</h3>
                                </div>
                                <div class="arrow" style="color: #FF7145;">โ</div>
                            </div>
                            <div class="pillar-card" style="border-right-color: #2FB7BD;">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 text-white rounded-full flex items-center justify-center ml-3 font-bold" style="background-color: #2FB7BD;">3</div>
                                    <h3 class="font-semibold" style="color: #2FB7BD;">ุชูููู ุงูุฃูุดุทุฉ ุงูุทูุงุจูุฉ</h3>
                                </div>
                                <div class="arrow" style="color: #2FB7BD;">โ</div>
                            </div>
                            <div class="pillar-card" style="border-right-color: #24344D;">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 text-white rounded-full flex items-center justify-center ml-3 font-bold" style="background-color: #24344D;">4</div>
                                    <h3 class="font-semibold" style="color: #24344D;">ุงุณุชุซูุงุฑ ุงููุชุฑุงุช ุงููุงุตููุฉ</h3>
                                </div>
                                <div class="arrow" style="color: #24344D;">โ</div>
                            </div>
                            <div class="pillar-card" style="border-right-color: #018083;">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 text-white rounded-full flex items-center justify-center ml-3 font-bold" style="background-color: #018083;">5</div>
                                    <h3 class="font-semibold" style="color: #018083;">ุชููุน ุฃูุนูุฉ ุงููุญุชูู ุงูุชุนูููู</h3>
                                </div>
                                <div class="arrow" style="color: #018083;">โ</div>
                            </div>
                            <div class="pillar-card" style="border-right-color: #583C71;">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 text-white rounded-full flex items-center justify-center ml-3 font-bold" style="background-color: #583C71;">6</div>
                                    <h3 class="font-semibold" style="color: #583C71;">ุฅุดุฑุงู ุงูุฌูุงุช ุฐุงุช ุงูุนูุงูุฉ</h3>
                                </div>
                                <div class="arrow" style="color: #583C71;">โ</div>
                            </div>
                        </div>
                    </div>
                </details>

                <div class="mb-8 text-center p-6 bg-white rounded-lg shadow-md">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">ุงุฎุชุฑ ุงูููุทูุฉ:</h3>
                            <div class="flex justify-center gap-3">
                                <button onclick="selectRegion('other')" id="btn-other-region" class="px-4 py-2 rounded-full font-medium transition-all duration-300 bg-blue-600 text-white shadow-lg">ุจุงูู ุงูููุงุทู</button>
                                <button onclick="selectRegion('western')" id="btn-western-region" class="px-4 py-2 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700">ุงูููุทูุฉ ุงูุบุฑุจูุฉ</button>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">ุงุฎุชุฑ ุงููุฑุงุญู ุงูุชุนููููุฉ:</h3>
                            <div class="flex flex-wrap justify-center gap-3">
                                <button onclick="toggleStageFilter('all')" id="btn-all" class="flex items-center gap-2 px-4 py-2 rounded-full font-medium transition-all duration-300 bg-blue-600 text-white shadow-lg">๐ซ ุงููู</button>
                                <button onclick="toggleStageFilter('primary')" id="btn-primary" class="flex items-center gap-2 px-4 py-2 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700">๐ฑ ุงูุฃูููุฉ</button>
                                <button onclick="toggleStageFilter('upper-primary')" id="btn-upper-primary" class="flex items-center gap-2 px-4 py-2 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700">๐ฟ ุงูุนููุง</button>
                                <button onclick="toggleStageFilter('middle')" id="btn-middle" class="flex items-center gap-2 px-4 py-2 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700">๐ณ ุงููุชูุณุทุฉ</button>
                                <button onclick="toggleStageFilter('high')" id="btn-high" class="flex items-center gap-2 px-4 py-2 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700">๐ ุงูุซุงูููุฉ</button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-wrap gap-4 justify-center">
                        <button onclick="clearAllSelections()" class="text-sm text-gray-500 hover:text-gray-700 underline">ุชุตููุฑ ุงูุงุฎุชูุงุฑุงุช</button>
                        <button onclick="clearAllFilters()" class="text-sm text-gray-500 hover:text-gray-700 underline">ุฅูุบุงุก ุฌููุน ุงูุชุตููุงุช</button>
                        <button onclick="printSchedule()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">๐จ๏ธ ุทุจุงุนุฉ ุงูุฌุฏูู</button>
                        <button onclick="resetPlan()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">๐ ุฅุนุงุฏุฉ ุจูุงุก ุงูุฎุทุฉ</button>
                        <!-- Backup and Restore Buttons -->
                        <button onclick="downloadBackup()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">๐พ ุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button>
                        <button onclick="document.getElementById('restore-input').click()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors text-sm">๐ ุงุณุชุนุงุฏุฉ ูุณุฎุฉ</button>
                        <input type="file" id="restore-input" class="hidden" onchange="restoreBackup(event)" accept=".json">
                    </div>
                </div>
            </div>
        </section>

        <main class="container mx-auto px-6 py-8">
            </main>

        <div class="container mx-auto px-6 py-4 no-print">
            <div class="flex justify-between items-center gap-8">
                <input type="text" id="activity-leader-name" placeholder="ุฃุฏุฎู ุงุณู ุฑุงุฆุฏ/ุฉ ุงููุดุงุท" class="w-1/2 p-2 text-center bg-transparent border-b-2 border-gray-300 focus:border-teal-500 outline-none" oninput="saveState()">
                <input type="text" id="school-director-name" placeholder="ุฃุฏุฎู ุงุณู ูุฏูุฑ/ุฉ ุงููุฏุฑุณุฉ" class="w-1/2 p-2 text-center bg-transparent border-b-2 border-gray-300 focus:border-teal-500 outline-none" oninput="saveState()">
            </div>
        </div>

        <footer class="bg-gray-800 text-white py-4 text-center no-print">
            <div class="container mx-auto flex justify-center items-center">
                <a href="https://t.me/+SJnY9vPy7yo5YmI1" target="_blank" class="ml-4">
                    <img src="https://e.top4top.io/p_3463x5tj40.png" alt="ุดุนุงุฑ ุฑุณู" class="h-20 w-auto">
                </a>
                <span>ุฌููุน ุงูุญููู ูุญููุธุฉ ูููุงุฉ ุฑุณู ููุชุตููู ูุงูุฎุฏูุงุช ุงูุชุนููููุฉ 2025</span>
            </div>
        </footer>
    </div>
    
    <!-- Schedule Modal -->
    <div id="scheduleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50 no-print">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-4">
            <h3 class="text-xl font-bold mb-4" id="modal-program-name"></h3>
            <div class="max-h-40 overflow-y-auto border p-2 rounded-md mb-4">
                <div id="modal-schedules-list" class="space-y-2">
                    <!-- Scheduled entries will appear here -->
                </div>
            </div>
            <hr class="my-4">
            <h4 class="text-lg font-semibold mb-2">ุฅุถุงูุฉ ูุชุฑุฉ ุชูููุฐ ุฌุฏูุฏุฉ</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <select id="modal-week-select" class="p-2 border rounded" onchange="populateDaySelectors()">
                    <option value="">ุงุฎุชุฑ ุงูุฃุณุจูุน</option>
                </select>
                <select id="modal-start-day-select" class="p-2 border rounded">
                    <option value="">ุงุฎุชุฑ ููู ุงูุจุฏุงูุฉ</option>
                </select>
                <select id="modal-end-day-select" class="p-2 border rounded">
                    <option value="">ุงุฎุชุฑ ููู ุงูููุงูุฉ</option>
                </select>
            </div>
            <button onclick="addScheduleEntry()" class="mt-4 w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">ุฅุถุงูุฉ ุงููุชุฑุฉ</button>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeScheduleModal(true)" class="bg-green-500 text-white px-4 py-2 rounded">ุญูุธ ูุฅุบูุงู</button>
                <button onclick="closeScheduleModal(false)" class="bg-gray-300 px-4 py-2 rounded">ุฅูุบุงุก</button>
            </div>
        </div>
    </div>


    <script>
        let selectedStages = ['all'];
        let currentRegion = 'other';
        let programSelections = {};
        let modalState = {
            programName: null,
            sectionId: null,
            tempSchedules: []
        };

        const weeksDataDefault = {
            'week1': { name: 'ุงูุฃุณุจูุน ุงูุฃูู', startDate: '1 / 3', endDate: '5 / 3', days: { 'ุงูุฃุญุฏ': '1 / 3', 'ุงูุงุซููู': '2 / 3', 'ุงูุซูุงุซุงุก': '3 / 3', 'ุงูุฃุฑุจุนุงุก': '4 / 3', 'ุงูุฎููุณ': '5 / 3' } },
            'week2': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', startDate: '8 / 3', endDate: '12 / 3', days: { 'ุงูุฃุญุฏ': '8 / 3', 'ุงูุงุซููู': '9 / 3', 'ุงูุซูุงุซุงุก': '10 / 3', 'ุงูุฃุฑุจุนุงุก': '11 / 3', 'ุงูุฎููุณ': '12 / 3' } },
            'week3': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ', startDate: '15 / 3', endDate: '19 / 3', days: { 'ุงูุฃุญุฏ': '15 / 3', 'ุงูุงุซููู': '16 / 3', 'ุงูุซูุงุซุงุก': '17 / 3', 'ุงูุฃุฑุจุนุงุก': '18 / 3', 'ุงูุฎููุณ': '19 / 3' } },
            'week4': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน', startDate: '22 / 3', endDate: '26 / 3', days: { 'ุงูุฃุญุฏ': '22 / 3', 'ุงูุงุซููู': '23 / 3', 'ุงูุซูุงุซุงุก': '24 / 3', 'ุงูุฃุฑุจุนุงุก': '25 / 3', 'ุงูุฎููุณ': '26 / 3' } },
            'week5': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ', startDate: '29 / 3', endDate: '3 / 4', days: { 'ุงูุฃุญุฏ': '29 / 3', 'ุงูุงุซููู': '30 / 3', 'ุงูุซูุงุซุงุก': '1 / 4', 'ุงูุฃุฑุจุนุงุก': '2 / 4', 'ุงูุฎููุณ': '3 / 4' }, specialDays: { '1 / 4': { name: 'ุฅุฌุงุฒุฉ ุงูููู ุงููุทูู', color: 'green' } } },
            'week6': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ', startDate: '6 / 4', endDate: '10 / 4', days: { 'ุงูุฃุญุฏ': '6 / 4', 'ุงูุงุซููู': '7 / 4', 'ุงูุซูุงุซุงุก': '8 / 4', 'ุงูุฃุฑุจุนุงุก': '9 / 4', 'ุงูุฎููุณ': '10 / 4' } },
            'week7': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน', startDate: '13 / 4', endDate: '17 / 4', days: { 'ุงูุฃุญุฏ': '13 / 4', 'ุงูุงุซููู': '14 / 4', 'ุงูุซูุงุซุงุก': '15 / 4', 'ุงูุฃุฑุจุนุงุก': '16 / 4', 'ุงูุฎููุณ': '17 / 4' } },
            'week8': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', startDate: '20 / 4', endDate: '24 / 4', days: { 'ุงูุฃุญุฏ': '20 / 4', 'ุงูุงุซููู': '21 / 4', 'ุงูุซูุงุซุงุก': '22 / 4', 'ุงูุฃุฑุจุนุงุก': '23 / 4', 'ุงูุฎููุณ': '24 / 4' }, specialDays: { '20 / 4': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', color: 'red' } } },
            'week9': { name: 'ุงูุฃุณุจูุน ุงูุชุงุณุน', startDate: '27 / 4', endDate: '1 / 5', days: { 'ุงูุฃุญุฏ': '27 / 4', 'ุงูุงุซููู': '28 / 4', 'ุงูุซูุงุซุงุก': '29 / 4', 'ุงูุฃุฑุจุนุงุก': '30 / 4', 'ุงูุฎููุณ': '1 / 5' } },
            'week10': { name: 'ุงูุฃุณุจูุน ุงูุนุงุดุฑ', startDate: '4 / 5', endDate: '8 / 5', days: { 'ุงูุฃุญุฏ': '4 / 5', 'ุงูุงุซููู': '5 / 5', 'ุงูุซูุงุซุงุก': '6 / 5', 'ุงูุฃุฑุจุนุงุก': '7 / 5', 'ุงูุฎููุณ': '8 / 5' } },
            'week11': { name: 'ุงูุฃุณุจูุน ุงูุญุงุฏู ุนุดุฑ', startDate: '11 / 5', endDate: '15 / 5', days: { 'ุงูุฃุญุฏ': '11 / 5', 'ุงูุงุซููู': '12 / 5', 'ุงูุซูุงุซุงุก': '13 / 5', 'ุงูุฃุฑุจุนุงุก': '14 / 5', 'ุงูุฎููุณ': '15 / 5' } },
            'week12': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ', startDate: '18 / 5', endDate: '22 / 5', days: { 'ุงูุฃุญุฏ': '18 / 5', 'ุงูุงุซููู': '19 / 5', 'ุงูุซูุงุซุงุก': '20 / 5', 'ุงูุฃุฑุจุนุงุก': '21 / 5', 'ุงูุฎููุณ': '22 / 5' } },
            'week13': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ ุนุดุฑ', startDate: '25 / 5', endDate: '29 / 5', days: { 'ุงูุฃุญุฏ': '25 / 5', 'ุงูุงุซููู': '26 / 5', 'ุงูุซูุงุซุงุก': '27 / 5', 'ุงูุฃุฑุจุนุงุก': '28 / 5', 'ุงูุฎููุณ': '29 / 5' } },
            'week14': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน ุนุดุฑ', startDate: '9 / 6', endDate: '13 / 6', days: { 'ุงูุฃุญุฏ': '9 / 6', 'ุงูุงุซููู': '10 / 6', 'ุงูุซูุงุซุงุก': '11 / 6', 'ุงูุฃุฑุจุนุงุก': '12 / 6', 'ุงูุฎููุณ': '13 / 6' } },
            'week15': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ ุนุดุฑ', startDate: '16 / 6', endDate: '20 / 6', days: { 'ุงูุฃุญุฏ': '16 / 6', 'ุงูุงุซููู': '17 / 6', 'ุงูุซูุงุซุงุก': '18 / 6', 'ุงูุฃุฑุจุนุงุก': '19 / 6', 'ุงูุฎููุณ': '20 / 6' }, specialDays: { '20 / 6': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', color: 'red' } } },
            'week16': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ ุนุดุฑ', startDate: '23 / 6', endDate: '27 / 6', days: { 'ุงูุฃุญุฏ': '23 / 6', 'ุงูุงุซููู': '24 / 6', 'ุงูุซูุงุซุงุก': '25 / 6', 'ุงูุฃุฑุจุนุงุก': '26 / 6', 'ุงูุฎููุณ': '27 / 6' }, specialDays: { '23 / 6': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', color: 'red' } } },
            'week17': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน ุนุดุฑ', startDate: '1 / 7', endDate: '5 / 7', days: { 'ุงูุฃุญุฏ': '1 / 7', 'ุงูุงุซููู': '2 / 7', 'ุงูุซูุงุซุงุก': '3 / 7', 'ุงูุฃุฑุจุนุงุก': '4 / 7', 'ุงูุฎููุณ': '5 / 7' } },
            'week18': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ', startDate: '8 / 7', endDate: '12 / 7', days: { 'ุงูุฃุญุฏ': '8 / 7', 'ุงูุงุซููู': '9 / 7', 'ุงูุซูุงุซุงุก': '10 / 7', 'ุงูุฃุฑุจุนุงุก': '11 / 7', 'ุงูุฎููุณ': '12 / 7' } },
        };

        const weeksDataWestern = {
            'week1': { name: 'ุงูุฃุณุจูุน ุงูุฃูู', startDate: '8 / 3', endDate: '12 / 3', days: { 'ุงูุฃุญุฏ': '8 / 3', 'ุงูุงุซููู': '9 / 3', 'ุงูุซูุงุซุงุก': '10 / 3', 'ุงูุฃุฑุจุนุงุก': '11 / 3', 'ุงูุฎููุณ': '12 / 3' } },
            'week2': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', startDate: '15 / 3', endDate: '19 / 3', days: { 'ุงูุฃุญุฏ': '15 / 3', 'ุงูุงุซููู': '16 / 3', 'ุงูุซูุงุซุงุก': '17 / 3', 'ุงูุฃุฑุจุนุงุก': '18 / 3', 'ุงูุฎููุณ': '19 / 3' } },
            'week3': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ', startDate: '22 / 3', endDate: '26 / 3', days: { 'ุงูุฃุญุฏ': '22 / 3', 'ุงูุงุซููู': '23 / 3', 'ุงูุซูุงุซุงุก': '24 / 3', 'ุงูุฃุฑุจุนุงุก': '25 / 3', 'ุงูุฎููุณ': '26 / 3' } },
            'week4': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน', startDate: '29 / 3', endDate: '3 / 4', days: { 'ุงูุฃุญุฏ': '29 / 3', 'ุงูุงุซููู': '30 / 3', 'ุงูุซูุงุซุงุก': '1 / 4', 'ุงูุฃุฑุจุนุงุก': '2 / 4', 'ุงูุฎููุณ': '3 / 4' }, specialDays: { '1 / 4': { name: 'ุฅุฌุงุฒุฉ ุงูููู ุงููุทูู', color: 'green' } } },
            'week5': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ', startDate: '6 / 4', endDate: '10 / 4', days: { 'ุงูุฃุญุฏ': '6 / 4', 'ุงูุงุซููู': '7 / 4', 'ุงูุซูุงุซุงุก': '8 / 4', 'ุงูุฃุฑุจุนุงุก': '9 / 4', 'ุงูุฎููุณ': '10 / 4' } },
            'week6': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ', startDate: '13 / 4', endDate: '17 / 4', days: { 'ุงูุฃุญุฏ': '13 / 4', 'ุงูุงุซููู': '14 / 4', 'ุงูุซูุงุซุงุก': '15 / 4', 'ุงูุฃุฑุจุนุงุก': '16 / 4', 'ุงูุฎููุณ': '17 / 4' } },
            'week7': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน', startDate: '20 / 4', endDate: '24 / 4', days: { 'ุงูุฃุญุฏ': '20 / 4', 'ุงูุงุซููู': '21 / 4', 'ุงูุซูุงุซุงุก': '22 / 4', 'ุงูุฃุฑุจุนุงุก': '23 / 4', 'ุงูุฎููุณ': '24 / 4' }, specialDays: { '20 / 4': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', color: 'red' } } },
            'week8': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', startDate: '27 / 4', endDate: '1 / 5', days: { 'ุงูุฃุญุฏ': '27 / 4', 'ุงูุงุซููู': '28 / 4', 'ุงูุซูุงุซุงุก': '29 / 4', 'ุงูุฃุฑุจุนุงุก': '30 / 4', 'ุงูุฎููุณ': '1 / 5' } },
            'week9': { name: 'ุงูุฃุณุจูุน ุงูุชุงุณุน', startDate: '4 / 5', endDate: '8 / 5', days: { 'ุงูุฃุญุฏ': '4 / 5', 'ุงูุงุซููู': '5 / 5', 'ุงูุซูุงุซุงุก': '6 / 5', 'ุงูุฃุฑุจุนุงุก': '7 / 5', 'ุงูุฎููุณ': '8 / 5' } },
            'week10': { name: 'ุงูุฃุณุจูุน ุงูุนุงุดุฑ', startDate: '11 / 5', endDate: '15 / 5', days: { 'ุงูุฃุญุฏ': '11 / 5', 'ุงูุงุซููู': '12 / 5', 'ุงูุซูุงุซุงุก': '13 / 5', 'ุงูุฃุฑุจุนุงุก': '14 / 5', 'ุงูุฎููุณ': '15 / 5' } },
            'week11': { name: 'ุงูุฃุณุจูุน ุงูุญุงุฏู ุนุดุฑ', startDate: '18 / 5', endDate: '22 / 5', days: { 'ุงูุฃุญุฏ': '18 / 5', 'ุงูุงุซููู': '19 / 5', 'ุงูุซูุงุซุงุก': '20 / 5', 'ุงูุฃุฑุจุนุงุก': '21 / 5', 'ุงูุฎููุณ': '22 / 5' } },
            'week12': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ', startDate: '25 / 5', endDate: '29 / 5', days: { 'ุงูุฃุญุฏ': '25 / 5', 'ุงูุงุซููู': '26 / 5', 'ุงูุซูุงุซุงุก': '27 / 5', 'ุงูุฃุฑุจุนุงุก': '28 / 5', 'ุงูุฎููุณ': '29 / 5' } },
            'week13': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ ุนุดุฑ', startDate: '9 / 6', endDate: '13 / 6', days: { 'ุงูุฃุญุฏ': '9 / 6', 'ุงูุงุซููู': '10 / 6', 'ุงูุซูุงุซุงุก': '11 / 6', 'ุงูุฃุฑุจุนุงุก': '12 / 6', 'ุงูุฎููุณ': '13 / 6' } },
            'week14': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน ุนุดุฑ', startDate: '16 / 6', endDate: '20 / 6', days: { 'ุงูุฃุญุฏ': '16 / 6', 'ุงูุงุซููู': '17 / 6', 'ุงูุซูุงุซุงุก': '18 / 6', 'ุงูุฃุฑุจุนุงุก': '19 / 6', 'ุงูุฎููุณ': '20 / 6' }, specialDays: { '20 / 6': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', color: 'red' } } },
            'week15': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ ุนุดุฑ', startDate: '23 / 6', endDate: '27 / 6', days: { 'ุงูุฃุญุฏ': '23 / 6', 'ุงูุงุซููู': '24 / 6', 'ุงูุซูุงุซุงุก': '25 / 6', 'ุงูุฃุฑุจุนุงุก': '26 / 6', 'ุงูุฎููุณ': '27 / 6' }, specialDays: { '23 / 6': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', color: 'red' } } },
            'week16': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ ุนุดุฑ', startDate: '1 / 7', endDate: '5 / 7', days: { 'ุงูุฃุญุฏ': '1 / 7', 'ุงูุงุซููู': '2 / 7', 'ุงูุซูุงุซุงุก': '3 / 7', 'ุงูุฃุฑุจุนุงุก': '4 / 7', 'ุงูุฎููุณ': '5 / 7' } },
            'week17': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน ุนุดุฑ', startDate: '8 / 7', endDate: '12 / 7', days: { 'ุงูุฃุญุฏ': '8 / 7', 'ุงูุงุซููู': '9 / 7', 'ุงูุซูุงุซุงุก': '10 / 7', 'ุงูุฃุฑุจุนุงุก': '11 / 7', 'ุงูุฎููุณ': '12 / 7' } },
        };
        
        let weeksData = weeksDataDefault;

        const activitiesData = [
            { id: 'citizenship', title: 'ุงูููุงุทูุฉ ูุงูุญูุงุฉ', color: '#981E47', icon: 'https://k.top4top.io/p_3472ccl2l0.gif', programs: [
                { name: 'ุงูุชุทูุน ุงูุทูุงุจู', primary: 4, upper: 6, middle: 5, high: 5 },
                { name: 'ููุงุฑุงุช ุทููุญุฉ', primary: 6, upper: 4, middle: 3, high: 2 },
                { name: 'ููููุง ุญูุงุฉ', primary: 0, upper: 12, middle: 12, high: 12 },
            ]},
            { id: 'culture', title: 'ุงูุซูุงูุฉ ูุงููููู', color: '#FF7145', icon: 'https://a.top4top.io/p_3472miame2.gif', programs: [
                 { name: 'ุงููู ุงูุณุงุจุน (ุงูุณูููุง)', primary: 8, upper: 8, middle: 8, high: 8 },
                 { name: 'ุญุฏุงุฆู ุงููู', primary: 6, upper: 6, middle: 6, high: 6 },
                 { name: 'ุงูุฃุฒูุงุก ุงูุณุนูุฏูุฉ', primary: 4, upper: 4, middle: 6, high: 6 },
                 { name: 'ุงูุซูุงูุฉ ุงูุฅุนูุงููุฉ', primary: 4, upper: 4, middle: 6, high: 8 },
                 { name: 'ุชุตุงููู ุชุฑุงุซูุฉ ูุนุงุตุฑุฉ', primary: 5, upper: 5, middle: 5, high: 5 },
                 { name: 'ุงููููู ุงููุณุฑุญูุฉ', primary: 8, upper: 8, middle: 8, high: 8 },
                 { name: 'ุงูุจุฑูุงูุฌ ุงูููุณููู (ุงูุฃูุงุดูุฏ ุงููุทููุฉ)', primary: 8, upper: 8, middle: 8, high: 8 },
                 { name: 'ุญูุงูุงุช ูุฑุฆูุฉ', primary: 6, upper: 6, middle: 11, high: 11 },
            ]},
            { id: 'sports', title: 'ุงูุฑูุงุถุฉ ูุงูุตุญุฉ', color: '#2FB7BD', icon: 'https://c.top4top.io/p_3472urwbn4.gif', programs: [
                { name: 'ููุงุฑุงุช ุงูุฑูุงุถุงุช ุงูุฌูุงุนูุฉ', primary: 6, upper: 8, middle: 8, high: 8 },
                { name: 'ููุงุฑุงุช ุงูุฑูุงุถุงุช ุงููุฑุฏูุฉ', primary: 8, upper: 8, middle: 8, high: 6 },
                { name: 'ููุงุฑุงุช ุฑูุงุถุงุช ุงูุฏูุงุน ุนู ุงูููุณ', primary: 8, upper: 8, middle: 8, high: 6 },
                { name: 'ููุงุฑุงุช ุงูุฑูุงุถุงุช ุงูุฅููุชุฑูููุฉ ูุงูุชุฑููู', primary: 8, upper: 8, middle: 6, high: 8 },
                { name: 'ููุงุฑุงุช ุงูุฑูุงุถุงุช ุงูุฐูููุฉ', primary: 6, upper: 8, middle: 8, high: 8 },
                { name: 'ููุงุฑุงุช ุงูุฃูููุจูุงุฏ ุงูุฑูุงุถู', primary: 6, upper: 8, middle: 8, high: 8 },
            ]},
            { id: 'science', title: 'ุงูุนููู ูุงูุชูููุฉ', color: '#24344D', icon: 'https://l.top4top.io/p_3472daolv1.gif', programs: [
                { name: 'ุจุฑูุงูุฌ ุชุทุจููุงุช STEM', primary: 3, upper: 5, middle: 7, high: 7 },
                { name: 'ุจุฑูุงูุฌ ุงูุชุตุงููู ุงูุนูููุฉ ุงูุชูููุฉ', primary: 2, upper: 5, middle: 7, high: 7 },
                { name: 'ุจุฑูุงูุฌ ุฑูุงุฏ ูุถุงุก ุงููุณุชูุจู', primary: 3, upper: 5, middle: 7, high: 9 },
                { name: 'ุจุฑูุงูุฌ ูุฏู ุงููุณุชูุจู', primary: 3, upper: 4, middle: 7, high: 9 },
                { name: 'ุจุฑูุงูุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู', primary: 10, upper: 10, middle: 10, high: 10 },
                { name: 'ุจุฑูุงูุฌ ุชุญุฏู ุฅูุชุฑูุช ุงูุฃุดูุงุก', primary: 3, upper: 4, middle: 7, high: 9 },
            ]},
            { id: 'scouting', title: 'ุงููุดุงุท ุงููุดูู', color: '#018083', icon: 'https://b.top4top.io/p_3472h0ngk3.gif', programs: [
                { name: 'ุฎููุชู ุงูุฌูููุฉ', primary: 3, upper: 0, middle: 0, high: 0 },
                { name: 'ุฎุดุจุฉ ูุญุจู', primary: 0, upper: 12, middle: 0, high: 0 },
                { name: 'ุงูููุงุญุฉ ุนูู ุงููุงุจุณ', primary: 0, upper: 0, middle: 3, high: 0 },
                { name: 'ุฃุบุงูุฑ ูุฃูุชุดู', primary: 0, upper: 0, middle: 0, high: 5 },
                { name: 'ุจุฑุงุนู ุงูุจูุฆุฉ ูุงููุฌุชูุน', primary: 2, upper: 0, middle: 0, high: 0 },
                { name: 'ุฃุดุงุฑู ูุฌุชูุนู ูุฃุฒุฑุน ุดุฌุฑุฉ', primary: 0, upper: 3, middle: 0, high: 0 },
                { name: 'ูุฌุชูุนู ูุจูุฆุชู ูุณุคูููุชู', primary: 0, upper: 0, middle: 6, high: 0 },
                { name: 'ุณููุฑ ุงูุจูุฆุฉ ูุงููุฌุชูุน', primary: 0, upper: 0, middle: 0, high: 5 },
                { name: 'ุจุตูุชู ุงููุดููุฉ', primary: 3, upper: 0, middle: 0, high: 0 },
                { name: 'ูุทูู ูู ููุจู', primary: 0, upper: 3, middle: 0, high: 0 },
                { name: 'ุตูุงุน ุงูุชุบููุฑ', primary: 0, upper: 0, middle: 3, high: 0 },
                { name: 'ุณูุงุนุฏ ุงููุดููุฉ', primary: 0, upper: 0, middle: 0, high: 6 },
                { name: 'ุจุฑุงุนู ุงูููุฑ', primary: 2, upper: 0, middle: 0, high: 0 },
                { name: 'ูููุฒ ุงูุตุบุงุฑ', primary: 0, upper: 2, middle: 0, high: 0 },
                { name: 'ูู ูุฏู ุงููุฑุขู ูุงูุณูุฉ', primary: 0, upper: 0, middle: 3, high: 0 },
                { name: 'ุฏุฑุจ ุงูุฅุญุณุงู', primary: 0, upper: 0, middle: 0, high: 3 },
                { name: 'ุจูุตูุฉ ุงูุงูุชุดุงู', primary: 3, upper: 0, middle: 0, high: 0 },
                { name: 'ุฎููุฉ ุงูุชุฌุงุฑุจ ุงููุณููุฉ', primary: 0, upper: 6, middle: 0, high: 0 },
                { name: 'ูุฎููู ุงูุชููู', primary: 0, upper: 0, middle: 10, high: 0 },
                { name: 'ูุงุญุฉ ุงูุฅุจุฏุงุน ุงููุดูู', primary: 0, upper: 0, middle: 0, high: 4 },
                { name: 'ุนุงุฏุงุชู ุงูุตุญูุฉ ุงููุดููุฉ', primary: 3, upper: 0, middle: 0, high: 0 },
                { name: 'ุทุจูู ุงููุดูู', primary: 0, upper: 3, middle: 0, high: 0 },
                { name: 'ุฎุทูุงุชู ุงููุดููุฉ ุงูุตุญูุฉ', primary: 0, upper: 0, middle: 3, high: 0 },
                { name: 'ููุฑุฌุงู ุงูุฃููุงู ุงููุดููุฉ ุงูุตุญูุฉ', primary: 0, upper: 0, middle: 0, high: 5 },
                { name: 'ููุงุฑุงุชู ููุดููุชู', primary: 2, upper: 0, middle: 0, high: 0 },
                { name: 'ุตุงูุฑุฉ ูุงุตุทูุงู', primary: 0, upper: 2, middle: 0, high: 0 },
                { name: 'ููุงุฑุงุชู ุงููุดููุฉ ูู ุงูุงุณุชุนุฏุงุฏ ุฅูู ุงูุฅูุฌุงุฒ', primary: 0, upper: 0, middle: 4, high: 0 },
                { name: 'ุฃููู ุงููุดูู ุงููุงุณุน', primary: 0, upper: 0, middle: 0, high: 6 },
            ]},
            { id: 'events', title: 'ุงูุฃูุงู ูุงูููุงุณุจุงุช', color: '#583C71', icon: 'https://e.top4top.io/p_34729xucx5.gif', programs: [
                { name: 'ุงูููู ุงููุทูู', date: 'ูก / ูค / ูกูคูคูง ูู', primary: 4, upper: 4, middle: 4, high: 4 },
                { name: 'ููู ุงูุชุณุงูุญ ุงูุนุงููู', date: 'ูขูฅ / ูฅ / ูกูคูคูง ูู', primary: 2, upper: 2, middle: 1, high: 1 },
                { name: 'ุงูููู ุงูุนุงููู ููุทูู', date: 'ูขูฉ / ูฅ / ูกูคูคูง ูู', primary: 2, upper: 2, middle: 0, high: 0 },
                { name: 'ุงูููู ุงูุนุงููู ูุฐูู ุงูุฅุนุงูุฉ', date: 'ูกูข / ูฆ / ูกูคูคูง ูู', primary: 2, upper: 2, middle: 2, high: 2 },
                { name: 'ุงูููู ุงูุนุงููู ููุบุฉ ุงูุนุฑุจูุฉ', date: 'ูขูง / ูฆ / ูกูคูคูง ูู', primary: 2, upper: 2, middle: 1, high: 1 },
                { name: 'ุงูููู ุงูุนุงููู ููุชุนููู', date: 'ูง / ูจ / ูกูคูคูง ูู', primary: 2, upper: 2, middle: 2, high: 2 },
                { name: 'ููู ุงูุชุฃุณูุณ', date: 'ูฅ / ูฉ / ูกูคูคูง ูู', primary: 4, upper: 4, middle: 4, high: 4 },
                { name: 'ููู ุงูุนูู', date: 'ูขูข / ูฉ / ูกูคูคูง ูู', primary: 3, upper: 3, middle: 2, high: 2 },
                { name: 'ููู ุงูุณุนูุฏูุฉ ุงูุฎุถุฑุงุก', date: 'ูจ / ูกู / ูกูคูคูง ูู', primary: 3, upper: 3, middle: 2, high: 2 },
                { name: 'ููู ุงูุตุญุฉ ุงูุนุงููู', date: 'ูกูฉ / ูกู / ูกูคูคูง ูู', primary: 2, upper: 2, middle: 2, high: 2 },
            ]},
        ];

        // --- NEW MODAL AND DATA FUNCTIONS ---
        function openScheduleModal(buttonElement) {
            const row = buttonElement.closest('tr');
            modalState.programName = row.dataset.programName;
            modalState.sectionId = row.dataset.sectionId;
            modalState.tempSchedules = JSON.parse(JSON.stringify(programSelections[modalState.programName] || []));
            
            document.getElementById('modal-program-name').textContent = `ุชุญุฏูุฏ ูุชุฑุงุช ุงูุชูููุฐ ูู: ${modalState.programName}`;
            
            const weekSelect = document.getElementById('modal-week-select');
            weekSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุฃุณุจูุน</option>' + Object.keys(weeksData).map(weekKey => 
                `<option value="${weekKey}">${weeksData[weekKey].name}</option>`
            ).join('');
            
            populateDaySelectors();
            renderModalSchedules();
            
            document.getElementById('scheduleModal').classList.remove('hidden');
            document.getElementById('scheduleModal').classList.add('flex');
        }

        function closeScheduleModal(shouldSave) {
            if (shouldSave) {
                programSelections[modalState.programName] = modalState.tempSchedules;
                if(programSelections[modalState.programName].length === 0) {
                    delete programSelections[modalState.programName];
                }
                updateProgramRowDisplay(modalState.sectionId, modalState.programName);
                saveState();
            }
            document.getElementById('scheduleModal').classList.add('hidden');
            document.getElementById('scheduleModal').classList.remove('flex');
        }

        function populateDaySelectors() {
            const weekSelect = document.getElementById('modal-week-select');
            const startDaySelect = document.getElementById('modal-start-day-select');
            const endDaySelect = document.getElementById('modal-end-day-select');
            
            const selectedWeekKey = weekSelect.value;
            startDaySelect.innerHTML = '<option value="">ููู ุงูุจุฏุงูุฉ</option>';
            endDaySelect.innerHTML = '<option value="">ููู ุงูููุงูุฉ</option>';

            if (selectedWeekKey && weeksData[selectedWeekKey]) {
                const week = weeksData[selectedWeekKey];
                Object.entries(week.days).forEach(([dayName, dayDate]) => {
                    const optionValue = `${dayName}_${dayDate}`;
                    const optionText = `${dayName} (${dayDate})`;
                    const isSpecial = week.specialDays && week.specialDays[dayDate];
                    
                    const startOption = new Option(optionText, optionValue, false, false);
                    if(isSpecial) startOption.disabled = true;
                    startDaySelect.add(startOption);

                    const endOption = new Option(optionText, optionValue, false, false);
                    if(isSpecial) endOption.disabled = true;
                    endDaySelect.add(endOption);
                });
            }
        }
        
        function renderModalSchedules() {
            const listEl = document.getElementById('modal-schedules-list');
            if (modalState.tempSchedules.length === 0) {
                listEl.innerHTML = '<p class="text-gray-500 text-center">ูุง ุชูุฌุฏ ูุชุฑุงุช ูุญุฏุฏุฉ ุญุงููุงู.</p>';
                return;
            }
            listEl.innerHTML = modalState.tempSchedules.map((schedule, index) => {
                const weekName = weeksData[schedule.weekKey]?.name || 'ุฃุณุจูุน ุบูุฑ ูุนุฑูู';
                const startDay = schedule.startDay.split('_')[0];
                const endDay = schedule.endDay.split('_')[0];
                return `
                    <div class="flex justify-between items-center bg-gray-100 p-2 rounded">
                        <span><strong>${weekName}:</strong> ูู ${startDay} ุฅูู ${endDay}</span>
                        <button onclick="removeScheduleEntry(${index})" class="text-red-500 hover:text-red-700 font-bold">โ</button>
                    </div>
                `;
            }).join('');
        }

        function addScheduleEntry() {
            const weekKey = document.getElementById('modal-week-select').value;
            const startDay = document.getElementById('modal-start-day-select').value;
            const endDay = document.getElementById('modal-end-day-select').value;

            if (!weekKey || !startDay || !endDay) {
                alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุฃุณุจูุน ูููู ุงูุจุฏุงูุฉ ูุงูููุงูุฉ.');
                return;
            }

            // Check if week is already added
            if (modalState.tempSchedules.some(s => s.weekKey === weekKey)) {
                alert('ูุฐุง ุงูุฃุณุจูุน ุชู ุฅุถุงูุชู ุจุงููุนู. ููููู ุญุฐูู ูุฅุถุงูุชู ูู ุฌุฏูุฏ ุจูุชุฑุฉ ูุฎุชููุฉ.');
                return;
            }

            modalState.tempSchedules.push({ weekKey, startDay, endDay });
            modalState.tempSchedules.sort((a,b) => {
                const weekOrder = Object.keys(weeksData);
                return weekOrder.indexOf(a.weekKey) - weekOrder.indexOf(b.weekKey);
            });

            renderModalSchedules();
        }

        function removeScheduleEntry(index) {
            modalState.tempSchedules.splice(index, 1);
            renderModalSchedules();
        }

        function updateProgramRowDisplay(sectionId, programName) {
            const programNameId = programName.replace(/[\s\(\)]+/g, '-');
            const displayId = `display-${sectionId}-${programNameId}`;
            const displayEl = document.getElementById(displayId);
            if (!displayEl) return;

            const schedules = programSelections[programName] || [];

            if (schedules.length === 0) {
                displayEl.innerHTML = '<span class="text-gray-400">ูู ูุชู ุงูุงุฎุชูุงุฑ</span>';
            } else {
                displayEl.innerHTML = schedules.map(s => {
                    const weekName = weeksData[s.weekKey]?.name || '';
                    const startDayName = s.startDay.split('_')[0];
                    const endDayName = s.endDay.split('_')[0];
                    return `<div class="bg-green-100 text-green-800 p-1 rounded text-center">${weekName}: ${startDayName} - ${endDayName}</div>`;
                }).join('');
            }
        }
        
        function updateAllRowsDisplay() {
            document.querySelectorAll('main tr[data-program-name]').forEach(row => {
                updateProgramRowDisplay(row.dataset.sectionId, row.dataset.programName);
            });
        }
        // --- END NEW FUNCTIONS ---

        function generateSections() {
            const mainContainer = document.querySelector('main');
            mainContainer.innerHTML = ''; 

            activitiesData.forEach(section => {
                const programRows = section.programs.map(prog => {
                    const progId = prog.name.replace(/[\s\(\)]+/g, '-');
                    return `
                    <tr data-program-name="${prog.name}" data-section-id="${section.id}">
                        <td class="border border-gray-300 px-4 py-3 font-semibold" style="background-color: ${section.color}; color: white;">${section.title}</td>
                        <td class="border border-gray-300 px-2 py-3 week-column" style="display: none;">
                            <div id="display-${section.id}-${progId}" class="text-xs space-y-1 selected-weeks-display">
                                <!-- Selections will be rendered here -->
                            </div>
                            <button onclick="openScheduleModal(this)" class="schedule-btn mt-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200 w-full">ุชุญุฏูุฏ ุงููุชุฑุงุช</button>
                        </td>
                        <td class="border border-gray-300 px-4 py-3">
                            ${prog.name}
                            ${prog.date ? `<div class="text-xs text-gray-500 mt-1">${prog.date}</div>` : ''}
                        </td>
                        <td class="border border-gray-300 px-4 py-3 text-center ${prog.primary > 0 ? 'bg-green-100' : 'bg-red-100 text-red-600'} font-semibold stage-primary">${prog.primary}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center ${prog.upper > 0 ? 'bg-green-100' : 'bg-red-100 text-red-600'} font-semibold stage-upper-primary">${prog.upper}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center ${prog.middle > 0 ? 'bg-green-100' : 'bg-red-100 text-red-600'} font-semibold stage-middle">${prog.middle}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center ${prog.high > 0 ? 'bg-green-100' : 'bg-red-100 text-red-600'} font-semibold stage-high">${prog.high}</td>
                    </tr>
                `}).join('');

                const sectionHTML = `
                    <section id="${section.id}" class="mb-8">
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                            <button onclick="toggleDropdown('${section.id}-dropdown')" class="w-full px-6 py-4 text-right font-bold text-lg flex justify-between items-center transition-colors hover:bg-gray-50" style="background-color: ${section.color}; color: white;">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 rounded-full bg-white flex items-center justify-center ml-4 overflow-hidden">
                                        <img src="${section.icon}" alt="${section.title}" class="w-8 h-8 object-contain">
                                    </div>
                                    <span>${section.title}</span>
                                </div>
                                <svg id="${section.id}-arrow" class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="${section.id}-dropdown" class="dropdown-content">
                                <div class="p-6">
                                    <div class="overflow-x-auto">
                                        <table class="w-full border-collapse border border-gray-300">
                                            <thead>
                                                <tr class="bg-gray-100">
                                                    <th class="border border-gray-300 px-3 py-3 text-right font-semibold" style="width: 12%;">ุงููุฌุงู</th>
                                                    <th class="border border-gray-300 px-3 py-3 text-right font-semibold week-column" style="width: 15%; display: none;">ูุชุฑุฉ ุงูุชูููุฐ</th>
                                                    <th class="border border-gray-300 px-3 py-3 text-right font-semibold" style="width: 28%;">ุงูุจุฑูุงูุฌ</th>
                                                    <th class="border border-gray-300 px-2 py-3 text-center font-semibold stage-primary" style="width: 11.25%;">ุงูุตููู ุงูุฃูููุฉ</th>
                                                    <th class="border border-gray-300 px-2 py-3 text-center font-semibold stage-upper-primary" style="width: 11.25%;">ุงูุตููู ุงูุนููุง</th>
                                                    <th class="border border-gray-300 px-2 py-3 text-center font-semibold stage-middle" style="width: 11.25%;">ุงููุชูุณุทุฉ</th>
                                                    <th class="border border-gray-300 px-2 py-3 text-center font-semibold stage-high" style="width: 11.25%;">ุงูุซุงูููุฉ</th>
                                                </tr>
                                            </thead>
                                            <tbody>${programRows}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                `;
                mainContainer.innerHTML += sectionHTML;
            });
             filterStages();
             updateAllRowsDisplay();
        }

        function selectRegion(region) {
            currentRegion = region;
            weeksData = region === 'western' ? weeksDataWestern : weeksDataDefault;

            const btnWestern = document.getElementById('btn-western-region');
            const btnOther = document.getElementById('btn-other-region');

            if (region === 'western') {
                btnWestern.className = 'px-4 py-2 rounded-full font-medium transition-all duration-300 bg-blue-600 text-white shadow-lg';
                btnOther.className = 'px-4 py-2 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700';
            } else {
                btnOther.className = 'px-4 py-2 rounded-full font-medium transition-all duration-300 bg-blue-600 text-white shadow-lg';
                btnWestern.className = 'px-4 py-2 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700';
            }
            generateSections();
            saveState();
        }

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const arrow = document.getElementById(dropdownId.replace('-dropdown', '-arrow'));
            
            document.querySelectorAll('.dropdown-content.active').forEach(openDropdown => {
                if (openDropdown.id !== dropdownId) {
                    openDropdown.classList.remove('active');
                    const otherArrow = document.getElementById(openDropdown.id.replace('-dropdown', '-arrow'));
                    if (otherArrow) otherArrow.classList.remove('rotate-arrow');
                }
            });

            dropdown.classList.toggle('active');
            arrow.classList.toggle('rotate-arrow');
        }

        function toggleStageFilter(stage) {
            if (stage === 'all') {
                selectedStages = ['all'];
            } else {
                if (selectedStages.includes('all')) selectedStages = [];
                if (selectedStages.includes(stage)) {
                    selectedStages = selectedStages.filter(s => s !== stage);
                } else {
                    selectedStages.push(stage);
                }
                if (selectedStages.length === 0) selectedStages = ['all'];
            }
            updateButtonStyles();
            filterStages();
            updateTitle();
            saveState();
        }

        function updateButtonStyles() {
            const buttons = { 'all': 'btn-all', 'primary': 'btn-primary', 'upper-primary': 'btn-upper-primary', 'middle': 'btn-middle', 'high': 'btn-high' };
            Object.keys(buttons).forEach(stage => {
                const btn = document.getElementById(buttons[stage]);
                if (selectedStages.includes(stage)) {
                    btn.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
        }

        function filterStages() {
            const allStageClasses = ['stage-primary', 'stage-upper-primary', 'stage-middle', 'stage-high'];
            const stageMap = { 'primary': 'stage-primary', 'upper-primary': 'stage-upper-primary', 'middle': 'stage-middle', 'high': 'stage-high' };
            const weekColumns = document.querySelectorAll('.week-column');

            if (selectedStages.includes('all')) {
                allStageClasses.forEach(sc => document.querySelectorAll('.' + sc).forEach(el => el.style.display = 'table-cell'));
                weekColumns.forEach(col => col.style.display = 'none');
            } else {
                weekColumns.forEach(col => col.style.display = 'table-cell');
                allStageClasses.forEach(sc => document.querySelectorAll('.' + sc).forEach(el => el.style.display = 'none'));
                selectedStages.forEach(stage => {
                    const stageClass = stageMap[stage];
                    if (stageClass) document.querySelectorAll('.' + stageClass).forEach(el => el.style.display = 'table-cell');
                });
            }

            const stagePropMap = { 'primary': 'primary', 'upper-primary': 'upper', 'middle': 'middle', 'high': 'high' };
            const allRows = document.querySelectorAll('main tr[data-program-name]');

            if (selectedStages.length === 1 && selectedStages[0] !== 'all') {
                const propName = stagePropMap[selectedStages[0]];
                allRows.forEach(row => {
                    const programName = row.dataset.programName;
                    const sectionId = row.dataset.sectionId;
                    const section = activitiesData.find(s => s.id === sectionId);
                    const program = section.programs.find(p => p.name === programName);
                    const scheduleButton = row.querySelector('.schedule-btn');

                    if (program && program[propName] === 0) {
                        scheduleButton.disabled = true;
                        scheduleButton.classList.add('bg-gray-200', 'cursor-not-allowed', 'text-gray-400');
                        scheduleButton.classList.remove('bg-blue-100', 'text-blue-800', 'hover:bg-blue-200');
                        delete programSelections[programName];
                        updateProgramRowDisplay(sectionId, programName);
                    } else {
                        scheduleButton.disabled = false;
                        scheduleButton.classList.remove('bg-gray-200', 'cursor-not-allowed', 'text-gray-400');
                        scheduleButton.classList.add('bg-blue-100', 'text-blue-800', 'hover:bg-blue-200');
                    }
                });
            } else {
                allRows.forEach(row => {
                     const scheduleButton = row.querySelector('.schedule-btn');
                    scheduleButton.disabled = false;
                    scheduleButton.classList.remove('bg-gray-200', 'cursor-not-allowed', 'text-gray-400');
                    scheduleButton.classList.add('bg-blue-100', 'text-blue-800', 'hover:bg-blue-200');
                });
            }
        }

        function updateTitle() {
            const titleElement = document.getElementById('main-title');
            const subtitleElement = document.getElementById('subtitle');
            const stageNames = { 'primary': 'ุงูุตููู ุงูุฃูููุฉ', 'upper-primary': 'ุงูุตููู ุงูุนููุง', 'middle': 'ุงููุชูุณุทุฉ', 'high': 'ุงูุซุงูููุฉ' };
            
            if (selectedStages.includes('all')) {
                titleElement.textContent = 'ุฎุทุฉ ุงููุดุงุท ุงูุทูุงุจู';
            } else {
                let displayStages = [...selectedStages];
                const hasPrimary = displayStages.includes('primary');
                const hasUpperPrimary = displayStages.includes('upper-primary');

                if (hasPrimary && hasUpperPrimary) {
                    displayStages = displayStages.filter(s => s !== 'primary' && s !== 'upper-primary');
                    displayStages.unshift('ุงููุฑุญูุฉ ุงูุงุจุชุฏุงุฆูุฉ'); 
                }

                const selectedNames = displayStages.map(s => stageNames[s] || s).join(' - ');
                titleElement.textContent = `ุฎุทุฉ ุงููุดุงุท ุงูุทูุงุจู - ${selectedNames}`;
            }
            subtitleElement.textContent = 'ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู ููุนุงู ุงูุฏุฑุงุณู 1447ูู';
        }
        
        function clearAllSelections() {
            if(confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ุชุตููุฑ ุฌููุน ุงุฎุชูุงุฑุงุช ุงูุจุฑุงูุฌุ')) {
                programSelections = {};
                updateAllRowsDisplay();
                saveState();
            }
        }

        function clearAllFilters() {
            selectedStages = ['all'];
            updateButtonStyles();
            filterStages();
            updateTitle();
            saveState();
        }
        
        function parseDate(dateString) {
            if (!dateString) return 9999; 
            const parts = dateString.split('_')[1].split(' / ');
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            return month * 100 + day;
        }

        function printSchedule() {
            const selectedData = [];
            
            const fieldColors = {
                'ุงูููุงุทูุฉ ูุงูุญูุงุฉ': '#981E47',
                'ุงูุซูุงูุฉ ูุงููููู': '#FF7145',
                'ุงูุฑูุงุถุฉ ูุงูุตุญุฉ': '#2FB7BD',
                'ุงูุนููู ูุงูุชูููุฉ': '#24344D',
                'ุงููุดุงุท ุงููุดูู': '#018083',
                'ุงูุฃูุงู ูุงูููุงุณุจุงุช': '#583C71'
            };
            
            const programRows = Array.from(document.querySelectorAll('main tr[data-program-name]'));
            const programRowMap = new Map(programRows.map(row => [row.dataset.programName, row]));

            Object.entries(programSelections).forEach(([programName, schedules]) => {
                const row = programRowMap.get(programName);
                if (!row) return;

                const weekColumnVisible = row.querySelector('.week-column').style.display !== 'none';
                
                schedules.forEach(schedule => {
                    const fieldName = row.cells[0].textContent.trim();
                    const fieldColor = fieldColors[fieldName] || '#666';
                    
                    const stageData = {};
                    const baseCellIndex = weekColumnVisible ? 3 : 2;
                    
                    if (selectedStages.includes('all') || selectedStages.includes('primary')) {
                        const cell = row.cells[baseCellIndex];
                        if (cell && cell.style.display !== 'none') stageData['ุงูุตููู ุงูุฃูููุฉ'] = cell.textContent.trim();
                    }
                    if (selectedStages.includes('all') || selectedStages.includes('upper-primary')) {
                        const cell = row.cells[baseCellIndex + 1];
                        if (cell && cell.style.display !== 'none') stageData['ุงูุตููู ุงูุนููุง'] = cell.textContent.trim();
                    }
                    if (selectedStages.includes('all') || selectedStages.includes('middle')) {
                        const cell = row.cells[baseCellIndex + 2];
                        if (cell && cell.style.display !== 'none') stageData['ุงููุชูุณุทุฉ'] = cell.textContent.trim();
                    }
                    if (selectedStages.includes('all') || selectedStages.includes('high')) {
                        const cell = row.cells[baseCellIndex + 3];
                        if (cell && cell.style.display !== 'none') stageData['ุงูุซุงูููุฉ'] = cell.textContent.trim();
                    }
                    
                    selectedData.push({
                        week: weeksData[schedule.weekKey],
                        weekKey: schedule.weekKey,
                        startDay: schedule.startDay,
                        endDay: schedule.endDay,
                        field: fieldName,
                        program: programName,
                        stages: stageData,
                        fieldColor: fieldColor
                    });
                });
            });


            if (selectedData.length === 0) {
                alert("ูุฑุฌู ุงุฎุชูุงุฑ ุงูุจุฑุงูุฌ ูุงููุชุฑุงุช ุงูุฒูููุฉ ุฃููุงู ูุจู ุงูุทุจุงุนุฉ.");
                return;
            }

            // Group data by week
            const weeklyData = {};
            selectedData.forEach(item => {
                if (!weeklyData[item.weekKey]) {
                    weeklyData[item.weekKey] = {
                        week: item.week,
                        programs: []
                    };
                }
                weeklyData[item.weekKey].programs.push(item);
            });
            
            // Sort programs within each week by start date
            Object.keys(weeklyData).forEach(weekKey => {
                weeklyData[weekKey].programs.sort((a, b) => parseDate(a.startDay) - parseDate(b.startDay));
            });

            const printWindow = window.open('', '_blank');
            const currentTitleText = document.getElementById('main-title').textContent;
            
            let printStageTitle = currentTitleText.replace('ุฎุทุฉ ุงููุดุงุท ุงูุทูุงุจู - ', '');
            if (printStageTitle === 'ุฎุทุฉ ุงููุดุงุท ุงูุทูุงุจู') printStageTitle = 'ูุฌููุน ุงููุฑุงุญู ุงูุฏุฑุงุณูุฉ';
            
            const eduAdmin = document.getElementById('education-admin').value;
            const eduRegion = document.getElementById('education-region').value;
            const schoolName = document.getElementById('school-name').value;
            const leaderName = document.getElementById('activity-leader-name').value;
            const directorName = document.getElementById('school-director-name').value;
            
            let printContent = '<div class="weeks-grid">';
            const weekOrder = Object.keys(weeksData);
            const selectedWeeksSorted = Object.keys(weeklyData).sort((a, b) => weekOrder.indexOf(a) - weekOrder.indexOf(b));
            
            for (let i = 0; i < selectedWeeksSorted.length; i += 5) {
                const rowWeeks = selectedWeeksSorted.slice(i, i + 5);
                
                printContent += '<div class="weeks-row">';
                rowWeeks.forEach(weekKey => {
                    const weekInfo = weeklyData[weekKey];
                    printContent += `
                        <div class="week-column">
                            <div class="week-header" style="background: linear-gradient(135deg, #00A383 0%, #0093B5 100%);">
                                <h3>${weekInfo.week.name} ( ${weekInfo.week.startDate} - ${weekInfo.week.endDate} )</h3>
                            </div>
                            <div class="programs-list">
                    `;
                    weekInfo.programs.forEach(program => {
                        const startDayName = program.startDay.split('_')[0];
                        const endDayName = program.endDay.split('_')[0];
                        const dayInfo = `<div class="selected-day-compact">๐ ${startDayName} ุฅูู ${endDayName}</div>`;
                        
                        printContent += `
                            <div class="program-item">
                                <div class="program-header-compact" style="background-color: ${program.fieldColor};">
                                    <div class="program-name">${program.program}</div>
                                    <div class="field-name">${program.field}</div>
                                </div>
                                ${dayInfo}
                                <div class="stages-compact">
                                    ${Object.entries(program.stages).map(([stage, hours]) => 
                                        `<div class="stage-row">
                                            <span class="stage-label">${stage}:</span>
                                            <span class="stage-value">${hours} ุญุตุต</span>
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                        `;
                    });
                    printContent += `</div></div>`;
                });
                // Fill empty columns to maintain layout
                 for (let j = 0; j < 5 - rowWeeks.length; j++) {
                    printContent += '<div class="week-column empty"></div>';
                }
                printContent += '</div>';
            }
            printContent += '</div>';

            printWindow.document.write(`
                <!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>ุทุจุงุนุฉ ุงูุฎุทุฉ</title>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
                    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                    body { font-family: 'Cairo', sans-serif; margin: 10mm; font-size: 9px; }
                    .print-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #0093B5; }
                    .print-header .logo-container { display: flex; align-items: center; gap: 10px; }
                    .print-header img { height: 50px; }
                    .print-header .header-text p { margin: 0; font-size: 10px; font-weight: 600; }
                    .print-header .title-container { text-align: center; }
                    .print-header h1 { color: #00A383; margin: 0; font-size: 18px; }
                    .print-header h2 { font-size: 16px; color: #0093B5; margin: 2px 0; }
                    .print-header p { color: #555; margin: 2px 0; font-size: 11px; }
                    .weeks-grid { width: 100%; }
                    .weeks-row { display: flex; gap: 6px; margin-bottom: 8px; page-break-inside: avoid; }
                    .week-column { flex: 1; border: 1px solid #ccc; border-radius: 5px; overflow: hidden; min-height: 220px; }
                    .week-column.empty { border-color: transparent; }
                    .week-header { color: white; padding: 5px; text-align: center; }
                    .week-header h3 { font-size: 9px; font-weight: normal; margin: 0; }
                    .programs-list { padding: 4px; }
                    .program-item { margin-bottom: 5px; border: 1px solid #e0e0e0; border-radius: 3px; overflow: hidden; }
                    .program-header-compact { color: white; padding: 4px 6px; }
                    .program-name { font-size: 9px; line-height: 1.1; }
                    .field-name { font-size: 7px; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 1px 3px; border-radius: 5px; display: inline-block; }
                    .selected-day-compact { background: #e8f5e8; color: #2e7d32; padding: 2px 6px; font-size: 8px; font-weight: bold; border-bottom: 1px solid #c8e6c9; }
                    .stages-compact { background: white; padding: 4px 6px; }
                    .stage-row { display: flex; justify-content: space-between; align-items: center; padding: 1px 0; border-bottom: 1px solid #f1f3f4; font-size: 8px; }
                    .stage-row:last-child { border-bottom: none; }
                    .stage-label { font-weight: 600; color: #495057; }
                    .stage-value { background: #e3f2fd; color: #1976d2; padding: 1px 4px; border-radius: 7px; font-weight: bold; font-size: 7px; }
                    .print-signatures { position: fixed; bottom: 10mm; left: 10mm; right: 10mm; display: flex; justify-content: space-around; margin-top: 20px; font-size: 11px; font-weight: bold; text-align: center; }
                    .print-signatures div { flex: 1; }
                </style></head><body>
                    <div class="print-header">
                        <div class="logo-container">
                             <img src="https://salogos.org/wp-content/uploads/2021/11/UntiTtled-1-1300x988.png" alt="ุดุนุงุฑ ุงููุฒุงุฑุฉ">
                            <div class="header-text">
                                <p>${eduAdmin || '&nbsp;'}</p>
                                <p>${eduRegion || '&nbsp;'}</p>
                                <p>${schoolName || '&nbsp;'}</p>
                            </div>
                        </div>
                        <div class="title-container">
                            <h1>ุฎุทุฉ ุงููุดุงุท ุงูุทูุงุจู</h1><h2>${printStageTitle}</h2>
                            <p>ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู ููุนุงู ุงูุฏุฑุงุณู ูกูคูคูง ูู</p>
                        </div>
                        <div></div> 
                    </div>
                    ${printContent}
                    <div class="print-signatures">
                        <div><p style="padding-top: 2em;">${leaderName || '&nbsp;'}</p></div>
                        <div><p style="padding-top: 2em;">${directorName || '&nbsp;'}</p></div>
                    </div>
                </body></html>`);
            
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); }, 500);
        }
        
        function saveState() {
            const state = {
                educationAdmin: document.getElementById('education-admin').value,
                educationRegion: document.getElementById('education-region').value,
                schoolName: document.getElementById('school-name').value,
                activityLeaderName: document.getElementById('activity-leader-name').value,
                schoolDirectorName: document.getElementById('school-director-name').value,
                currentRegion: currentRegion,
                selectedStages: selectedStages,
                programSelections: programSelections,
            };
            localStorage.setItem('activityPlanState', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('activityPlanState');
            if (savedState) {
                const state = JSON.parse(savedState);
                
                document.getElementById('education-admin').value = state.educationAdmin || '';
                document.getElementById('education-region').value = state.educationRegion || '';
                document.getElementById('school-name').value = state.schoolName || '';
                document.getElementById('activity-leader-name').value = state.activityLeaderName || '';
                document.getElementById('school-director-name').value = state.schoolDirectorName || '';

                selectRegion(state.currentRegion || 'other');
                
                selectedStages = state.selectedStages || ['all'];
                updateButtonStyles();
                filterStages();
                updateTitle();

                programSelections = state.programSelections || {};
                updateAllRowsDisplay();
            }
        }

        function resetPlan() {
            if(confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ุฅุนุงุฏุฉ ุจูุงุก ุงูุฎุทุฉุ ุณูุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงููุฏุฎูุฉ ูุงูุงุฎุชูุงุฑุงุช.')) {
                localStorage.removeItem('activityPlanState');
                location.reload();
            }
        }

        function downloadBackup() {
            saveState(); // Ensure latest state is captured
            const backupData = localStorage.getItem('activityPlanState');
            if (!backupData) {
                alert("ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญูุธูุง.");
                return;
            }
            const blob = new Blob([backupData], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ูุณุฎู ุงุญุชูุงุทูู ููุฎุทุฉ ุงููุตููุฉ.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const restoredState = e.target.result;
                    // Basic validation
                    const parsed = JSON.parse(restoredState);
                    if (parsed && typeof parsed === 'object' && 'programSelections' in parsed) {
                         if (confirm('ุณูุชู ุงุณุชุจุฏุงู ุงูุฎุทุฉ ุงูุญุงููุฉ ุจุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ. ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ')) {
                            localStorage.setItem('activityPlanState', restoredState);
                            location.reload();
                         }
                    } else {
                        throw new Error("Invalid file format");
                    }
                } catch (error) {
                    alert("ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุบูุฑ ุตุงูุญ ุฃู ุชุงูู.");
                } finally {
                    // Reset file input to allow selecting the same file again
                    event.target.value = null;
                }
            };
            reader.readAsText(file);
        }

        function closeUpdateModal() {
            const modalContent = document.getElementById('updateModalContent');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                document.getElementById('updateModal').classList.add('hidden');
                localStorage.setItem('updateAlertShown_v2', 'true');
            }, 300);
        }

        document.addEventListener('DOMContentLoaded', function() {
            generateSections();
            loadState();
            
            // Show update modal once
            if (!localStorage.getItem('updateAlertShown_v2')) {
                const modal = document.getElementById('updateModal');
                const modalContent = document.getElementById('updateModalContent');
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                }, 100);
            }
        });
    </script>
</body>
</html>

