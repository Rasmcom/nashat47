<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฎุทุฉ ุงููุดุงุท ุงูุทูุงุจู - ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
        }

        .gradient-header {
            background: linear-gradient(135deg, #00A383 0%, #0093B5 100%);
        }

        .dropdown-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .dropdown-content.active {
            max-height: 5000px; /* Increased max-height for larger content */
            transition: max-height 0.5s ease-in;
        }

        .rotate-arrow {
            transform: rotate(180deg);
            transition: transform 0.3s ease;
        }

        .header-input {
            background-color: transparent;
            border: none;
            color: white;
            padding: 0;
            margin: 0;
            width: 100%;
            text-align: right;
        }
        .header-input::placeholder {
            color: rgba(255, 255, 255, 0.8);
            opacity: 1;
        }

        summary {
            list-style: none;
            cursor: pointer;
        }
        summary::-webkit-details-marker {
            display: none;
        }
        
        #date-picker-modal .week-grid .day.selected {
            background-color: #10B981;
            color: white;
            border-color: #059669;
        }
        #date-picker-modal .week-grid .day.disabled {
            background-color: #F3F4F6;
            color: #9CA3AF;
            cursor: not-allowed;
        }

        #update-modal-box {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        #update-modal-box.active {
            transform: scale(1);
            opacity: 1;
        }

        @media print {
            .no-print { display: none !important; }
            @page { 
                size: A4 landscape; 
                margin: 0; 
            } 
            body { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                margin: 0;
                padding: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div class="bg-red-600 text-white text-center py-2 no-print font-semibold">
        ุชู ุงูุชุญุฏูุซ ุจุชุงุฑูุฎ ูกูฃ / ูฃ / ูกูคูคูง ูู
    </div>

    <div id="update-modal" class="fixed inset-0 z-50 items-center justify-center p-4 no-print bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full text-center transform transition-all scale-95 opacity-0" id="update-modal-box">
            <h3 class="text-2xl font-bold mb-4 text-gray-800 flex items-center justify-center gap-2">
                <span class="text-3xl">๐</span>
                <span>ุชูุจูู</span>
            </h3>
            <div class="text-right space-y-3 text-gray-600">
                <p class="font-semibold text-lg">โจ ูุณุนุฏูุง ุฅุจูุงุบู ุจุฃููุง ุฃุถููุง ูููุฒุงุช ุฌุฏูุฏุฉ:</p>
                <ul class="list-disc list-inside space-y-2 pr-4">
                    <li><strong class="text-teal-600">ุงุฎุชูุงุฑ ุชูุตููู:</strong> ุงูุขู ููููู ุงุฎุชูุงุฑ ูู ูุตู ุนูู ุญุฏุฉ ุนูุฏ ุชุญุฏูุฏ ุงูุจุฑุงูุฌ ูููุฑุงุญู.</li>
                    <li><strong class="text-teal-600">ุงููุณุฎ ุงูุงุญุชูุงุทู:</strong> ุฃุถููุง ููุฒุฉ ุญูุธ ูุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ูุถูุงู ุนุฏู ููุฏุงู ูุนูููุงุชู.</li>
                </ul>
                <p class="font-bold text-center pt-4">โ ุงุณุชูุชุน ุจุงูุชุฌุฑุจุฉ ุงูุฌุฏูุฏุฉ ุงูุขู!</p>
            </div>
            <div class="mt-6">
                <button onclick="closeUpdateModal()" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors font-semibold">ููุงูู</button>
            </div>
        </div>
    </div>

    <div id="date-picker-modal" class="fixed inset-0 z-40 items-center justify-center p-4 no-print bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-4">ุงุฎุชุฑ ุชูุงุฑูุฎ ุงูุชูููุฐ</h3>
            <p id="modal-date-counter" class="text-center text-gray-600 mb-2 font-semibold"></p>
            <div id="modal-weeks-container" class="space-y-4 max-h-96 overflow-y-auto"></div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closeDatePicker()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">ุฅูุบุงุก</button>
                <button onclick="saveDates()" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">ุญูุธ ุงูุชูุงุฑูุฎ</button>
            </div>
        </div>
    </div>

    <div id="main-content" class="transition-opacity duration-500">
        <header class="gradient-header text-white py-4 shadow-lg no-print">
            <div class="container mx-auto px-6 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <img src="https://j.top4top.io/p_3516qltr40.png" alt="ุดุนุงุฑ ุงููุฒุงุฑุฉ" class="h-16 sm:h-20">
                    <div class="flex flex-col gap-0 w-full max-w-xs sm:max-w-sm">
                        <input type="text" id="education-admin" placeholder="ุฃุฏุฎู ุงูุฅุฏุงุฑุฉ ุงูุชุนููููุฉ" class="header-input text-sm font-semibold" onblur="saveState()">
                        <input type="text" id="education-region" placeholder="ุฃุฏุฎู ุงูููุทูุฉ ุงูุชุนููููุฉ" class="header-input text-sm font-semibold" onblur="saveState()">
                        <input type="text" id="school-name" placeholder="ุฃุฏุฎู ุงุณู ุงููุฏุฑุณุฉ" class="header-input text-sm font-semibold" onblur="saveState()">
                    </div>
                </div>
                <div class="text-center">
                    <h1 id="main-title" class="text-xl sm:text-3xl font-bold">ุฎุทุฉ ุงููุดุงุท ุงูุทูุงุจู</h1>
                    <p id="stage-title-header" class="text-lg sm:text-2xl font-bold text-white h-8"></p>
                    <p id="subtitle" class="text-md sm:text-lg opacity-90">ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู ููุนุงู ุงูุฏุฑุงุณู 1447ูู</p>
                </div>
            </div>
        </header>

        <section class="py-8 bg-gray-50 no-print">
            <div class="container mx-auto px-6">
                <div class="mb-8 p-6 bg-white rounded-lg shadow-md">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start text-center">
                        <div class="grid grid-cols-1 gap-6">
                             <div>
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">ุงุฎุชุฑ ุงูููุทูุฉ:</h3>
                                <div class="flex justify-center gap-3">
                                    <button onclick="selectRegion('other')" id="btn-other-region" class="px-4 py-2 rounded-full font-medium transition-all duration-300 bg-blue-600 text-white shadow-lg">ุจุงูู ุงูููุงุทู</button>
                                    <button onclick="selectRegion('western')" id="btn-western-region" class="px-4 py-2 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700">ุงูููุทูุฉ ุงูุบุฑุจูุฉ</button>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">ุญุฌู ุงูุฎุท ููุทุจุงุนุฉ:</h3>
                                <select id="print-font-size" class="p-2 border rounded-md" onchange="saveState()">
                                    <option value="7px">ุตุบูุฑ ุฌุฏุงู</option>
                                    <option value="8px" selected>ุตุบูุฑ (ุงูุชุฑุงุถู)</option>
                                    <option value="10px">ูุชูุณุท</option>
                                    <option value="12px">ูุจูุฑ</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">ุงุฎุชุฑ ุงููุตูู ุงูุฏุฑุงุณูุฉ:</h3>
                            <div id="grade-selection-container" class="flex flex-col items-center gap-4">
                                </div>
                        </div>
                    </div>
                    <div class="mt-8 flex gap-4 justify-center flex-wrap">
                        <button onclick="clearAllFilters()" class="text-sm text-gray-500 hover:text-gray-700 underline">ุฅูุบุงุก ุงุฎุชูุงุฑ ุงููุตูู</button>
                        <button onclick="printSchedule()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">๐จ๏ธ ุทุจุงุนุฉ ุงูุฌุฏูู</button>
                        <button onclick="saveBackup()" class="px-4 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition-colors text-sm">๐พ ุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button>
                        <button onclick="document.getElementById('backup-input').click()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors text-sm">๐ ุงุณุชุนุงุฏุฉ ูุณุฎุฉ</button>
                        <input type="file" id="backup-input" class="hidden" accept=".json" onchange="handleFileUpload(event)">
                        <button onclick="resetPlan()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">๐ ุฅุนุงุฏุฉ ุจูุงุก ุงูุฎุทุฉ</button>
                    </div>
                </div>
            </div>
        </section>

        <main class="container mx-auto px-6 py-8">
            </main>

        <div class="container mx-auto px-6 py-4 no-print">
            <div class="flex justify-between items-center gap-8">
                <input type="text" id="activity-leader-name" placeholder="ุฃุฏุฎู ุงุณู ุฑุงุฆุฏ/ุฉ ุงููุดุงุท" class="w-1/2 p-2 text-center bg-transparent border-b-2 border-gray-300 focus:border-teal-500 outline-none" onblur="saveState()">
                <input type="text" id="school-director-name" placeholder="ุฃุฏุฎู ุงุณู ูุฏูุฑ/ุฉ ุงููุฏุฑุณุฉ" class="w-1/2 p-2 text-center bg-transparent border-b-2 border-gray-300 focus:border-teal-500 outline-none" onblur="saveState()">
            </div>
        </div>

        <footer class="bg-gray-800 text-white py-4 text-center no-print">
            <div class="container mx-auto flex justify-center items-center">
                <a href="https://t.me/+SJnY9vPy7yo5YmI1" target="_blank" class="ml-4">
                    <img src="https://e.top4top.io/p_3463x5tj40.png" alt="ุดุนุงุฑ ููุงุฉ ุฑุณู" class="h-20 w-auto">
                </a>
                <span>ุฌููุน ุงูุญููู ูุญููุธุฉ ูููุงุฉ ุฑุณู ููุชุตููู ูุงูุฎุฏูุงุช ุงูุชุนููููุฉ 2025</span>
            </div>
        </footer>
    </div>

    <script>
        const UPDATE_VERSION_KEY = 'updateModalSeen_v1'; // Increment this version to show the modal again for everyone
        let selectedGrades = [];
        let currentRegion = 'other';
        let activeSelection = null;
        let tempSelectedDates = [];
        let isPrinting = false;
        let isLoading = false; // Flag to prevent saving while loading state

        const gradeNames = {
            'p1': 'ุฃูู ุงุจุชุฏุงุฆู', 'p2': 'ุซุงูู ุงุจุชุฏุงุฆู', 'p3': 'ุซุงูุซ ุงุจุชุฏุงุฆู',
            'p4': 'ุฑุงุจุน ุงุจุชุฏุงุฆู', 'p5': 'ุฎุงูุณ ุงุจุชุฏุงุฆู', 'p6': 'ุณุงุฏุณ ุงุจุชุฏุงุฆู',
            'm1': 'ุฃูู ูุชูุณุท', 'm2': 'ุซุงูู ูุชูุณุท', 'm3': 'ุซุงูุซ ูุชูุณุท',
            'h2': 'ุซุงูู ุซุงููู', 'h3': 'ุซุงูุซ ุซุงููู',
        };
        
        const gradeGroups = {
            'primary_lower': ['p1', 'p2', 'p3'],
            'primary_upper': ['p4', 'p5', 'p6'],
            'primary_all': ['p1', 'p2', 'p3', 'p4', 'p5', 'p6'],
            'middle_all': ['m1', 'm2', 'm3'],
            'high_all': ['h2', 'h3'],
        };
        
        // Define groups for teacher inputs
        const teacherInputGroups = {
            'primary_lower': {
                label: 'ุงูุตููู ุงูุฃูููุฉ',
                grades: ['p1', 'p2', 'p3'],
            },
            'primary_upper': {
                label: 'ุงูุตููู ุงูุนููุง',
                grades: ['p4', 'p5', 'p6'],
            },
            'middle_all': {
                label: 'ุงููุฑุญูุฉ ุงููุชูุณุทุฉ',
                grades: ['m1', 'm2', 'm3'],
            },
            'high_all': {
                label: 'ุงููุฑุญูุฉ ุงูุซุงูููุฉ',
                grades: ['h2', 'h3'],
            },
            'all': {
                label: 'ูู ุงููุฑุงุญู',
                grades: Object.keys(gradeNames),
            },
            'individual': {
                label: (grade) => gradeNames[grade],
                grades: (selectedGrades) => selectedGrades,
            }
        };

        const allGradeKeys = Object.keys(gradeNames);

        const weeksDataDefault = {
            'week1': { name: 'ุงูุฃุณุจูุน ุงูุฃูู', startDate: '1 / 3', endDate: '5 / 3', days: { 'ุงูุฃุญุฏ': '1 / 3', 'ุงูุงุซููู': '2 / 3', 'ุงูุซูุงุซุงุก': '3 / 3', 'ุงูุฃุฑุจุนุงุก': '4 / 3', 'ุงูุฎููุณ': '5 / 3' } },
            'week2': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', startDate: '8 / 3', endDate: '12 / 3', days: { 'ุงูุฃุญุฏ': '8 / 3', 'ุงูุงุซููู': '9 / 3', 'ุงูุซูุงุซุงุก': '10 / 3', 'ุงูุฃุฑุจุนุงุก': '11 / 3', 'ุงูุฎููุณ': '12 / 3' } },
            'week3': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ', startDate: '15 / 3', endDate: '19 / 3', days: { 'ุงูุฃุญุฏ': '15 / 3', 'ุงูุงุซููู': '16 / 3', 'ุงูุซูุงุซุงุก': '17 / 3', 'ุงูุฃุฑุจุนุงุก': '18 / 3', 'ุงูุฎููุณ': '19 / 3' } },
            'week4': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน', startDate: '22 / 3', endDate: '26 / 3', days: { 'ุงูุฃุญุฏ': '22 / 3', 'ุงูุงุซููู': '23 / 3', 'ุงูุซูุงุซุงุก': '24 / 3', 'ุงูุฃุฑุจุนุงุก': '25 / 3', 'ุงูุฎููุณ': '26 / 3' } },
            'week5': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ', startDate: '29 / 3', endDate: '3 / 4', days: { 'ุงูุฃุญุฏ': '29 / 3', 'ุงูุงุซููู': '30 / 3', 'ุงูุซูุงุซุงุก': '1 / 4', 'ุงูุฃุฑุจุนุงุก': '2 / 4', 'ุงูุฎููุณ': '3 / 4' }, specialDays: { '1 / 4': { name: 'ุฅุฌุงุฒุฉ ุงูููู ุงููุทูู', color: 'green' } } },
            'week6': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ', startDate: '6 / 4', endDate: '10 / 4', days: { 'ุงูุฃุญุฏ': '6 / 4', 'ุงูุงุซููู': '7 / 4', 'ุงูุซูุงุซุงุก': '8 / 4', 'ุงูุฃุฑุจุนุงุก': '9 / 4', 'ุงูุฎููุณ': '10 / 4' } },
            'week7': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน', startDate: '13 / 4', endDate: '17 / 4', days: { 'ุงูุฃุญุฏ': '13 / 4', 'ุงูุงุซููู': '14 / 4', 'ุงูุซูุงุซุงุก': '15 / 4', 'ุงูุฃุฑุจุนุงุก': '16 / 4', 'ุงูุฎููุณ': '17 / 4' } },
            'week8': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', startDate: '20 / 4', endDate: '24 / 4', days: { 'ุงูุฃุญุฏ': '20 / 4', 'ุงูุงุซููู': '21 / 4', 'ุงูุซูุงุซุงุก': '22 / 4', 'ุงูุฃุฑุจุนุงุก': '23 / 4', 'ุงูุฎููุณ': '24 / 4' }, specialDays: { '20 / 4': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', color: 'red' } } },
            'week9': { name: 'ุงูุฃุณุจูุน ุงูุชุงุณุน', startDate: '27 / 4', endDate: '1 / 5', days: { 'ุงูุฃุญุฏ': '27 / 4', 'ุงูุงุซููู': '28 / 4', 'ุงูุซูุงุซุงุก': '29 / 4', 'ุงูุฃุฑุจุนุงุก': '30 / 4', 'ุงูุฎููุณ': '1 / 5' } },
            'week10': { name: 'ุงูุฃุณุจูุน ุงูุนุงุดุฑ', startDate: '4 / 5', endDate: '8 / 5', days: { 'ุงูุฃุญุฏ': '4 / 5', 'ุงูุงุซููู': '5 / 5', 'ุงูุซูุงุซุงุก': '6 / 5', 'ุงูุฃุฑุจุนุงุก': '7 / 5', 'ุงูุฎููุณ': '8 / 5' } },
            'week11': { name: 'ุงูุฃุณุจูุน ุงูุญุงุฏู ุนุดุฑ', startDate: '11 / 5', endDate: '15 / 5', days: { 'ุงูุฃุญุฏ': '11 / 5', 'ุงูุงุซููู': '12 / 5', 'ุงูุซูุงุซุงุก': '13 / 5', 'ุงูุฃุฑุจุนุงุก': '14 / 5', 'ุงูุฎููุณ': '15 / 5' } },
            'week12': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ', startDate: '18 / 5', endDate: '22 / 5', days: { 'ุงูุฃุญุฏ': '18 / 5', 'ุงูุงุซููู': '19 / 5', 'ุงูุซูุงุซุงุก': '20 / 5', 'ุงูุฃุฑุจุนุงุก': '21 / 5', 'ุงูุฎููุณ': '22 / 5' } },
            'week13': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ ุนุดุฑ', startDate: '25 / 5', endDate: '29 / 5', days: { 'ุงูุฃุญุฏ': '25 / 5', 'ุงูุงุซููู': '26 / 5', 'ุงูุซูุงุซุงุก': '27 / 5', 'ุงูุฃุฑุจุนุงุก': '28 / 5', 'ุงูุฎููุณ': '29 / 5' } },
            'week14': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน ุนุดุฑ', startDate: '9 / 6', endDate: '13 / 6', days: { 'ุงูุฃุญุฏ': '9 / 6', 'ุงูุงุซููู': '10 / 6', 'ุงูุซูุงุซุงุก': '11 / 6', 'ุงูุฃุฑุจุนุงุก': '12 / 6', 'ุงูุฎููุณ': '13 / 6' } },
            'week15': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ ุนุดุฑ', startDate: '16 / 6', endDate: '20 / 6', days: { 'ุงูุฃุญุฏ': '16 / 6', 'ุงูุงุซููู': '17 / 6', 'ุงูุซูุงุซุงุก': '18 / 6', 'ุงูุฃุฑุจุนุงุก': '19 / 6', 'ุงูุฎููุณ': '20 / 6' }, specialDays: { '20 / 6': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', color: 'red' } } },
            'week16': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ ุนุดุฑ', startDate: '23 / 6', endDate: '27 / 6', days: { 'ุงูุฃุญุฏ': '23 / 6', 'ุงูุงุซููู': '24 / 6', 'ุงูุซูุงุซุงุก': '25 / 6', 'ุงูุฃุฑุจุนุงุก': '26 / 6', 'ุงูุฎููุณ': '27 / 6' }, specialDays: { '23 / 6': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', color: 'red' } } },
            'week17': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน ุนุดุฑ', startDate: '1 / 7', endDate: '5 / 7', days: { 'ุงูุฃุญุฏ': '1 / 7', 'ุงูุงุซููู': '2 / 7', 'ุงูุซูุงุซุงุก': '3 / 7', 'ุงูุฃุฑุจุนุงุก': '4 / 7', 'ุงูุฎููุณ': '5 / 7' } },
            'week18': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ', startDate: '8 / 7', endDate: '12 / 7', days: { 'ุงูุฃุญุฏ': '8 / 7', 'ุงูุงุซููู': '9 / 7', 'ุงูุซูุงุซุงุก': '10 / 7', 'ุงูุฃุฑุจุนุงุก': '11 / 7', 'ุงูุฎููุณ': '12 / 7' } },
        };

        const weeksDataWestern = {
            'week1': { name: 'ุงูุฃุณุจูุน ุงูุฃูู', startDate: '8 / 3', endDate: '12 / 3', days: { 'ุงูุฃุญุฏ': '8 / 3', 'ุงูุงุซููู': '9 / 3', 'ุงูุซูุงุซุงุก': '10 / 3', 'ุงูุฃุฑุจุนุงุก': '11 / 3', 'ุงูุฎููุณ': '12 / 3' } },
            'week2': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', startDate: '15 / 3', endDate: '19 / 3', days: { 'ุงูุฃุญุฏ': '15 / 3', 'ุงูุงุซููู': '16 / 3', 'ุงูุซูุงุซุงุก': '17 / 3', 'ุงูุฃุฑุจุนุงุก': '18 / 3', 'ุงูุฎููุณ': '19 / 3' } },
            'week3': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ', startDate: '22 / 3', endDate: '26 / 3', days: { 'ุงูุฃุญุฏ': '22 / 3', 'ุงูุงุซููู': '23 / 3', 'ุงูุซูุงุซุงุก': '24 / 3', 'ุงูุฃุฑุจุนุงุก': '25 / 3', 'ุงูุฎููุณ': '26 / 3' } },
            'week4': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน', startDate: '29 / 3', endDate: '3 / 4', days: { 'ุงูุฃุญุฏ': '29 / 3', 'ุงูุงุซููู': '30 / 3', 'ุงูุซูุงุซุงุก': '1 / 4', 'ุงูุฃุฑุจุนุงุก': '2 / 4', 'ุงูุฎููุณ': '3 / 4' }, specialDays: { '1 / 4': { name: 'ุฅุฌุงุฒุฉ ุงูููู ุงููุทูู', color: 'green' } } },
            'week5': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ', startDate: '6 / 4', endDate: '10 / 4', days: { 'ุงูุฃุญุฏ': '6 / 4', 'ุงูุงุซููู': '7 / 4', 'ุงูุซูุงุซุงุก': '8 / 4', 'ุงูุฃุฑุจุนุงุก': '9 / 4', 'ุงูุฎููุณ': '10 / 4' } },
            'week6': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ', startDate: '13 / 4', endDate: '17 / 4', days: { 'ุงูุฃุญุฏ': '13 / 4', 'ุงูุงุซููู': '14 / 4', 'ุงูุซูุงุซุงุก': '15 / 4', 'ุงูุฃุฑุจุนุงุก': '16 / 4', 'ุงูุฎููุณ': '17 / 4' } },
            'week7': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน', startDate: '20 / 4', endDate: '24 / 4', days: { 'ุงูุฃุญุฏ': '20 / 4', 'ุงูุงุซููู': '21 / 4', 'ุงูุซูุงุซุงุก': '22 / 4', 'ุงูุฃุฑุจุนุงุก': '23 / 4', 'ุงูุฎููุณ': '24 / 4' }, specialDays: { '20 / 4': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', color: 'red' } } },
            'week8': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', startDate: '27 / 4', endDate: '1 / 5', days: { 'ุงูุฃุญุฏ': '27 / 4', 'ุงูุงุซููู': '28 / 4', 'ุงูุซูุงุซุงุก': '29 / 4', 'ุงูุฃุฑุจุนุงุก': '30 / 4', 'ุงูุฎููุณ': '1 / 5' } },
            'week9': { name: 'ุงูุฃุณุจูุน ุงูุชุงุณุน', startDate: '4 / 5', endDate: '8 / 5', days: { 'ุงูุฃุญุฏ': '4 / 5', 'ุงูุงุซููู': '5 / 5', 'ุงูุซูุงุซุงุก': '6 / 5', 'ุงูุฃุฑุจุนุงุก': '7 / 5', 'ุงูุฎููุณ': '8 / 5' } },
            'week10': { name: 'ุงูุฃุณุจูุน ุงูุนุงุดุฑ', startDate: '11 / 5', endDate: '15 / 5', days: { 'ุงูุฃุญุฏ': '11 / 5', 'ุงูุงุซููู': '12 / 5', 'ุงูุซูุงุซุงุก': '13 / 5', 'ุงูุฃุฑุจุนุงุก': '14 / 5', 'ุงูุฎููุณ': '15 / 5' } },
            'week11': { name: 'ุงูุฃุณุจูุน ุงูุญุงุฏู ุนุดุฑ', startDate: '18 / 5', endDate: '22 / 5', days: { 'ุงูุฃุญุฏ': '18 / 5', 'ุงูุงุซููู': '19 / 5', 'ุงูุซูุงุซุงุก': '20 / 5', 'ุงูุฃุฑุจุนุงุก': '21 / 5', 'ุงูุฎููุณ': '22 / 5' } },
            'week12': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ', startDate: '25 / 5', endDate: '29 / 5', days: { 'ุงูุฃุญุฏ': '25 / 5', 'ุงูุงุซููู': '26 / 5', 'ุงูุซูุงุซุงุก': '27 / 5', 'ุงูุฃุฑุจุนุงุก': '28 / 5', 'ุงูุฎููุณ': '29 / 5' } },
            'week13': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ ุนุดุฑ', startDate: '9 / 6', endDate: '13 / 6', days: { 'ุงูุฃุญุฏ': '9 / 6', 'ุงูุงุซููู': '10 / 6', 'ุงูุซูุงุซุงุก': '11 / 6', 'ุงูุฃุฑุจุนุงุก': '12 / 6', 'ุงูุฎููุณ': '13 / 6' } },
            'week14': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน ุนุดุฑ', startDate: '16 / 6', endDate: '20 / 6', days: { 'ุงูุฃุญุฏ': '16 / 6', 'ุงูุงุซููู': '17 / 6', 'ุงูุซูุงุซุงุก': '18 / 6', 'ุงูุฃุฑุจุนุงุก': '19 / 6', 'ุงูุฎููุณ': '20 / 6' }, specialDays: { '20 / 6': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', color: 'red' } } },
            'week15': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ ุนุดุฑ', startDate: '23 / 6', endDate: '27 / 6', days: { 'ุงูุฃุญุฏ': '23 / 6', 'ุงูุงุซููู': '24 / 6', 'ุงูุซูุงุซุงุก': '25 / 6', 'ุงูุฃุฑุจุนุงุก': '26 / 6', 'ุงูุฎููุณ': '27 / 6' }, specialDays: { '23 / 6': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', color: 'red' } } },
            'week16': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ ุนุดุฑ', startDate: '1 / 7', endDate: '5 / 7', days: { 'ุงูุฃุญุฏ': '1 / 7', 'ุงูุงุซููู': '2 / 7', 'ุงูุซูุงุซุงุก': '3 / 7', 'ุงูุฃุฑุจุนุงุก': '4 / 7', 'ุงูุฎููุณ': '5 / 7' } },
            'week17': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน ุนุดุฑ', startDate: '8 / 7', endDate: '12 / 7', days: { 'ุงูุฃุญุฏ': '8 / 7', 'ุงูุงุซููู': '9 / 7', 'ุงูุซูุงุซุงุก': '10 / 7', 'ุงูุฃุฑุจุนุงุก': '11 / 7', 'ุงูุฎููุณ': '12 / 7' } },
        };
        
        let weeksData = weeksDataDefault;

        const activitiesData = [
            { id: 'citizenship', title: 'ุงูููุงุทูุฉ ูุงูุญูุงุฉ', color: '#981E47', icon: 'https://k.top4top.io/p_3472ccl2l0.gif', programs: [
                { name: 'ุงูุชุทูุน ุงูุทูุงุจู', sessions: { p1:4, p2:4, p3:4, p4:6, p5:6, p6:6, m1:5, m2:5, m3:5, h2:5, h3:5 } },
                { name: 'ููุงุฑุงุช ุทููุญุฉ', sessions: { p1:6, p2:6, p3:6, p4:4, p5:4, p6:4, m1:3, m2:3, m3:3, h2:2, h3:2 } },
                { name: 'ููููุง ุญูุงุฉ', sessions: { p4:12, p5:12, p6:12, m1:12, m2:12, m3:12, h2:12, h3:12 } },
            ]},
            { id: 'culture', title: 'ุงูุซูุงูุฉ ูุงููููู', color: '#FF7145', icon: 'https://a.top4top.io/p_3472miame2.gif', programs: [
                 { name: 'ุงููู ุงูุณุงุจุน (ุงูุณูููุง)', sessions: { p1:8, p2:8, p3:8, p4:8, p5:8, p6:8, m1:8, m2:8, m3:8, h2:8, h3:8 } },
                 { name: 'ุญุฏุงุฆู ุงููู', sessions: { p1:6, p2:6, p3:6, p4:6, p5:6, p6:6, m1:6, m2:6, m3:6, h2:6, h3:6 } },
                 { name: 'ุงูุฃุฒูุงุก ุงูุณุนูุฏูุฉ', sessions: { p1:4, p2:4, p3:4, p4:4, p5:4, p6:4, m1:6, m2:6, m3:6, h2:6, h3:6 } },
                 { name: 'ุงูุซูุงูุฉ ุงูุฅุนูุงููุฉ', sessions: { p1:4, p2:4, p3:4, p4:4, p5:4, p6:4, m1:6, m2:6, m3:6, h2:8, h3:8 } },
                 { name: 'ุชุตุงููู ุชุฑุงุซูุฉ ูุนุงุตุฑุฉ', sessions: { p1:5, p2:5, p3:5, p4:5, p5:5, p6:5, m1:5, m2:5, m3:5, h2:5, h3:5 } },
                 { name: 'ุงููููู ุงููุณุฑุญูุฉ', sessions: { p1:8, p2:8, p3:8, p4:8, p5:8, p6:8, m1:8, m2:8, m3:8, h2:8, h3:8 } },
                 { name: 'ุงูุจุฑูุงูุฌ ุงูููุณููู (ุงูุฃูุงุดูุฏ ุงููุทููุฉ)', sessions: { p1:8, p2:8, p3:8, p4:8, p5:8, p6:8, m1:8, m2:8, m3:8, h2:8, h3:8 } },
                 { name: 'ุญูุงูุงุช ูุฑุฆูุฉ', sessions: { p1:6, p2:6, p3:6, p4:6, p5:6, p6:6, m1:11, m2:11, m3:11, h2:11, h3:11 } },
            ]},
            { id: 'sports', title: 'ุงูุฑูุงุถุฉ ูุงูุตุญุฉ', color: '#2FB7BD', icon: 'https://c.top4top.io/p_3472urwbn4.gif', programs: [
                { name: 'ููุงุฑุงุช ุงูุฑูุงุถุงุช ุงูุฌูุงุนูุฉ', sessions: { p1:6, p2:6, p3:6, p4:8, p5:8, p6:8, m1:8, m2:8, m3:8, h2:8, h3:8 } },
                { name: 'ููุงุฑุงุช ุงูุฑูุงุถุงุช ุงููุฑุฏูุฉ', sessions: { p1:8, p2:8, p3:8, p4:8, p5:8, p6:8, m1:8, m2:8, m3:8, h2:6, h3:6 } },
                { name: 'ููุงุฑุงุช ุฑูุงุถุงุช ุงูุฏูุงุน ุนู ุงูููุณ', sessions: { p1:8, p2:8, p3:8, p4:8, p5:8, p6:8, m1:8, m2:8, m3:8, h2:6, h3:6 } },
                { name: 'ููุงุฑุงุช ุงูุฑูุงุถุงุช ุงูุฅููุชุฑูููุฉ ูุงูุชุฑููู', sessions: { p1:8, p2:8, p3:8, p4:8, p5:8, p6:8, m1:6, m2:6, m3:6, h2:8, h3:8 } },
                { name: 'ููุงุฑุงุช ุงูุฑูุงุถุงุช ุงูุฐูููุฉ', sessions: { p1:6, p2:6, p3:6, p4:8, p5:8, p6:8, m1:8, m2:8, m3:8, h2:8, h3:8 } },
                { name: 'ููุงุฑุงุช ุงูุฃูููุจูุงุฏ ุงูุฑูุงุถู', sessions: { p1:6, p2:6, p3:6, p4:8, p5:8, p6:8, m1:8, m2:8, m3:8, h2:8, h3:8 } },
            ]},
            { id: 'science', title: 'ุงูุนููู ูุงูุชูููุฉ', color: '#24344D', icon: 'https://l.top4top.io/p_3472daolv1.gif', programs: [
                { name: 'ุจุฑูุงูุฌ ุชุทุจููุงุช STEM', sessions: { p1:3, p2:3, p3:3, p4:5, p5:5, p6:5, m1:7, m2:7, m3:7, h2:7, h3:7 } },
                { name: 'ุจุฑูุงูุฌ ุงูุชุตุงููู ุงูุนูููุฉ ุงูุชูููุฉ', sessions: { p1:2, p2:2, p3:2, p4:5, p5:5, p6:5, m1:7, m2:7, m3:7, h2:7, h3:7 } },
                { name: 'ุจุฑูุงูุฌ ุฑูุงุฏ ูุถุงุก ุงููุณุชูุจู', sessions: { p1:3, p2:3, p3:3, p4:5, p5:5, p6:5, m1:7, m2:7, m3:7, h2:9, h3:9 } },
                { name: 'ุจุฑูุงูุฌ ูุฏู ุงููุณุชูุจู', sessions: { p1:3, p2:3, p3:3, p4:4, p5:4, p6:4, m1:7, m2:7, m3:7, h2:9, h3:9 } },
                { name: 'ุจุฑูุงูุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู', sessions: { p1:10, p2:10, p3:10, p4:10, p5:10, p6:10, m1:10, m2:10, m3:10, h2:10, h3:10 } },
                { name: 'ุจุฑูุงูุฌ ุชุญุฏู ุฅูุชุฑูุช ุงูุฃุดูุงุก', sessions: { p1:3, p2:3, p3:3, p4:4, p5:4, p6:4, m1:7, m2:7, m3:7, h2:9, h3:9 } },
            ]},
            { id: 'scouting', title: 'ุงููุดุงุท ุงููุดูู', color: '#018083', icon: 'https://b.top4top.io/p_3472h0ngk3.gif', programs: [
                { name: 'ุฎููุชู ุงูุฌูููุฉ', sessions: { p1:3, p2:3, p3:3 } },
                { name: 'ุฎุดุจุฉ ูุญุจู', sessions: { p4:12, p5:12, p6:12 } },
                { name: 'ุงูููุงุญุฉ ุนูู ุงููุงุจุณ', sessions: { m1:3, m2:3, m3:3 } },
                { name: 'ุฃุบุงูุฑ ูุฃูุชุดู', sessions: { h2:5, h3:5 } },
                { name: 'ุจุฑุงุนู ุงูุจูุฆุฉ ูุงููุฌุชูุน', sessions: { p1:2, p2:2, p3:2 } },
                { name: 'ุฃุดุงุฑู ูุฌุชูุนู ูุฃุฒุฑุน ุดุฌุฑุฉ', sessions: { p4:3, p5:3, p6:3 } },
                { name: 'ูุฌุชูุนู ูุจูุฆุชู ูุณุคูููุชู', sessions: { m1:6, m2:6, m3:6 } },
                { name: 'ุณููุฑ ุงูุจูุฆุฉ ูุงููุฌุชูุน', sessions: { h2:5, h3:5 } },
                { name: 'ุจุตูุชู ุงููุดููุฉ', sessions: { p1:3, p2:3, p3:3 } },
                { name: 'ูุทูู ูู ููุจู', sessions: { p4:3, p5:3, p6:3 } },
                { name: 'ุตูุงุน ุงูุชุบููุฑ', sessions: { m1:3, m2:3, m3:3 } },
                { name: 'ุณูุงุนุฏ ุงููุดููุฉ', sessions: { h2:6, h3:6 } },
                { name: 'ุจุฑุงุนู ุงูููุฑ', sessions: { p1:2, p2:2, p3:2 } },
                { name: 'ูููุฒ ุงูุตุบุงุฑ', sessions: { p4:2, p5:2, p6:2 } },
                { name: 'ูู ูุฏู ุงููุฑุขู ูุงูุณูุฉ', sessions: { m1:3, m2:3, m3:3 } },
                { name: 'ุฏุฑุจ ุงูุฅุญุณุงู', sessions: { h2:3, h3:3 } },
                { name: 'ุจูุตูุฉ ุงูุงูุชุดุงู', sessions: { p1:3, p2:3, p3:3 } },
                { name: 'ุฎููุฉ ุงูุชุฌุงุฑุจ ุงููุณููุฉ', sessions: { p4:6, p5:6, p6:6 } },
                { name: 'ูุฎููู ุงูุชููู', sessions: { m1:10, m2:10, m3:10 } },
                { name: 'ูุงุญุฉ ุงูุฅุจุฏุงุน ุงููุดูู', sessions: { h2:4, h3:4 } },
                { name: 'ุนุงุฏุงุชู ุงูุตุญูุฉ ุงููุดููุฉ', sessions: { p1:3, p2:3, p3:3 } },
                { name: 'ุทุจูู ุงููุดูู', sessions: { p4:3, p5:3, p6:3 } },
                { name: 'ุฎุทูุงุชู ุงููุดููุฉ ุงูุตุญูุฉ', sessions: { m1:3, m2:3, m3:3 } },
                { name: 'ููุฑุฌุงู ุงูุฃููุงู ุงููุดููุฉ ุงูุตุญูุฉ', sessions: { h2:5, h3:5 } },
                { name: 'ููุงุฑุงุชู ููุดููุชู', sessions: { p1:2, p2:2, p3:2 } },
                { name: 'ุตุงูุฑุฉ ูุงุตุทูุงู', sessions: { p4:2, p5:2, p6:2 } },
                { name: 'ููุงุฑุงุชู ุงููุดููุฉ ูู ุงูุงุณุชุนุฏุงุฏ ุฅูู ุงูุฅูุฌุงุฒ', sessions: { m1:4, m2:4, m3:4 } },
                { name: 'ุฃููู ุงููุดูู ุงููุงุณุน', sessions: { h2:6, h3:6 } },
            ]},
            { id: 'events', title: 'ุงูุฃูุงู ูุงูููุงุณุจุงุช', color: '#583C71', icon: 'https://e.top4top.io/p_34729xucx5.gif', programs: [
                { name: 'ุงูููู ุงููุทูู', date: 'ููุงูู ูก / ูค / ูกูคูคูง ูู', sessions: { p1:4, p2:4, p3:4, p4:4, p5:4, p6:4, m1:4, m2:4, m3:4, h2:4, h3:4 } },
                { name: 'ููู ุงูุชุณุงูุญ ุงูุนุงููู', date: 'ููุงูู ูขูฅ / ูฅ / ูกูคูคูง ูู', sessions: { p1:2, p2:2, p3:2, p4:2, p5:2, p6:2, m1:1, m2:1, m3:1, h2:1, h3:1 } },
                { name: 'ุงูููู ุงูุนุงููู ููุทูู', date: 'ููุงูู ูขูฉ / ูฅ / ูกูคูคูง ูู', sessions: { p1:2, p2:2, p3:2, p4:2, p5:2, p6:2 } },
                { name: 'ุงูููู ุงูุนุงููู ูุฐูู ุงูุฅุนุงูุฉ', date: 'ููุงูู ูกูข / ูฆ / ูกูคูคูง ูู', sessions: { p1:2, p2:2, p3:2, p4:2, p5:2, p6:2, m1:2, m2:2, m3:2, h2:2, h3:2 } },
                { name: 'ุงูููู ุงูุนุงููู ููุบุฉ ุงูุนุฑุจูุฉ', date: 'ููุงูู ูขูง / ูฆ / ูกูคูคูง ูู', sessions: { p1:2, p2:2, p3:2, p4:2, p5:2, p6:2, m1:1, m2:1, m3:1, h2:1, h3:1 } },
                { name: 'ุงูููู ุงูุนุงููู ููุชุนููู', date: 'ููุงูู ูง / ูจ / ูกูคูคูง ูู', sessions: { p1:2, p2:2, p3:2, p4:2, p5:2, p6:2, m1:2, m2:2, m3:2, h2:2, h3:2 } },
                { name: 'ููู ุงูุชุฃุณูุณ', date: 'ููุงูู ูฅ / ูฉ / ูกูคูคูง ูู', sessions: { p1:4, p2:4, p3:4, p4:4, p5:4, p6:4, m1:4, m2:4, m3:4, h2:4, h3:4 } },
                { name: 'ููู ุงูุนูู ุงูุณุนูุฏู', date: 'ููุงูู ูขูข / ูฉ / ูกูคูคูง ูู', sessions: { p1:3, p2:3, p3:3, p4:3, p5:3, p6:3, m1:2, m2:2, m3:2, h2:2, h3:2 } },
                { name: 'ููู ุงูุณุนูุฏูุฉ ุงูุฎุถุฑุงุก', date: 'ููุงูู ูจ / ูกู / ูกูคูคูง ูู', sessions: { p1:3, p2:3, p3:3, p4:3, p5:3, p6:3, m1:2, m2:2, m3:2, h2:2, h3:2 } },
                { name: 'ููู ุงูุตุญุฉ ุงูุนุงููู', date: 'ููุงูู ูกูฉ / ูกู / ูกูคูคูง ูู', sessions: { p1:2, p2:2, p3:2, p4:2, p5:2, p6:2, m1:2, m2:2, m3:2, h2:2, h3:2 } },
            ]},
        ];
        
        // Helper functions for date formatting
        function parseDateForSort(dateStr) {
            // Example dateStr: "ุงูุฃุญุฏ 1 / 3" or "ุงูุฎููุณ 12 / 7"
            const parts = dateStr.split(' '); // ["ุงูุฃุญุฏ", "1", "/", "3"]
            const datePart = parts.slice(1).join(''); // "1/3"
            const dateParts = datePart.split('/');
            if (dateParts.length < 2) return 9999;
            const day = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10);
            return month * 100 + day;
        }

        function formatDatesForDisplay(datesArray) {
            if (!datesArray || datesArray.length === 0) {
                return { text: '', json: '[]' };
            }

            const getWeekInfoForDate = (fullDateStr) => {
                const datePartWithSpaces = fullDateStr.split(' ').slice(1).join(' '); 
                for (const weekKey in weeksData) {
                    const week = weeksData[weekKey];
                    if (Object.values(week.days).includes(datePartWithSpaces)) {
                        return week;
                    }
                }
                return null;
            };
            
            const sortedDates = [...datesArray].sort((a, b) => parseDateForSort(a) - parseDateForSort(b));
            const firstDateStr = sortedDates[0];
            const lastDateStr = sortedDates[sortedDates.length - 1];
            
            const firstWeekInfo = getWeekInfoForDate(firstDateStr);
            const lastWeekInfo = getWeekInfoForDate(lastDateStr);

            let textContent = '';

            if (firstWeekInfo && lastWeekInfo && firstWeekInfo.name === lastWeekInfo.name) {
                // All dates fall within the same week
                textContent = `${firstWeekInfo.name} ูู ${firstWeekInfo.startDate} ุฅูู ${firstWeekInfo.endDate}`;
            } else if (sortedDates.length > 1 && firstWeekInfo && lastWeekInfo) {
                // Dates span multiple weeks
                textContent = `ูู ${firstWeekInfo.name} (${firstDateStr}) ุฅูู ${lastWeekInfo.name} (${lastDateStr})`;
            } else {
                // Fallback (e.g., single date)
                textContent = sortedDates.join(' | ');
            }

            return {
                text: textContent,
                json: JSON.stringify(sortedDates)
            };
        }


        function createGradeSelectionUI() {
            const container = document.getElementById('grade-selection-container');
            container.innerHTML = `
                <button onclick="handleGradeSelection('all')" id="btn-all" class="w-full max-w-sm flex items-center justify-center gap-2 px-4 py-2 rounded-full font-medium transition-all duration-300">๐ซ ุงููู</button>
            `;

            const stages = [
                { title: 'ุงูุงุจุชุฏุงุฆูุฉ', groups: [
                    { label: 'ุงููู', key: 'primary_all' }, 
                    { label: 'ุงูุฃูููุฉ', key: 'primary_lower' },
                    { label: 'ุงูุนููุง', key: 'primary_upper' }
                ], individuals: ['p1', 'p2', 'p3', 'p4', 'p5', 'p6'] },
                { title: 'ุงููุชูุณุทุฉ', groups: [{ label: 'ุงููู', key: 'middle_all' }], individuals: ['m1', 'm2', 'm3'] },
                { title: 'ุงูุซุงูููุฉ', groups: [{ label: 'ุงููู', key: 'high_all' }], individuals: ['h2', 'h3'] }
            ];

            stages.forEach(stage => {
                const stageWrapper = document.createElement('div');
                stageWrapper.className = 'w-full max-w-sm border p-2 rounded-lg';
                
                const titleEl = document.createElement('h4');
                titleEl.className = 'font-semibold mb-2';
                titleEl.textContent = stage.title;
                stageWrapper.appendChild(titleEl);

                const groupsContainer = document.createElement('div');
                groupsContainer.className = 'flex flex-wrap justify-center gap-2 mb-2';
                stage.groups.forEach(group => {
                    groupsContainer.innerHTML += `<button onclick="handleGradeSelection('${group.key}')" id="btn-${group.key}" class="px-3 py-1 rounded-full text-sm font-medium transition-all duration-300">${group.label}</button>`;
                });
                stageWrapper.appendChild(groupsContainer);

                const individualsContainer = document.createElement('div');
                individualsContainer.className = 'flex flex-wrap justify-center gap-2 border-t pt-2 mt-2';
                 stage.individuals.forEach(indKey => {
                    individualsContainer.innerHTML += `<button onclick="handleGradeSelection('${indKey}')" id="btn-${indKey}" class="px-3 py-1 rounded-full text-sm font-medium transition-all duration-300">${gradeNames[indKey]}</button>`;
                });
                stageWrapper.appendChild(individualsContainer);

                container.appendChild(stageWrapper);
            });
        }
        
        function generateSections() {
            const mainContainer = document.querySelector('main');
            mainContainer.innerHTML = ''; 

            activitiesData.forEach(section => {
                const programRows = section.programs.map((prog, index) => {
                    const uniqueId = `${section.id}-${index}`;
                    return `
                    <tr 
                        data-program-id="${uniqueId}" 
                        data-program-name="${prog.name}" 
                        data-field-name="${section.title}" 
                        data-field-color="${section.color}"
                        data-sessions='${JSON.stringify(prog.sessions)}'
                    >
                        <td class="border border-gray-300 px-2 py-3 font-semibold" style="background-color: ${section.color}; color: white;">${section.title}</td>
                        <td class="border border-gray-300 px-2 py-3">
                            <div>${prog.name}</div>
                            ${prog.date ? `<div class="text-sm text-blue-600 font-semibold pt-1">${prog.date}</div>` : ''}
                        </td>
                        <td class="border border-gray-300 px-2 py-3">
                            <div class="teacher-inputs-container space-y-2" data-program-id="${uniqueId}"></div>
                        </td>
                        <td class="border border-gray-300 px-2 py-3 align-top">
                            <div class="space-y-1" id="selectors-container-${uniqueId}"></div>
                        </td>
                    </tr>
                `}).join('');

                const sectionHTML = `
                    <section id="${section.id}" class="mb-8">
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                            <button onclick="toggleDropdown('${section.id}-dropdown')" class="w-full px-6 py-4 text-right font-bold text-lg flex justify-between items-center transition-colors hover:bg-gray-50" style="background-color: ${section.color}; color: white;">
                                <div class="flex items-center">
                                    <div class="w-12 h-12 rounded-full bg-white flex items-center justify-center ml-4 overflow-hidden">
                                        <img src="${section.icon}" alt="${section.title}" class="w-8 h-8 object-contain">
                                    </div>
                                    <span>${section.title}</span>
                                </div>
                                <svg id="${section.id}-arrow" class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="${section.id}-dropdown" class="dropdown-content">
                                <div class="p-6">
                                    <div class="overflow-x-auto">
                                        <table class="w-full border-collapse border border-gray-300">
                                            <thead>
                                                <tr class="bg-gray-100">
                                                    <th class="border border-gray-300 px-2 py-3 text-right font-semibold w-1/5">ุงููุฌุงู</th>
                                                    <th class="border border-gray-300 px-2 py-3 text-right font-semibold w-2/5">ุงูุจุฑูุงูุฌ</th>
                                                    <th class="border border-gray-300 px-2 py-3 text-right font-semibold w-1/5">ุงููุนูู/ุฉ ุงููููุฐ/ุฉ</th>
                                                    <th class="border border-gray-300 px-2 py-3 text-center font-semibold w-1/5">ุชูุงุฑูุฎ ุงูุชูููุฐ</th>
                                                </tr>
                                            </thead>
                                            <tbody>${programRows}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                `;
                mainContainer.innerHTML += sectionHTML;
            });
        }
        
        function updateAllDateSelectors() {
            document.querySelectorAll('tr[data-program-id]').forEach(row => {
                updateDateSelectorsForRow(row);
                updateTeacherInputsForRow(row);
            });
        }
        
        function updateTeacherInputsForRow(row) {
            const uniqueId = row.dataset.programId;
            const container = row.querySelector(`.teacher-inputs-container`);
            if (!container) return;

            const sessions = JSON.parse(row.dataset.sessions);
            const effectiveGrades = getEffectiveIndividualGrades().filter(grade => sessions[grade] > 0);

            let newHTML = '';
            
            let teacherGroupsToDisplay = [];
            const isAllSelected = selectedGrades.includes('all');
            
            if (isAllSelected) {
                teacherGroupsToDisplay.push('all');
            } else {
                 teacherGroupsToDisplay.push(...selectedGrades);
            }

            teacherGroupsToDisplay = teacherGroupsToDisplay.filter(key => {
                const groupGrades = gradeGroups[key] || [key];
                return groupGrades.some(g => effectiveGrades.includes(g));
            });

            if (teacherGroupsToDisplay.length === 0 && effectiveGrades.length > 0) {
                 teacherGroupsToDisplay = effectiveGrades;
            }

            teacherGroupsToDisplay.forEach(key => {
                const groupData = teacherInputGroups[key];
                // ===== START: CORRECTED LINE =====
                const label = (groupData ? groupData.label : gradeNames[key]) || 'ูุฑุญูุฉ ุบูุฑ ูุญุฏุฏุฉ';
                // ===== END: CORRECTED LINE =====
                newHTML += `
                    <div class="teacher-input-group">
                        <label class="text-xs text-gray-500 font-semibold">${label}</label>
                        <textarea placeholder="ุงุณู ุงููุนูู/ุฉ" class="teacher-input w-full p-1 border rounded text-sm" data-grade-key="${key}" rows="2" onblur="saveState()"></textarea>
                    </div>
                `;
            });

            container.innerHTML = newHTML;
        }

        function updateDateSelectorsForRow(row) {
            const uniqueId = row.dataset.programId;
            const sessions = JSON.parse(row.dataset.sessions);
            const container = document.getElementById(`selectors-container-${uniqueId}`);
            if (!container) return;
            container.innerHTML = '';

            const itemsToDisplay = selectedGrades.includes('all') 
                ? ['primary_lower', 'primary_upper', 'middle_all', 'high_all'] 
                : selectedGrades;

            let newHTML = '';
            itemsToDisplay.forEach(key => {
                const individualGradeKeys = gradeGroups[key] || [key];
                let sessionCount = 0;
                let label = gradeNames[key];

                sessionCount = Math.max(0, ...individualGradeKeys.map(g => sessions[g] || 0));

                if (key === 'primary_all') label = 'ุงููุฑุญูุฉ ุงูุงุจุชุฏุงุฆูุฉ';
                else if (key === 'primary_lower') label = 'ุงูุตููู ุงูุฃูููุฉ';
                else if (key === 'primary_upper') label = 'ุงูุตููู ุงูุนููุง';
                else if (key === 'middle_all') label = 'ุงููุฑุญูุฉ ุงููุชูุณุทุฉ';
                else if (key === 'high_all') label = 'ุงููุฑุญูุฉ ุงูุซุงูููุฉ';

                if (sessionCount > 0) {
                    newHTML += `
                    <div class="grade-date-selector p-2 border-t first:border-t-0" data-grade-key="${key}">
                        <div class="flex justify-between items-center text-sm mb-1">
                            <span class="font-semibold">${label}</span>
                            <span class="text-gray-500">${sessionCount} ุญุตุต</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="dates-display text-xs text-gray-600 flex-grow text-right p-1 bg-gray-50 rounded min-h-[26px]" data-dates="[]"></div>
                            <div class="flex-shrink-0 flex gap-1">
                                <button class="date-select-btn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" onclick="openDatePicker('${uniqueId}', '${key}')">ุงุฎุชูุงุฑ</button>
                                <button class="clear-date-btn bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600" onclick="clearGradeDates('${uniqueId}', '${key}')">ูุณุญ</button>
                            </div>
                        </div>
                    </div>`;
                }
            });

            container.innerHTML = newHTML;
        }

        function getEffectiveIndividualGrades() {
            if (selectedGrades.includes('all')) {
                return [...allGradeKeys];
            }
            let individuals = [];
            selectedGrades.forEach(item => {
                individuals.push(...(gradeGroups[item] || [item]));
            });
            return [...new Set(individuals)];
        }

        function handleGradeSelection(key) {
            if (key === 'all') {
                selectedGrades = ['all'];
            } else {
                let newSelection = selectedGrades.includes('all') ? [] : [...selectedGrades];
                
                const isAdding = !newSelection.includes(key);

                if (isAdding) {
                    let conflicts = [];
                    // If the added key is a group, its members are conflicts.
                    if (gradeGroups[key]) {
                        conflicts.push(...gradeGroups[key]);
                    }
                    // Any group that contains the added key is a conflict.
                    for (const groupKey in gradeGroups) {
                        if (gradeGroups[groupKey].includes(key)) {
                            conflicts.push(groupKey);
                        }
                    }
                    // Remove all conflicts from the current selection
                    newSelection = newSelection.filter(item => !conflicts.includes(item));
                    newSelection.push(key);
                } else {
                    // Just remove the key if it's being deselected
                    newSelection = newSelection.filter(item => item !== key);
                }
                
                selectedGrades = newSelection;
            }

            updateButtonStyles();
            updateTitle();
            updateAllDateSelectors();
            saveState();
        }


        function updateButtonStyles() {
            const effectiveSelection = getEffectiveIndividualGrades();
            
            allGradeKeys.forEach(key => {
                const btn = document.getElementById(`btn-${key}`);
                if(btn) {
                    if (effectiveSelection.includes(key)) {
                        btn.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
                        btn.classList.remove('bg-gray-200', 'text-gray-700');
                    } else {
                        btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    }
                }
            });

            Object.keys(gradeGroups).forEach(key => {
                const btn = document.getElementById(`btn-${key}`);
                if(btn) {
                    const groupMembers = gradeGroups[key];
                    if (groupMembers.length > 0) { // Ensure not an empty group
                        const isGroupSelected = groupMembers.every(g => effectiveSelection.includes(g));
                        if (isGroupSelected) {
                            btn.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
                            btn.classList.remove('bg-gray-200', 'text-gray-700');
                        } else {
                            btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                            btn.classList.add('bg-gray-200', 'text-gray-700');
                        }
                    }
                }
            });

            const btnAll = document.getElementById('btn-all');
            if (selectedGrades.includes('all')) {
                btnAll.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
                btnAll.classList.remove('bg-gray-200', 'text-gray-700');
            } else {
                btnAll.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                btnAll.classList.add('bg-gray-200', 'text-gray-700');
            }
        }


        function selectRegion(region) {
            currentRegion = region;
            weeksData = region === 'western' ? weeksDataWestern : weeksDataDefault;

            const btnWestern = document.getElementById('btn-western-region');
            const btnOther = document.getElementById('btn-other-region');

            if (region === 'western') {
                btnWestern.className = 'px-4 py-2 rounded-full font-medium transition-all duration-300 bg-blue-600 text-white shadow-lg';
                btnOther.className = 'px-4 py-2 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700';
            } else {
                btnOther.className = 'px-4 py-2 rounded-full font-medium transition-all duration-300 bg-blue-600 text-white shadow-lg';
                btnWestern.className = 'px-4 py-2 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700';
            }
            saveState();
        }

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const arrow = document.getElementById(dropdownId.replace('-dropdown', '-arrow'));
            
            document.querySelectorAll('.dropdown-content.active').forEach(openDropdown => {
                if (openDropdown.id !== dropdownId) {
                    openDropdown.classList.remove('active');
                    const otherArrow = document.getElementById(openDropdown.id.replace('-dropdown', '-arrow'));
                    if (otherArrow) otherArrow.classList.remove('rotate-arrow');
                }
            });

            dropdown.classList.toggle('active');
            arrow.classList.toggle('rotate-arrow');
        }

        function updateTitle() {
            const stageTitleHeader = document.getElementById('stage-title-header');
            if (selectedGrades.includes('all') || selectedGrades.length === 0) {
                stageTitleHeader.textContent = '';
                return;
            }
            
            const titles = [];
            
            let primTitleDone = false;
            if (selectedGrades.includes('primary_all')) { titles.push('ูููุฑุญูุฉ ุงูุงุจุชุฏุงุฆูุฉ'); primTitleDone = true; }
            else if (selectedGrades.includes('primary_lower') && selectedGrades.includes('primary_upper')) { titles.push('ูููุฑุญูุฉ ุงูุงุจุชุฏุงุฆูุฉ'); primTitleDone = true; }
            
            if (!primTitleDone) {
                 if (selectedGrades.includes('primary_lower')) titles.push('ููุตููู ุงูุฃูููุฉ');
                 if (selectedGrades.includes('primary_upper')) titles.push('ููุตููู ุงูุนููุง');
            }

            const individualInSelection = selectedGrades.filter(g => !gradeGroups[g]);
            const primIndividuals = individualInSelection.filter(g => g.startsWith('p'));

            if(primIndividuals.length > 0) {
                 const primText = `ูู ${primIndividuals.map(g => gradeNames[g]).join(' ู')}`;
                 if (!titles.some(t => t.includes('ูููุฑุญูุฉ ุงูุงุจุชุฏุงุฆูุฉ') || t.includes('ููุตููู'))) {
                     titles.push(primText);
                 }
            }

            if (selectedGrades.includes('middle_all')) {
                titles.push('ูููุฑุญูุฉ ุงููุชูุณุทุฉ');
            } else {
                const midIndividuals = individualInSelection.filter(g => g.startsWith('m'));
                if (midIndividuals.length > 0) {
                    titles.push(`ูู ${midIndividuals.map(g => gradeNames[g]).join(' ู')}`);
                }
            }

            if (selectedGrades.includes('high_all')) {
                 titles.push('ูููุฑุญูุฉ ุงูุซุงูููุฉ');
            } else {
                const highIndividuals = individualInSelection.filter(g => g.startsWith('h'));
                 if (highIndividuals.length > 0) {
                    titles.push(`ูู ${highIndividuals.map(g => gradeNames[g]).join(' ู')}`);
                }
            }
            
            stageTitleHeader.textContent = titles.join(' - ');
        }
        
        function clearAllFilters() {
            selectedGrades = [];
            updateButtonStyles();
            updateTitle();
            updateAllDateSelectors();
            saveState();
        }

        function clearGradeDates(programId, key) {
            const row = document.querySelector(`tr[data-program-id="${programId}"]`);
            if (row) {
                const display = row.querySelector(`.grade-date-selector[data-grade-key="${key}"] .dates-display`);
                if (display) {
                    display.textContent = '';
                    display.dataset.dates = '[]';
                }
                saveState();
            }
        }

        function openDatePicker(programId, key) {
            activeSelection = { programId, key };
            const row = document.querySelector(`tr[data-program-id="${programId}"]`);
            const programName = row.dataset.programName;
            const sessions = JSON.parse(row.dataset.sessions);
            
            const individualGradeKeys = gradeGroups[key] || [key];
            
            let totalRequiredSessions = 0;
            let label = gradeNames[key];
            
            totalRequiredSessions = Math.max(0, ...individualGradeKeys.map(g => sessions[g] || 0));
            
            if (key === 'primary_all') label = 'ุงููุฑุญูุฉ ุงูุงุจุชุฏุงุฆูุฉ';
            else if (key === 'primary_lower') label = 'ุงูุตููู ุงูุฃูููุฉ';
            else if (key === 'primary_upper') label = 'ุงูุตููู ุงูุนููุง';
            else if (key === 'middle_all') label = 'ุงููุฑุญูุฉ ุงููุชูุณุทุฉ';
            else if (key === 'high_all') label = 'ุงููุฑุญูุฉ ุงูุซุงูููุฉ';

            document.getElementById('modal-title').textContent = `${programName} - ${label}`;
            
            const displayDiv = row.querySelector(`.grade-date-selector[data-grade-key="${key}"] .dates-display`);
            tempSelectedDates = displayDiv.dataset.dates ? JSON.parse(displayDiv.dataset.dates) : [];

            updateDatePickerCounter(totalRequiredSessions);

            const container = document.getElementById('modal-weeks-container');
            container.innerHTML = '';

            Object.entries(weeksData).forEach(([weekKey, weekData]) => {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'p-2 border rounded-md';
                weekDiv.innerHTML = `<p class="font-semibold text-center mb-2">${weekData.name} (${weekData.startDate} - ${weekData.endDate})</p>`;
                
                const weekGrid = document.createElement('div');
                weekGrid.className = 'week-grid grid grid-cols-5 gap-2';
                
                Object.entries(weekData.days).forEach(([dayName, dayDate]) => {
                    const dayButton = document.createElement('button');
                    const fullDate = `${dayName} ${dayDate}`;
                    dayButton.className = 'day p-2 border rounded-md text-sm';
                    dayButton.dataset.date = fullDate;
                    
                    let buttonText = `${dayName}<br>${dayDate}`;
                    if (weekData.specialDays && weekData.specialDays[dayDate]) {
                        dayButton.classList.add('disabled');
                        dayButton.disabled = true;
                        buttonText += `<br><span class="text-xs">${weekData.specialDays[dayDate].name}</span>`;
                    } else {
                        dayButton.onclick = () => toggleDateSelection(dayButton, totalRequiredSessions);
                    }
                    
                    if (tempSelectedDates.includes(fullDate)) {
                        dayButton.classList.add('selected');
                    }
                    
                    dayButton.innerHTML = buttonText;
                    weekGrid.appendChild(dayButton);
                });
                weekDiv.appendChild(weekGrid);
                container.appendChild(weekDiv);
            });

            document.getElementById('date-picker-modal').style.display = 'flex';
        }

        function toggleDateSelection(button, totalMaxDates) {
            const date = button.dataset.date;
            const isSelected = tempSelectedDates.includes(date);

            if (isSelected) {
                tempSelectedDates = tempSelectedDates.filter(d => d !== date);
                button.classList.remove('selected');
            } else {
                if (tempSelectedDates.length >= totalMaxDates) {
                    alert(`ููุฏ ูุตูุช ููุญุฏ ุงูุฃูุตู ูุนุฏุฏ ุงูุญุตุต ููุฐุง ุงูุจุฑูุงูุฌ (${totalMaxDates} ุชูุงุฑูุฎ).`);
                    return;
                }
                tempSelectedDates.push(date);
                button.classList.add('selected');
            }
            updateDatePickerCounter(totalMaxDates);
        }

        function updateDatePickerCounter(max) {
            const counterEl = document.getElementById('modal-date-counter');
            if (counterEl) {
                counterEl.textContent = `ุงุฎุชุฑ ${max} ุญุตุต (ุชู ุงุฎุชูุงุฑ ${tempSelectedDates.length})`;
            }
        }

        function closeDatePicker() {
            document.getElementById('date-picker-modal').style.display = 'none';
            activeSelection = null;
            tempSelectedDates = [];
        }

        function saveDates() {
            if (!activeSelection) return;
            const { programId, key } = activeSelection;
            const row = document.querySelector(`tr[data-program-id="${programId}"]`);
            const datesDisplay = row.querySelector(`.grade-date-selector[data-grade-key="${key}"] .dates-display`);
            if (datesDisplay) {
                const formatted = formatDatesForDisplay(tempSelectedDates);
                datesDisplay.textContent = formatted.text;
                datesDisplay.dataset.dates = formatted.json;
            }
            saveState();
            closeDatePicker();
        }
        
        // ===== START: REWRITTEN PRINT FUNCTION =====
        function printSchedule() {
            if (isPrinting) {
                alert('ุนูููุฉ ุทุจุงุนุฉ ุฌุงุฑูุฉ ุจุงููุนู. ูุฑุฌู ุงูุงูุชุธุงุฑ.');
                return;
            }
            isPrinting = true;

            const state = JSON.parse(localStorage.getItem('activityPlanState')) || {};
            if (!state) {
                alert('ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญููุธุฉ ููุทุจุงุนุฉ.');
                isPrinting = false;
                return;
            }

            const programSelections = state.programSelections || {};
            const effectiveGradesForPrint = getEffectiveIndividualGrades();
            if (effectiveGradesForPrint.length === 0) {
                 alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงููุตูู ุงูุฏุฑุงุณูุฉ ุฃููุงู ูุจู ุงูุทุจุงุนุฉ.');
                 isPrinting = false;
                 return;
            }

            const plannedPrograms = Object.entries(programSelections)
                .map(([id, data]) => {
                    const row = document.querySelector(`tr[data-program-id="${id}"]`);
                    if (!row) return null;
                    return {
                        id,
                        field: row.dataset.fieldName,
                        program: row.dataset.programName,
                        teachers: data.teachersByGrade || {},
                        datesByGrade: data.datesByGrade || {},
                        color: row.dataset.fieldColor,
                        sessionsData: JSON.parse(row.dataset.sessions),
                    };
                }).filter(p => p);

            if (plannedPrograms.length === 0) {
                alert('ูุฑุฌู ุชุญุฏูุฏ ุชูุงุฑูุฎ ุฃู ูุนูููู ูุจุฑูุงูุฌ ูุงุญุฏ ุนูู ุงูุฃูู ูุจู ุงูุทุจุงุนุฉ.');
                isPrinting = false;
                return;
            }

            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('ูุดู ูุชุญ ูุงูุฐุฉ ุงูุทุจุงุนุฉ. ูุฑุฌู ุงูุณูุงุญ ุจุงูููุงูุฐ ุงูููุจุซูุฉ ููุฐุง ุงููููุน.');
                isPrinting = false;
                return;
            }

            const programsByField = {};
            plannedPrograms.forEach(p => {
                if (!programsByField[p.field]) {
                    programsByField[p.field] = [];
                }
                programsByField[p.field].push(p);
            });

            const activeFields = activitiesData
                .map(field => field.title)
                .filter(title => programsByField[title] && programsByField[title].length > 0);

            let printContent = '<div class="print-grid">';
            activeFields.forEach(fieldName => {
                const fieldData = activitiesData.find(f => f.title === fieldName);
                let tableRows = '';

                programsByField[fieldName].forEach(p => {
                    const teacherEntries = [];
                    const dateEntries = [];
                    const sessionDetailsParts = [];

                    const displayKeys = selectedGrades.includes('all') 
                        ? ['primary_lower', 'primary_upper', 'middle_all', 'high_all'] 
                        : [...selectedGrades];

                    displayKeys.forEach(key => {
                        const individualGradesInGroup = gradeGroups[key] || [key];
                        const isRelevant = individualGradesInGroup.some(g => effectiveGradesForPrint.includes(g) && p.sessionsData[g]);
                        if (!isRelevant) return;
                        
                        let label;
                        switch (key) {
                            case 'primary_lower': label = 'ุงูุตููู ุงูุฃูููุฉ'; break;
                            case 'primary_upper': label = 'ุงูุตููู ุงูุนููุง'; break;
                            case 'middle_all': label = 'ุงููุฑุญูุฉ ุงููุชูุณุทุฉ'; break;
                            case 'high_all': label = 'ุงููุฑุญูุฉ ุงูุซุงูููุฉ'; break;
                            default: label = gradeNames[key];
                        }

                        const teacherName = p.teachers[key];
                        if (teacherName) {
                            teacherEntries.push(`<div class="stage-entry"><strong>${label}:</strong> ${teacherName.replace(/\n/g, '<br>')}</div>`);
                        }

                        const dates = p.datesByGrade[key];
                        if (dates && dates.length > 0) {
                            const formattedDatesString = formatDatesForDisplay(dates).text;
                            dateEntries.push(`<div class="stage-entry"><strong>${label}:</strong> ${formattedDatesString}</div>`);
                        }

                        const sessionCount = Math.max(0, ...individualGradesInGroup.map(g => p.sessionsData[g] || 0));
                        if(sessionCount > 0){
                            sessionDetailsParts.push(`${label}: ${sessionCount}`);
                        }
                    });

                    if (teacherEntries.length === 0 && dateEntries.length === 0) {
                        return;
                    }

                    const sessionDetails = sessionDetailsParts.join('ุ ');
                    const formattedTeachersString = teacherEntries.join('') || 'ุบูุฑ ูุญุฏุฏ';
                    const formattedDatesString = dateEntries.join('') || 'ุบูุฑ ูุญุฏุฏุฉ';

                    tableRows += `
                    <tr>
                        <td>${p.program}<br><small style="color: #555; font-weight: normal;">(${sessionDetails})</small></td>
                        <td>${formattedTeachersString}</td>
                        <td>${formattedDatesString}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>`;
                });
                
                if (tableRows.trim() === '') {
                     return; 
                }

                printContent += '<div class="print-column">';
                printContent += `<h3 style="background-color:${fieldData.color}; color:white;">${fieldName}</h3>`;
                printContent += `
                    <table>
                        <thead>
                            <tr>
                                <th>ุงูุจุฑูุงูุฌ</th>
                                <th>ุงููุนูู/ุฉ</th>
                                <th>ุชุงุฑูุฎ ุงูุชูููุฐ</th>
                                <th>ููุฐ</th>
                                <th>ูู ูููุฐ</th>
                                <th>ุงูุชูููุน</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>`;
                printContent += '</div>';
            });
            printContent += '</div>';

            if (printContent === '<div class="print-grid"></div>') {
                alert('ูุง ุชูุฌุฏ ุจุฑุงูุฌ ูุญุฏุฏุฉ ูููุตูู ุงููุฎุชุงุฑุฉ. ูุฑุฌู ุชุญุฏูุฏ ุชูุงุฑูุฎ ุฃู ูุนูููู ููุจุฑุงูุฌ ูู ุงููุตูู ุงูุชู ุงุฎุชุฑุชูุง.');
                isPrinting = false;
                printWindow.close();
                return;
            }
            
            const printStageTitle = document.getElementById('stage-title-header').textContent || 'ูุฌููุน ุงููุฑุงุญู ุงูุฏุฑุงุณูุฉ';
            const printSemesterSubtitle = document.getElementById('subtitle').textContent;
            const eduAdmin = state.educationAdmin || '';
            const eduRegion = state.educationRegion || '';
            const schoolName = state.schoolName || '';
            const leaderName = state.activityLeaderName || 'ุฑุงุฆุฏ/ุฉ ุงููุดุงุท';
            const directorName = state.schoolDirectorName || 'ูุฏูุฑ/ุฉ ุงููุฏุฑุณุฉ';
            const printFontSize = document.getElementById('print-font-size').value;

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>ุฎุทุฉ ุงููุดุงุท ุงูุทูุงุจู ูู ${schoolName}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
                        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                        @page { size: A4 landscape; margin: 10mm 5mm; }
                        html, body { margin: 0; padding: 0; }
                        body { font-family: 'Cairo', sans-serif; font-size: ${printFontSize}; }
                        
                        .page-container { display: flex; flex-direction: column; min-height: 98vh; }
                        .print-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-shrink: 0; }
                        .print-header .right-side { display: flex; align-items: center; gap: 8px; }
                        .print-header img { height: 40px; }
                        .print-header .header-text p { margin: 0; font-size: 0.9em; line-height: 1.2; }
                        .print-header .title-container { text-align: center; }
                        .print-header h1 { color: #00A383; margin: 0; font-size: 1.8em; }
                        .print-header h2 { font-size: 1.6em; font-weight: bold; color: #0093B5; margin: 1px 0; }
                        .print-header p.subtitle { color: #555; margin-top: 2px; font-size: 1.1em; }
                        .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; flex-grow: 1; align-content: start; }
                        .print-column { page-break-inside: avoid; break-inside: avoid; }
                        .print-column h3 { font-size: 1.2em; padding: 3px 5px; border-radius: 4px 4px 0 0; margin: 0; color: white; }
                        table { width: 100%; border-collapse: collapse; font-size: 1em; }
                        th, td { border: 1px solid #ccc; padding: 3px; text-align: right; vertical-align: top; word-wrap: break-word; font-weight: normal; }
                        .stage-entry:not(:last-child) { border-bottom: 1px dashed #ccc; padding-bottom: 3px; margin-bottom: 3px; }
                        strong { font-weight: bold; }
                        th { background-color: #f2f2f2; font-weight: bold; vertical-align: middle; }
                        table th:nth-child(1), table td:nth-child(1) { width: 28%; }
                        table th:nth-child(2), table td:nth-child(2) { width: 22%; }
                        table th:nth-child(3), table td:nth-child(3) { width: 32%; }
                        table th:nth-child(4), table td:nth-child(4),
                        table th:nth-child(5), table td:nth-child(5),
                        table th:nth-child(6), table td:nth-child(6) { width: 6%; text-align: center; }
                        .print-signatures { display: flex; justify-content: space-around; margin-top: auto; padding-top: 15px; font-size: 1.1em; font-weight: bold; flex-shrink: 0; page-break-inside: avoid;}
                        .signature-box { text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="page-container">
                         <div class="print-header">
                            <div class="right-side">
                                <img src="https://salogos.org/wp-content/uploads/2021/11/UntiTtled-1-1300x988.png" alt="ุดุนุงุฑ ุงููุฒุงุฑุฉ">
                                <div class="header-text">
                                    <p>${eduAdmin}</p><p>${eduRegion}</p><p>${schoolName}</p>
                                </div>
                            </div>
                            <div class="title-container">
                                <h1>ุฎุทุฉ ุงููุดุงุท ุงูุทูุงุจู</h1>
                                <h2>${printStageTitle}</h2>
                                <p class="subtitle">${printSemesterSubtitle}</p>
                            </div>
                            <div></div> 
                        </div>

                        ${printContent}

                        <div class="print-signatures">
                            <div class="signature-box"><p>${leaderName}</p></div>
                            <div class="signature-box"><p>${directorName}</p></div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            printWindow.onafterprint = function() {
                printWindow.close();
                isPrinting = false; 
            };

            setTimeout(() => {
                try {
                    printWindow.print();
                } catch (e) {
                    console.error("Print failed:", e);
                    isPrinting = false; 
                    printWindow.close();
                }
            }, 500);
        }
        // ===== END: REWRITTEN PRINT FUNCTION =====

        function saveBackup() {
            saveState(); // Ensure current state is saved before backup
            const stateToSave = localStorage.getItem('activityPlanState');
            if (!stateToSave || stateToSave === "{}") {
                alert('ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญููุธุฉ ูุญูุธูุง.');
                return;
            }
            const blob = new Blob([stateToSave], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const schoolName = JSON.parse(stateToSave).schoolName || 'ุฎุทุฉ-ุงููุดุงุท';
            a.href = url;
            a.download = `backup-${schoolName}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedState = e.target.result;
                    const parsedState = JSON.parse(loadedState);
                    if (parsedState && typeof parsedState === 'object' && 'programSelections' in parsedState) {
                        localStorage.setItem('activityPlanState', loadedState);
                        alert('ุชู ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ! ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุชุทุจูู ุงูุชุบููุฑุงุช.');
                        location.reload();
                    } else {
                        throw new Error('Invalid file structure.');
                    }
                } catch (error) {
                    alert('ููู ุบูุฑ ุตุงูุญ ุฃู ุชุงูู. ูุฑุฌู ุงุฎุชูุงุฑ ููู ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุตุญูุญ ุชู ุฅูุดุงุคู ูู ูุฐู ุงูุตูุญุฉ.');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }
        
        function saveState() {
            if (isLoading) return;

            const programSelections = {};
            document.querySelectorAll('main tr[data-program-id]').forEach(row => {
                const id = row.dataset.programId;
                const datesByGrade = {};
                const teachersByGrade = {};
                let hasData = false;

                row.querySelectorAll('.teacher-input').forEach(input => {
                    const key = input.dataset.gradeKey;
                    if (input.value.trim() !== '') {
                        teachersByGrade[key] = input.value.trim();
                        hasData = true;
                    }
                });

                row.querySelectorAll('.grade-date-selector').forEach(selector => {
                    const key = selector.dataset.gradeKey;
                    const displayDiv = selector.querySelector('.dates-display');
                    const datesJson = displayDiv.dataset.dates;
                    
                    if (datesJson) {
                        const dates = JSON.parse(datesJson);
                        if (dates.length > 0) {
                            const groupOrGradeKey = selector.dataset.gradeKey;
                            
                            if(gradeGroups[groupOrGradeKey]) {
                                // This is a group selector, save dates under the group key
                                datesByGrade[groupOrGradeKey] = dates;
                            } else {
                                // This is an individual grade selector
                                datesByGrade[groupOrGradeKey] = dates;
                            }
                            
                            // Also save for individual grades for filtering logic
                            const individualKeys = gradeGroups[key] || [key];
                             individualKeys.forEach(indKey => {
                                datesByGrade[indKey] = dates;
                            });
                            hasData = true;
                        }
                    }
                });

                if (hasData) {
                   programSelections[id] = { teachersByGrade, datesByGrade };
                }
            });

            const state = {
                educationAdmin: document.getElementById('education-admin').value,
                educationRegion: document.getElementById('education-region').value,
                schoolName: document.getElementById('school-name').value,
                activityLeaderName: document.getElementById('activity-leader-name').value,
                schoolDirectorName: document.getElementById('school-director-name').value,
                currentRegion: currentRegion,
                selectedGrades: selectedGrades,
                programSelections: programSelections,
                printFontSize: document.getElementById('print-font-size').value,
            };
            localStorage.setItem('activityPlanState', JSON.stringify(state));
        }

        function loadState() {
            isLoading = true;
            const savedState = localStorage.getItem('activityPlanState');
            if (!savedState) {
                isLoading = false;
                return;
            }
            
            const state = JSON.parse(savedState);
            
            document.getElementById('education-admin').value = state.educationAdmin || '';
            document.getElementById('education-region').value = state.educationRegion || '';
            document.getElementById('school-name').value = state.schoolName || '';
            document.getElementById('activity-leader-name').value = state.activityLeaderName || '';
            document.getElementById('school-director-name').value = state.schoolDirectorName || '';
            document.getElementById('print-font-size').value = state.printFontSize || '8px';

            selectRegion(state.currentRegion || 'other');
            
            selectedGrades = state.selectedGrades || [];
            
            updateButtonStyles();
            updateTitle();
            updateAllDateSelectors();

             if (state.programSelections) {
                Object.entries(state.programSelections).forEach(([id, data]) => {
                    const row = document.querySelector(`tr[data-program-id="${id}"]`);
                    if (row) {
                         if (data.teachersByGrade) {
                            Object.entries(data.teachersByGrade).forEach(([gradeKey, teacherName]) => {
                                const input = row.querySelector(`.teacher-input[data-grade-key="${gradeKey}"]`);
                                if (input) {
                                    input.value = teacherName;
                                }
                            });
                        }
                        
                        if (data.datesByGrade) {
                            row.querySelectorAll('.grade-date-selector').forEach(selector => {
                                const key = selector.dataset.gradeKey;
                                // Prioritize loading from group key, then fall back to individual
                                let datesToShow = data.datesByGrade[key] || data.datesByGrade[(gradeGroups[key] || [key])[0]] || [];
                               
                                const displayDiv = selector.querySelector('.dates-display');
                                const formatted = formatDatesForDisplay(datesToShow);
                                displayDiv.textContent = formatted.text;
                                displayDiv.dataset.dates = formatted.json;
                            });
                        }
                    }
                });
            }
            isLoading = false;
        }

        function resetPlan() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                    <h3 class="text-xl font-bold mb-4">ุชุฃููุฏ ุงููุณุญ</h3>
                    <p class="text-gray-600 mb-6">ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ูุณุญ ุฌููุน ุงูุจูุงูุงุช ูุงูุจุฏุก ูู ุฌุฏูุฏุ ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู.</p>
                    <div class="flex justify-center gap-4">
                        <button onclick="document.body.removeChild(this.closest('.fixed'));" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 font-semibold">ุฅูุบุงุก</button>
                        <button onclick="localStorage.removeItem('activityPlanState'); location.reload();" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">ูุนูุ ูุณุญ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showUpdateModal() {
            const modal = document.getElementById('update-modal');
            const modalBox = document.getElementById('update-modal-box');
            modal.style.display = 'flex';
            setTimeout(() => {
                modalBox.classList.add('active');
            }, 50); 
        }

        function closeUpdateModal() {
            const modal = document.getElementById('update-modal');
            const modalBox = document.getElementById('update-modal-box');
            modalBox.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
            localStorage.setItem(UPDATE_VERSION_KEY, 'true');
        }

        document.addEventListener('DOMContentLoaded', function() {
            createGradeSelectionUI();
            generateSections();
            loadState();
            if (!localStorage.getItem(UPDATE_VERSION_KEY)) {
                showUpdateModal();
            }
        });
    </script>
</body>
</html>

