<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ููุน ุชุญููู ุงูุฃุฑูุงู ูุงูุชูุงุฑูุฎ ูุฑูุงุจุท ูู ุงูุฌูุงู (ููู ุฌุฏุงู ููุงูููู) -->
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no, url=no">
    <title>ุฎุทุฉ ุงููุดุงุท ุงูุทูุงุจู - ุงูุฅุตุฏุงุฑ ุงูููุณู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ููุชุจุงุช ูุนุงูุฌุฉ ุงููููุงุช -->
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Readex+Pro:wght@300;400;600;700&display=swap');
        @import url('https://fonts.com/css2?family=Changa:wght@400;700&display=swap');

        :root { --main-font: 'Cairo', sans-serif; }
        body { font-family: var(--main-font); }

        .gradient-header { background: linear-gradient(135deg, #00A383 0%, #0093B5 100%); }
        .dropdown-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .dropdown-content.active { max-height: 5000px; transition: max-height 0.5s ease-in; }
        .rotate-arrow { transform: rotate(180deg); transition: transform 0.3s ease; }
        .header-input { background-color: transparent; border: none; color: white; width: 100%; text-align: right; outline: none; }
        .header-input::placeholder { color: rgba(255, 255, 255, 0.8); opacity: 1; }

        /* ุชูุณูู ุงูุนูุงููู ุงููุงุจูุฉ ููุชุนุฏูู */
        .editable-title {
            background: transparent;
            border: none;
            color: white;
            text-align: center;
            width: 100%;
            outline: none;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
        }
        
        #main-title-input { font-size: 1.5rem; margin-bottom: 0.2rem; }
        #stage-title-input { font-size: 1.2rem; margin-bottom: 0.2rem; opacity: 0.95; }
        #stage-title-input::placeholder { color: rgba(255, 255, 255, 0.7); }

        @media (min-width: 640px) {
            #main-title-input { font-size: 1.875rem; }
            #stage-title-input { font-size: 1.5rem; }
        }

        #date-picker-modal .week-grid .day.selected { background-color: #10B981; color: white; border-color: #059669; }
        #date-picker-modal .week-grid .day.disabled { background-color: #F3F4F6; color: #9CA3AF; cursor: not-allowed; }
        .tab-btn { padding: 10px; width: 50%; text-align: center; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; background-color: #f9fafb; transition: all 0.3s ease; }
        .tab-btn.active { border-bottom-color: #00A383; color: #00A383; background-color: #fff; }
        #update-modal-box { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
        #update-modal-box.active { transform: scale(1); opacity: 1; }
        
        /* ุฑุณุงูุฉ ุงููุณุฎ */
        #copy-toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 9999; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 17px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        #copy-toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div class="bg-blue-600 text-white text-center py-2 no-print font-semibold">
ุชู ุงูุชุญุฏูุซ ุจุชุงุฑูุฎ ูฉ / ูจ / ูกูคูคูง ูู    </div>

    <div id="copy-toast">ุชู ูุณุฎ ุงูุฌุฏูู! ุงูุชุญ ุชุทุจูู Word ูุงูุตูู ููุงู.</div>

    <div id="date-picker-modal" class="fixed inset-0 z-40 items-center justify-center p-4 no-print bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-4xl w-full h-[85vh] flex flex-col">
            <h3 id="modal-title" class="text-xl font-bold mb-4 flex-shrink-0">ุงุฎุชุฑ ุชูุงุฑูุฎ ุงูุชูููุฐ</h3>
            <div class="flex gap-0 border-b-2 border-gray-200 mb-4 flex-shrink-0 bg-gray-50 rounded-t-lg overflow-hidden">
                <div onclick="switchSemesterTab(1)" id="tab-sem-1" class="tab-btn active">ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู</div>
                <div onclick="switchSemesterTab(2)" id="tab-sem-2" class="tab-btn">ุงููุตู ุงูุฏุฑุงุณู ุงูุซุงูู</div>
            </div>
            <p id="modal-date-counter" class="text-center text-gray-600 mb-2 font-semibold flex-shrink-0"></p>
            <div id="modal-weeks-container" class="space-y-4 overflow-y-auto flex-grow px-2"></div>
            <div class="mt-4 flex justify-end gap-3 flex-shrink-0 pt-3 border-t">
                <button onclick="closeDatePicker()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">ุฅูุบุงุก</button>
                <button onclick="saveDates()" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">ุญูุธ ุงูุชูุงุฑูุฎ</button>
            </div>
        </div>
    </div>

    <div id="main-content" class="transition-opacity duration-500">
        <header class="gradient-header text-white py-4 shadow-lg no-print">
            <div class="container mx-auto px-6 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <img src="https://upload.wikimedia.org/wikipedia/ar/thumb/1/17/Saudi_Ministry_of_Education_Logo_2025.png/400px-Saudi_Ministry_of_Education_Logo_2025.png" alt="ุดุนุงุฑ ุงููุฒุงุฑุฉ" class="h-16 sm:h-20">
                    <div class="flex flex-col gap-0 w-full max-w-xs sm:max-w-sm">
                        <input type="text" id="education-admin" placeholder="ุฃุฏุฎู ุงูุฅุฏุงุฑุฉ ุงูุชุนููููุฉ" class="header-input text-sm font-semibold" oninput="saveState()">
                        <input type="text" id="education-region" placeholder="ุฃุฏุฎู ุงูููุทูุฉ ุงูุชุนููููุฉ" class="header-input text-sm font-semibold" oninput="saveState()">
                        <input type="text" id="school-name" placeholder="ุฃุฏุฎู ุงุณู ุงููุฏุฑุณุฉ" class="header-input text-sm font-semibold" oninput="saveState()">
                    </div>
                </div>
                <div class="text-center flex flex-col items-center w-full max-w-lg">
                    <input type="text" id="main-title-input" value="ุฎุทุฉ ุงููุดุงุท ุงูุทูุงุจู" class="editable-title" oninput="saveState()">
                    <input type="text" id="stage-title-input" placeholder="ุงูุชุจ ุงุณู ุงููุฑุญูุฉ ููุง" class="editable-title" oninput="saveState()">
                    <p id="subtitle" class="text-md sm:text-lg opacity-90 mt-1">ุงูุนุงู ุงูุฏุฑุงุณู 1447ูู</p>
                </div>
            </div>
        </header>

        <section class="py-8 bg-gray-50 no-print">
            <div class="container mx-auto px-6">
                <div class="mb-8 p-6 bg-white rounded-lg shadow-md">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start text-center">
                        <div class="grid grid-cols-1 gap-6">
                             <div>
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">ุงุฎุชุฑ ุงูููุทูุฉ:</h3>
                                <div class="flex justify-center gap-3">
                                    <button onclick="selectRegion('other')" id="btn-other-region" class="px-4 py-2 rounded-full font-medium transition-all duration-300 bg-blue-600 text-white shadow-lg">ุจุงูู ุงูููุงุทู</button>
                                    <button onclick="selectRegion('western')" id="btn-western-region" class="px-4 py-2 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700">ุงูููุทูุฉ ุงูุบุฑุจูุฉ</button>
                                </div>
                            </div>
                            <div class="flex flex-col items-center">
                                <h3 class="text-xl font-semibold text-gray-700 mb-4">ุญุฌู ุงูุฎุท ููุทุจุงุนุฉ:</h3>
                                <select id="print-font-size" class="p-2 border rounded-md" onchange="saveState()">
                                    <option value="7px">ุตุบูุฑ ุฌุฏุงู</option>
                                    <option value="8px" selected>ุตุบูุฑ (ุงูุชุฑุงุถู)</option>
                                    <option value="10px">ูุชูุณุท</option>
                                    <option value="12px">ูุจูุฑ</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">ุงุฎุชุฑ ุงููุตูู ุงูุฏุฑุงุณูุฉ:</h3>
                            <div id="grade-selection-container" class="flex flex-col items-center gap-4"></div>
                        </div>
                    </div>
                    <div class="mt-8 flex gap-4 justify-center flex-wrap">
                        <button onclick="clearAllFilters()" class="text-sm text-gray-500 hover:text-gray-700 underline">ุฅูุบุงุก ุงุฎุชูุงุฑ ุงููุตูู</button>
                        <button onclick="printSchedule()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">๐จ๏ธ ุทุจุงุนุฉ ุงูุฌุฏูู</button>
                        <button onclick="copyToClipboard()" class="px-4 py-2 bg-purple-700 text-white rounded-lg hover:bg-purple-800 transition-colors text-sm font-bold flex items-center gap-2"><span>๐</span> ูุณุฎ (ููุขูููู)</button>
                        <button onclick="exportToWord()" class="px-4 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-900 transition-colors text-sm font-bold flex items-center gap-2"><span>๐</span> ุชุตุฏูุฑ Word</button>
                        <button onclick="saveBackup()" class="px-4 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 transition-colors text-sm">๐พ ุญูุธ ูุณุฎุฉ</button>
                        <button onclick="document.getElementById('backup-input').click()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors text-sm">๐ ุงุณุชุนุงุฏุฉ</button>
                        <input type="file" id="backup-input" class="hidden" accept=".json" onchange="handleFileUpload(event)">
                        <button onclick="resetPlan()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">๐ ูุณุญ</button>
                    </div>
                </div>
            </div>
        </section>

        <main class="container mx-auto px-6 py-8">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">ุชูุงุตูู ุงูุฎุทุฉ</h2>
        </main>
            
        <div class="container mx-auto px-6 py-4 no-print">
            <div class="flex justify-between items-center gap-8">
                <input type="text" id="activity-leader-name" placeholder="ุฃุฏุฎู ุงุณู ุฑุงุฆุฏ/ุฉ ุงููุดุงุท" class="w-1/2 p-2 text-center bg-transparent border-b-2 border-gray-300 focus:border-teal-500 outline-none" oninput="saveState()">
                <input type="text" id="school-director-name" placeholder="ุฃุฏุฎู ุงุณู ูุฏูุฑ/ุฉ ุงููุฏุฑุณุฉ" class="w-1/2 p-2 text-center bg-transparent border-b-2 border-gray-300 focus:border-teal-500 outline-none" oninput="saveState()">
            </div>
        </div>
    </div>

    <!-- ุญุงููุฉ ูุฎููุฉ ูููุณุฎ -->
    <div id="clipboard-container" style="position:absolute; left:-9999px; top:0;"></div>

    <script>
        // --- ุชููุฆุฉ ุงููุชุบูุฑุงุช ---
        let selectedGrades = [];
        let currentRegion = 'other';
        let activeSelection = null;
        let tempSelectedDates = [];
        let isPrinting = false;
        let isLoading = false;
        let currentModalSemester = 1;

        const gradeNames = { 'p1': 'ุฃูู ุงุจุชุฏุงุฆู', 'p2': 'ุซุงูู ุงุจุชุฏุงุฆู', 'p3': 'ุซุงูุซ ุงุจุชุฏุงุฆู', 'p4': 'ุฑุงุจุน ุงุจุชุฏุงุฆู', 'p5': 'ุฎุงูุณ ุงุจุชุฏุงุฆู', 'p6': 'ุณุงุฏุณ ุงุจุชุฏุงุฆู', 'm1': 'ุฃูู ูุชูุณุท', 'm2': 'ุซุงูู ูุชูุณุท', 'm3': 'ุซุงูุซ ูุชูุณุท', 'h1': 'ุฃูู ุซุงููู', 'h2': 'ุซุงูู ุซุงููู', 'h3': 'ุซุงูุซ ุซุงููู', 'quran_lower': 'ุฃูููุฉ ุชุญููุธ', 'quran_upper': 'ุนููุง ุชุญููุธ' };
        const gradeGroups = { 'primary_lower': ['p1', 'p2', 'p3'], 'primary_upper': ['p4', 'p5', 'p6'], 'quran_lower': ['quran_lower'], 'quran_upper': ['quran_upper'], 'primary_all': ['p1', 'p2', 'p3', 'p4', 'p5', 'p6', 'quran_lower', 'quran_upper'], 'quran_all': ['quran_lower', 'quran_upper'], 'middle_all': ['m1', 'm2', 'm3'], 'high_all': ['h1', 'h2', 'h3'] };
        const teacherInputGroups = { 'primary_lower': { label: 'ุฃูููุฉ', grades: ['p1', 'p2', 'p3'] }, 'primary_upper': { label: 'ุนููุง', grades: ['p4', 'p5', 'p6'] }, 'quran_lower': { label: 'ุฃูููุฉ ุชุญููุธ', grades: ['quran_lower'] }, 'quran_upper': { label: 'ุนููุง ุชุญููุธ', grades: ['quran_upper'] }, 'quran_all': { label: 'ุงุจุชุฏุงุฆูุฉ ุชุญููุธ', grades: ['quran_lower', 'quran_upper'] }, 'middle_all': { label: 'ูุชูุณุทุฉ', grades: ['m1', 'm2', 'm3'] }, 'high_all': { label: 'ุซุงูููุฉ', grades: ['h1', 'h2', 'h3'] }, 'all': { label: 'ูู ุงููุฑุงุญู', grades: Object.keys(gradeNames) } };
        const allGradeKeys = Object.keys(gradeNames);

        // --- ุจูุงูุงุช ุงูุฃุณุงุจูุน ---
        const weeksS1_Default = { 'week1': { name: 'ุงูุฃุณุจูุน ุงูุฃูู', semester: 1, startDate: '1 / 3', endDate: '5 / 3', days: { 'ุงูุฃุญุฏ': '1 / 3', 'ุงูุงุซููู': '2 / 3', 'ุงูุซูุงุซุงุก': '3 / 3', 'ุงูุฃุฑุจุนุงุก': '4 / 3', 'ุงูุฎููุณ': '5 / 3' } }, 'week2': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', semester: 1, startDate: '8 / 3', endDate: '12 / 3', days: { 'ุงูุฃุญุฏ': '8 / 3', 'ุงูุงุซููู': '9 / 3', 'ุงูุซูุงุซุงุก': '10 / 3', 'ุงูุฃุฑุจุนุงุก': '11 / 3', 'ุงูุฎููุณ': '12 / 3' } }, 'week3': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ', semester: 1, startDate: '15 / 3', endDate: '19 / 3', days: { 'ุงูุฃุญุฏ': '15 / 3', 'ุงูุงุซููู': '16 / 3', 'ุงูุซูุงุซุงุก': '17 / 3', 'ุงูุฃุฑุจุนุงุก': '18 / 3', 'ุงูุฎููุณ': '19 / 3' } }, 'week4': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน', semester: 1, startDate: '22 / 3', endDate: '26 / 3', days: { 'ุงูุฃุญุฏ': '22 / 3', 'ุงูุงุซููู': '23 / 3', 'ุงูุซูุงุซุงุก': '24 / 3', 'ุงูุฃุฑุจุนุงุก': '25 / 3', 'ุงูุฎููุณ': '26 / 3' } }, 'week5': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ', semester: 1, startDate: '29 / 3', endDate: '3 / 4', days: { 'ุงูุฃุญุฏ': '29 / 3', 'ุงูุงุซููู': '30 / 3', 'ุงูุซูุงุซุงุก': '1 / 4', 'ุงูุฃุฑุจุนุงุก': '2 / 4', 'ุงูุฎููุณ': '3 / 4' }, specialDays: { '1 / 4': { name: 'ุฅุฌุงุฒุฉ ุงูููู ุงููุทูู', type: 'occasion', color: 'green' } } }, 'week6': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ', semester: 1, startDate: '6 / 4', endDate: '10 / 4', days: { 'ุงูุฃุญุฏ': '6 / 4', 'ุงูุงุซููู': '7 / 4', 'ุงูุซูุงุซุงุก': '8 / 4', 'ุงูุฃุฑุจุนุงุก': '9 / 4', 'ุงูุฎููุณ': '10 / 4' } }, 'week7': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน', semester: 1, startDate: '13 / 4', endDate: '17 / 4', days: { 'ุงูุฃุญุฏ': '13 / 4', 'ุงูุงุซููู': '14 / 4', 'ุงูุซูุงุซุงุก': '15 / 4', 'ุงูุฃุฑุจุนุงุก': '16 / 4', 'ุงูุฎููุณ': '17 / 4' } }, 'week8': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', semester: 1, startDate: '20 / 4', endDate: '24 / 4', days: { 'ุงูุฃุญุฏ': '20 / 4', 'ุงูุงุซููู': '21 / 4', 'ุงูุซูุงุซุงุก': '22 / 4', 'ุงูุฃุฑุจุนุงุก': '23 / 4', 'ุงูุฎููุณ': '24 / 4' }, specialDays: { '20 / 4': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', type: 'holiday', color: 'red' } } }, 'week9': { name: 'ุงูุฃุณุจูุน ุงูุชุงุณุน', semester: 1, startDate: '27 / 4', endDate: '1 / 5', days: { 'ุงูุฃุญุฏ': '27 / 4', 'ุงูุงุซููู': '28 / 4', 'ุงูุซูุงุซุงุก': '29 / 4', 'ุงูุฃุฑุจุนุงุก': '30 / 4', 'ุงูุฎููุณ': '1 / 5' } }, 'week10': { name: 'ุงูุฃุณุจูุน ุงูุนุงุดุฑ', semester: 1, startDate: '4 / 5', endDate: '8 / 5', days: { 'ุงูุฃุญุฏ': '4 / 5', 'ุงูุงุซููู': '5 / 5', 'ุงูุซูุงุซุงุก': '6 / 5', 'ุงูุฃุฑุจุนุงุก': '7 / 5', 'ุงูุฎููุณ': '8 / 5' } }, 'week11': { name: 'ุงูุฃุณุจูุน ุงูุญุงุฏู ุนุดุฑ', semester: 1, startDate: '11 / 5', endDate: '15 / 5', days: { 'ุงูุฃุญุฏ': '11 / 5', 'ุงูุงุซููู': '12 / 5', 'ุงูุซูุงุซุงุก': '13 / 5', 'ุงูุฃุฑุจุนุงุก': '14 / 5', 'ุงูุฎููุณ': '15 / 5' } }, 'week12': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ', semester: 1, startDate: '18 / 5', endDate: '22 / 5', days: { 'ุงูุฃุญุฏ': '18 / 5', 'ุงูุงุซููู': '19 / 5', 'ุงูุซูุงุซุงุก': '20 / 5', 'ุงูุฃุฑุจุนุงุก': '21 / 5', 'ุงูุฎููุณ': '22 / 5' } }, 'week13': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ ุนุดุฑ', semester: 1, startDate: '25 / 5', endDate: '29 / 5', days: { 'ุงูุฃุญุฏ': '25 / 5', 'ุงูุงุซููู': '26 / 5', 'ุงูุซูุงุซุงุก': '27 / 5', 'ุงูุฃุฑุจุนุงุก': '28 / 5', 'ุงูุฎููุณ': '29 / 5' } }, 'autumn_break': { name: 'ุฅุฌุงุฒุฉ ุงูุฎุฑูู', semester: 1, startDate: '30 / 5', endDate: '8 / 6', days: {} }, 'week14': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน ุนุดุฑ', semester: 1, startDate: '9 / 6', endDate: '13 / 6', days: { 'ุงูุฃุญุฏ': '9 / 6', 'ุงูุงุซููู': '10 / 6', 'ุงูุซูุงุซุงุก': '11 / 6', 'ุงูุฃุฑุจุนุงุก': '12 / 6', 'ุงูุฎููุณ': '13 / 6' } }, 'week15': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ ุนุดุฑ', semester: 1, startDate: '16 / 6', endDate: '20 / 6', days: { 'ุงูุฃุญุฏ': '16 / 6', 'ุงูุงุซููู': '17 / 6', 'ุงูุซูุงุซุงุก': '18 / 6', 'ุงูุฃุฑุจุนุงุก': '19 / 6', 'ุงูุฎููุณ': '20 / 6' }, specialDays: { '20 / 6': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', type: 'holiday', color: 'red' } } }, 'week16': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ ุนุดุฑ', semester: 1, startDate: '23 / 6', endDate: '27 / 6', days: { 'ุงูุฃุญุฏ': '23 / 6', 'ุงูุงุซููู': '24 / 6', 'ุงูุซูุงุซุงุก': '25 / 6', 'ุงูุฃุฑุจุนุงุก': '26 / 6', 'ุงูุฎููุณ': '27 / 6' }, specialDays: { '23 / 6': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', type: 'holiday', color: 'red' } } }, 'week17': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน ุนุดุฑ', semester: 1, startDate: '1 / 7', endDate: '5 / 7', days: { 'ุงูุฃุญุฏ': '1 / 7', 'ุงูุงุซููู': '2 / 7', 'ุงูุซูุงุซุงุก': '3 / 7', 'ุงูุฃุฑุจุนุงุก': '4 / 7', 'ุงูุฎููุณ': '5 / 7' } }, 'week18': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ', semester: 1, startDate: '8 / 7', endDate: '12 / 7', days: { 'ุงูุฃุญุฏ': '8 / 7', 'ุงูุงุซููู': '9 / 7', 'ุงูุซูุงุซุงุก': '10 / 7', 'ุงูุฃุฑุจุนุงุก': '11 / 7', 'ุงูุฎููุณ': '12 / 7' } }, 'exams': { name: 'ุงูุงุฎุชุจุงุฑุงุช', semester: 1, startDate: '15 / 7', endDate: '19 / 7', days: {} } };
        const weeksS1_Western = { 'week1': { name: 'ุงูุฃุณุจูุน ุงูุฃูู', semester: 1, startDate: '8 / 3', endDate: '12 / 3', days: { 'ุงูุฃุญุฏ': '8 / 3', 'ุงูุงุซููู': '9 / 3', 'ุงูุซูุงุซุงุก': '10 / 3', 'ุงูุฃุฑุจุนุงุก': '11 / 3', 'ุงูุฎููุณ': '12 / 3' } }, 'week2': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', semester: 1, startDate: '15 / 3', endDate: '19 / 3', days: { 'ุงูุฃุญุฏ': '15 / 3', 'ุงูุงุซููู': '16 / 3', 'ุงูุซูุงุซุงุก': '17 / 3', 'ุงูุฃุฑุจุนุงุก': '18 / 3', 'ุงูุฎููุณ': '19 / 3' } }, 'week3': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ', semester: 1, startDate: '22 / 3', endDate: '26 / 3', days: { 'ุงูุฃุญุฏ': '22 / 3', 'ุงูุงุซููู': '23 / 3', 'ุงูุซูุงุซุงุก': '24 / 3', 'ุงูุฃุฑุจุนุงุก': '25 / 3', 'ุงูุฎููุณ': '26 / 3' } }, 'week4': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน', semester: 1, startDate: '29 / 3', endDate: '3 / 4', days: { 'ุงูุฃุญุฏ': '29 / 3', 'ุงูุงุซููู': '30 / 3', 'ุงูุซูุงุซุงุก': '1 / 4', 'ุงูุฃุฑุจุนุงุก': '2 / 4', 'ุงูุฎููุณ': '3 / 4' }, specialDays: { '1 / 4': { name: 'ุฅุฌุงุฒุฉ ุงูููู ุงููุทูู', type: 'occasion', color: 'green' } } }, 'week5': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ', semester: 1, startDate: '6 / 4', endDate: '10 / 4', days: { 'ุงูุฃุญุฏ': '6 / 4', 'ุงูุงุซููู': '7 / 4', 'ุงูุซูุงุซุงุก': '8 / 4', 'ุงูุฃุฑุจุนุงุก': '9 / 4', 'ุงูุฎููุณ': '10 / 4' } }, 'week6': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ', semester: 1, startDate: '13 / 4', endDate: '17 / 4', days: { 'ุงูุฃุญุฏ': '13 / 4', 'ุงูุงุซููู': '14 / 4', 'ุงูุซูุงุซุงุก': '15 / 4', 'ุงูุฃุฑุจุนุงุก': '16 / 4', 'ุงูุฎููุณ': '17 / 4' } }, 'week7': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน', semester: 1, startDate: '20 / 4', endDate: '24 / 4', days: { 'ุงูุฃุญุฏ': '20 / 4', 'ุงูุงุซููู': '21 / 4', 'ุงูุซูุงุซุงุก': '22 / 4', 'ุงูุฃุฑุจุนุงุก': '23 / 4', 'ุงูุฎููุณ': '24 / 4' }, specialDays: { '20 / 4': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', type: 'holiday', color: 'red' } } }, 'week8': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', semester: 1, startDate: '27 / 4', endDate: '1 / 5', days: { 'ุงูุฃุญุฏ': '27 / 4', 'ุงูุงุซููู': '28 / 4', 'ุงูุซูุงุซุงุก': '29 / 4', 'ุงูุฃุฑุจุนุงุก': '30 / 4', 'ุงูุฎููุณ': '1 / 5' } }, 'week9': { name: 'ุงูุฃุณุจูุน ุงูุชุงุณุน', semester: 1, startDate: '4 / 5', endDate: '8 / 5', days: { 'ุงูุฃุญุฏ': '4 / 5', 'ุงูุงุซููู': '5 / 5', 'ุงูุซูุงุซุงุก': '6 / 5', 'ุงูุฃุฑุจุนุงุก': '7 / 5', 'ุงูุฎููุณ': '8 / 5' } }, 'week10': { name: 'ุงูุฃุณุจูุน ุงูุนุงุดุฑ', semester: 1, startDate: '11 / 5', endDate: '15 / 5', days: { 'ุงูุฃุญุฏ': '11 / 5', 'ุงูุงุซููู': '12 / 5', 'ุงูุซูุงุซุงุก': '13 / 5', 'ุงูุฃุฑุจุนุงุก': '14 / 5', 'ุงูุฎููุณ': '15 / 5' } }, 'week11': { name: 'ุงูุฃุณุจูุน ุงูุญุงุฏู ุนุดุฑ', semester: 1, startDate: '18 / 5', endDate: '22 / 5', days: { 'ุงูุฃุญุฏ': '18 / 5', 'ุงูุงุซููู': '19 / 5', 'ุงูุซูุงุซุงุก': '20 / 5', 'ุงูุฃุฑุจุนุงุก': '21 / 5', 'ุงูุฎููุณ': '22 / 5' } }, 'week12': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ', semester: 1, startDate: '25 / 5', endDate: '29 / 5', days: { 'ุงูุฃุญุฏ': '25 / 5', 'ุงูุงุซููู': '26 / 5', 'ุงูุซูุงุซุงุก': '27 / 5', 'ุงูุฃุฑุจุนุงุก': '28 / 5', 'ุงูุฎููุณ': '29 / 5' } }, 'autumn_break': { name: 'ุฅุฌุงุฒุฉ ุงูุฎุฑูู', semester: 1, startDate: '30 / 5', endDate: '8 / 6', days: {} }, 'week13': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ ุนุดุฑ', semester: 1, startDate: '9 / 6', endDate: '13 / 6', days: { 'ุงูุฃุญุฏ': '9 / 6', 'ุงูุงุซููู': '10 / 6', 'ุงูุซูุงุซุงุก': '11 / 6', 'ุงูุฃุฑุจุนุงุก': '12 / 6', 'ุงูุฎููุณ': '13 / 6' } }, 'week14': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน ุนุดุฑ', semester: 1, startDate: '16 / 6', endDate: '20 / 6', days: { 'ุงูุฃุญุฏ': '16 / 6', 'ุงูุงุซููู': '17 / 6', 'ุงูุซูุงุซุงุก': '18 / 6', 'ุงูุฃุฑุจุนุงุก': '19 / 6', 'ุงูุฎููุณ': '20 / 6' }, specialDays: { '20 / 6': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', type: 'holiday', color: 'red' } } }, 'week15': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ ุนุดุฑ', semester: 1, startDate: '23 / 6', endDate: '27 / 6', days: { 'ุงูุฃุญุฏ': '23 / 6', 'ุงูุงุซููู': '24 / 6', 'ุงูุซูุงุซุงุก': '25 / 6', 'ุงูุฃุฑุจุนุงุก': '26 / 6', 'ุงูุฎููุณ': '27 / 6' }, specialDays: { '23 / 6': { name: 'ุฅุฌุงุฒุฉ ุฅุถุงููุฉ', type: 'holiday', color: 'red' } } }, 'week16': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ ุนุดุฑ', semester: 1, startDate: '1 / 7', endDate: '5 / 7', days: { 'ุงูุฃุญุฏ': '1 / 7', 'ุงูุงุซููู': '2 / 7', 'ุงูุซูุงุซุงุก': '3 / 7', 'ุงูุฃุฑุจุนุงุก': '4 / 7', 'ุงูุฎููุณ': '5 / 7' } }, 'week17': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน ุนุดุฑ', semester: 1, startDate: '8 / 7', endDate: '12 / 7', days: { 'ุงูุฃุญุฏ': '8 / 7', 'ุงูุงุซููู': '9 / 7', 'ุงูุซูุงุซุงุก': '10 / 7', 'ุงูุฃุฑุจุนุงุก': '11 / 7', 'ุงูุฎููุณ': '12 / 7' } }, 'exams': { name: 'ุงูุงุฎุชุจุงุฑุงุช', semester: 1, startDate: '15 / 7', endDate: '19 / 7', days: {} } };
        const weeksS2_Default_Fixed = { 
            's2_week1': { name: 'ุงูุฃุณุจูุน ุงูุฃูู', semester: 2, startDate: '29 / 07', endDate: '03 / 08', days: { 'ุงูุฃุญุฏ': '29 / 07', 'ุงูุงุซููู': '30 / 07', 'ุงูุซูุงุซุงุก': '01 / 08', 'ุงูุฃุฑุจุนุงุก': '02 / 08', 'ุงูุฎููุณ': '03 / 08' } }, 
            's2_week2': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', semester: 2, startDate: '06 / 08', endDate: '10 / 08', days: { 'ุงูุฃุญุฏ': '06 / 08', 'ุงูุงุซููู': '07 / 08', 'ุงูุซูุงุซุงุก': '08 / 08', 'ุงูุฃุฑุจุนุงุก': '09 / 08', 'ุงูุฎููุณ': '10 / 08' } }, 
            's2_week3': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ', semester: 2, startDate: '13 / 08', endDate: '17 / 08', days: { 'ุงูุฃุญุฏ': '13 / 08', 'ุงูุงุซููู': '14 / 08', 'ุงูุซูุงุซุงุก': '15 / 08', 'ุงูุฃุฑุจุนุงุก': '16 / 08', 'ุงูุฎููุณ': '17 / 08' } }, 
            's2_week4': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน', semester: 2, startDate: '20 / 08', endDate: '24 / 08', days: { 'ุงูุฃุญุฏ': '20 / 08', 'ุงูุงุซููู': '21 / 08', 'ุงูุซูุงุซุงุก': '22 / 08', 'ุงูุฃุฑุจุนุงุก': '23 / 08', 'ุงูุฎููุณ': '24 / 08' } }, 
            's2_week5': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ', semester: 2, startDate: '27 / 08', endDate: '02 / 09', days: { 'ุงูุฃุญุฏ': '27 / 08', 'ุงูุงุซููู': '28 / 08', 'ุงูุซูุงุซุงุก': '29 / 08', 'ุงูุฃุฑุจุนุงุก': '01 / 09', 'ุงูุฎููุณ': '02 / 09' }, specialDays: { '01 / 09': { name: 'ุบุฑุฉ ุฑูุถุงู', type: 'occasion', color: 'green' } } }, 
            's2_week6': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ', semester: 2, startDate: '05 / 09', endDate: '09 / 09', days: { 'ุงูุฃุญุฏ': '05 / 09', 'ุงูุงุซููู': '06 / 09', 'ุงูุซูุงุซุงุก': '07 / 09', 'ุงูุฃุฑุจุนุงุก': '08 / 09', 'ุงูุฎููุณ': '09 / 09' }, specialDays: { '05 / 09': { name: 'ุฅุฌุงุฒุฉ ููู ุงูุชุฃุณูุณ', type: 'holiday', color: 'green' } } }, 
            's2_week7': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน', semester: 2, startDate: '12 / 09', endDate: '16 / 09', days: { 'ุงูุฃุญุฏ': '12 / 09', 'ุงูุงุซููู': '13 / 09', 'ุงูุซูุงุซุงุก': '14 / 09', 'ุงูุฃุฑุจุนุงุก': '15 / 09', 'ุงูุฎููุณ': '16 / 09' } }, 
            's2_eid_fitr': { name: 'ุฅุฌุงุฒุฉ ุนูุฏ ุงููุทุฑ', semester: 2, startDate: '16 / 09', endDate: '09 / 10', days: {}, holidayDetails: 'ุชุจุฏุฃ ุจููุงูุฉ ุฏูุงู ุงูุฎููุณ 09/16 ุฅูู ุงูุณุจุช 10/09' }, 
            's2_week8': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', semester: 2, startDate: '10 / 10', endDate: '14 / 10', days: { 'ุงูุฃุญุฏ': '10 / 10', 'ุงูุงุซููู': '11 / 10', 'ุงูุซูุงุซุงุก': '12 / 10', 'ุงูุฃุฑุจุนุงุก': '13 / 10', 'ุงูุฎููุณ': '14 / 10' } }, 
            's2_week9': { name: 'ุงูุฃุณุจูุน ุงูุชุงุณุน', semester: 2, startDate: '17 / 10', endDate: '21 / 10', days: { 'ุงูุฃุญุฏ': '17 / 10', 'ุงูุงุซููู': '18 / 10', 'ุงูุซูุงุซุงุก': '19 / 10', 'ุงูุฃุฑุจุนุงุก': '20 / 10', 'ุงูุฎููุณ': '21 / 10' }, specialDays: { '19 / 10': { name: 'ููู ุงูุตุญุฉ ุงูุนุงููู', type: 'occasion', color: 'blue' } } }, 
            's2_week10': { name: 'ุงูุฃุณุจูุน ุงูุนุงุดุฑ', semester: 2, startDate: '24 / 10', endDate: '28 / 10', days: { 'ุงูุฃุญุฏ': '24 / 10', 'ุงูุงุซููู': '25 / 10', 'ุงูุซูุงุซุงุก': '26 / 10', 'ุงูุฃุฑุจุนุงุก': '27 / 10', 'ุงูุฎููุณ': '28 / 10' } }, 
            's2_week11': { name: 'ุงูุฃุณุจูุน ุงูุญุงุฏู ุนุดุฑ', semester: 2, startDate: '02 / 11', endDate: '06 / 11', days: { 'ุงูุฃุญุฏ': '02 / 11', 'ุงูุงุซููู': '03 / 11', 'ุงูุซูุงุซุงุก': '04 / 11', 'ุงูุฃุฑุจุนุงุก': '05 / 11', 'ุงูุฎููุณ': '06 / 11' } }, 
            's2_week12': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ', semester: 2, startDate: '09 / 11', endDate: '13 / 11', days: { 'ุงูุฃุญุฏ': '09 / 11', 'ุงูุงุซููู': '10 / 11', 'ุงูุซูุงุซุงุก': '11 / 11', 'ุงูุฃุฑุจุนุงุก': '12 / 11', 'ุงูุฎููุณ': '13 / 11' } }, 
            's2_week13': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ ุนุดุฑ', semester: 2, startDate: '16 / 11', endDate: '20 / 11', days: { 'ุงูุฃุญุฏ': '16 / 11', 'ุงูุงุซููู': '17 / 11', 'ุงูุซูุงุซุงุก': '18 / 11', 'ุงูุฃุฑุจุนุงุก': '19 / 11', 'ุงูุฎููุณ': '20 / 11' } }, 
            's2_week14': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน ุนุดุฑ', semester: 2, startDate: '23 / 11', endDate: '27 / 11', days: { 'ุงูุฃุญุฏ': '23 / 11', 'ุงูุงุซููู': '24 / 11', 'ุงูุซูุงุซุงุก': '25 / 11', 'ุงูุฃุฑุจุนุงุก': '26 / 11', 'ุงูุฎููุณ': '27 / 11' } }, 
            's2_week15': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ ุนุดุฑ', semester: 2, startDate: '30 / 11', endDate: '04 / 12', days: { 'ุงูุฃุญุฏ': '30 / 11', 'ุงูุงุซููู': '01 / 12', 'ุงูุซูุงุซุงุก': '02 / 12', 'ุงูุฃุฑุจุนุงุก': '03 / 12', 'ุงูุฎููุณ': '04 / 12' } }, 
            's2_eid_adha': { name: 'ุฅุฌุงุฒุฉ ุนูุฏ ุงูุฃุถุญู', semester: 2, startDate: '04 / 12', endDate: '15 / 12', days: {}, holidayDetails: 'ุชุจุฏุฃ ุจููุงูุฉ ุฏูุงู ุงูุฎููุณ 12/04 ุฅูู ุงูุณุจุช 12/15' }, 
            's2_week16': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ ุนุดุฑ', semester: 2, startDate: '16 / 12', endDate: '18 / 12', days: { 'ุงูุซูุงุซุงุก': '16 / 12', 'ุงูุฃุฑุจุนุงุก': '17 / 12', 'ุงูุฎููุณ': '18 / 12' } }, 
            's2_week17': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน ุนุดุฑ', semester: 2, startDate: '21 / 12', endDate: '25 / 12', days: { 'ุงูุฃุญุฏ': '21 / 12', 'ุงูุงุซููู': '22 / 12', 'ุงูุซูุงุซุงุก': '23 / 12', 'ุงูุฃุฑุจุนุงุก': '24 / 12', 'ุงูุฎููุณ': '25 / 12' } }, 
            's2_week18': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ', semester: 2, startDate: '28 / 12', endDate: '03 / 01', days: { 'ุงูุฃุญุฏ': '28 / 12', 'ุงูุงุซููู': '29 / 12', 'ุงูุซูุงุซุงุก': '01 / 01', 'ุงูุฃุฑุจุนุงุก': '02 / 01', 'ุงูุฎููุณ': '03 / 01' }, specialDays: { '01 / 01': { name: 'ุณูุฉ ูุฌุฑูุฉ 1448', type: 'occasion', color: 'green' } } }, 
            's2_week19': { name: 'ุงูุฃุณุจูุน ุงูุชุงุณุน ุนุดุฑ', semester: 2, startDate: '06 / 01', endDate: '10 / 01', days: { 'ุงูุฃุญุฏ': '06 / 01', 'ุงูุงุซููู': '07 / 01', 'ุงูุซูุงุซุงุก': '08 / 01', 'ุงูุฃุฑุจุนุงุก': '09 / 01', 'ุงูุฎููุณ': '10 / 01' } } 
        };
        const weeksS2_Western_Fixed = { 
            's2_week1': { name: 'ุงูุฃุณุจูุน ุงูุฃูู', semester: 2, startDate: '29 / 07', endDate: '03 / 08', days: { 'ุงูุฃุญุฏ': '29 / 07', 'ุงูุงุซููู': '30 / 07', 'ุงูุซูุงุซุงุก': '01 / 08', 'ุงูุฃุฑุจุนุงุก': '02 / 08', 'ุงูุฎููุณ': '03 / 08' } }, 
            's2_week2': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', semester: 2, startDate: '06 / 08', endDate: '10 / 08', days: { 'ุงูุฃุญุฏ': '06 / 08', 'ุงูุงุซููู': '07 / 08', 'ุงูุซูุงุซุงุก': '08 / 08', 'ุงูุฃุฑุจุนุงุก': '09 / 08', 'ุงูุฎููุณ': '10 / 08' } }, 
            's2_week3': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ', semester: 2, startDate: '13 / 08', endDate: '17 / 08', days: { 'ุงูุฃุญุฏ': '13 / 08', 'ุงูุงุซููู': '14 / 08', 'ุงูุซูุงุซุงุก': '15 / 08', 'ุงูุฃุฑุจุนุงุก': '16 / 08', 'ุงูุฎููุณ': '17 / 08' } }, 
            's2_week4': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน', semester: 2, startDate: '20 / 08', endDate: '24 / 08', days: { 'ุงูุฃุญุฏ': '20 / 08', 'ุงูุงุซููู': '21 / 08', 'ุงูุซูุงุซุงุก': '22 / 08', 'ุงูุฃุฑุจุนุงุก': '23 / 08', 'ุงูุฎููุณ': '24 / 08' } }, 
            's2_week5': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ', semester: 2, startDate: '27 / 08', endDate: '02 / 09', days: { 'ุงูุฃุญุฏ': '27 / 08', 'ุงูุงุซููู': '28 / 08', 'ุงูุซูุงุซุงุก': '29 / 08', 'ุงูุฃุฑุจุนุงุก': '01 / 09', 'ุงูุฎููุณ': '02 / 09' }, specialDays: { '01 / 09': { name: 'ุบุฑุฉ ุฑูุถุงู', type: 'occasion', color: 'green' } } }, 
            's2_week6': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ', semester: 2, startDate: '05 / 09', endDate: '09 / 09', days: { 'ุงูุฃุญุฏ': '05 / 09', 'ุงูุงุซููู': '06 / 09', 'ุงูุซูุงุซุงุก': '07 / 09', 'ุงูุฃุฑุจุนุงุก': '08 / 09', 'ุงูุฎููุณ': '09 / 09' }, specialDays: { '05 / 09': { name: 'ุฅุฌุงุฒุฉ ููู ุงูุชุฃุณูุณ', type: 'holiday', color: 'green' } } }, 
            's2_week7': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน', semester: 2, startDate: '12 / 09', endDate: '16 / 09', days: { 'ุงูุฃุญุฏ': '12 / 09', 'ุงูุงุซููู': '13 / 09', 'ุงูุซูุงุซุงุก': '14 / 09', 'ุงูุฃุฑุจุนุงุก': '15 / 09', 'ุงูุฎููุณ': '16 / 09' } }, 
            's2_eid_fitr': { name: 'ุฅุฌุงุฒุฉ ุนูุฏ ุงููุทุฑ', semester: 2, startDate: '16 / 09', endDate: '09 / 10', days: {}, holidayDetails: 'ุชุจุฏุฃ ุจููุงูุฉ ุฏูุงู ุงูุฎููุณ 09/16 ุฅูู ุงูุณุจุช 10/09' }, 
            's2_week8': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู', semester: 2, startDate: '10 / 10', endDate: '14 / 10', days: { 'ุงูุฃุญุฏ': '10 / 10', 'ุงูุงุซููู': '11 / 10', 'ุงูุซูุงุซุงุก': '12 / 10', 'ุงูุฃุฑุจุนุงุก': '13 / 10', 'ุงูุฎููุณ': '14 / 10' } }, 
            's2_week9': { name: 'ุงูุฃุณุจูุน ุงูุชุงุณุน', semester: 2, startDate: '17 / 10', endDate: '21 / 10', days: { 'ุงูุฃุญุฏ': '17 / 10', 'ุงูุงุซููู': '18 / 10', 'ุงูุซูุงุซุงุก': '19 / 10', 'ุงูุฃุฑุจุนุงุก': '20 / 10', 'ุงูุฎููุณ': '21 / 10' }, specialDays: { '19 / 10': { name: 'ููู ุงูุตุญุฉ ุงูุนุงููู', type: 'occasion', color: 'blue' } } }, 
            's2_week10': { name: 'ุงูุฃุณุจูุน ุงูุนุงุดุฑ', semester: 2, startDate: '24 / 10', endDate: '28 / 10', days: { 'ุงูุฃุญุฏ': '24 / 10', 'ุงูุงุซููู': '25 / 10', 'ุงูุซูุงุซุงุก': '26 / 10', 'ุงูุฃุฑุจุนุงุก': '27 / 10', 'ุงูุฎููุณ': '28 / 10' } }, 
            's2_week11': { name: 'ุงูุฃุณุจูุน ุงูุญุงุฏู ุนุดุฑ', semester: 2, startDate: '02 / 11', endDate: '06 / 11', days: { 'ุงูุฃุญุฏ': '02 / 11', 'ุงูุงุซููู': '03 / 11', 'ุงูุซูุงุซุงุก': '04 / 11', 'ุงูุฃุฑุจุนุงุก': '05 / 11', 'ุงูุฎููุณ': '06 / 11' } }, 
            's2_week12': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ', semester: 2, startDate: '09 / 11', endDate: '13 / 11', days: { 'ุงูุฃุญุฏ': '09 / 11', 'ุงูุงุซููู': '10 / 11', 'ุงูุซูุงุซุงุก': '11 / 11', 'ุงูุฃุฑุจุนุงุก': '12 / 11', 'ุงูุฎููุณ': '13 / 11' } }, 
            's2_week13': { name: 'ุงูุฃุณุจูุน ุงูุซุงูุซ ุนุดุฑ', semester: 2, startDate: '16 / 11', endDate: '20 / 11', days: { 'ุงูุฃุญุฏ': '16 / 11', 'ุงูุงุซููู': '17 / 11', 'ุงูุซูุงุซุงุก': '18 / 11', 'ุงูุฃุฑุจุนุงุก': '19 / 11', 'ุงูุฎููุณ': '20 / 11' } }, 
            's2_week14': { name: 'ุงูุฃุณุจูุน ุงูุฑุงุจุน ุนุดุฑ', semester: 2, startDate: '23 / 11', endDate: '27 / 11', days: { 'ุงูุฃุญุฏ': '23 / 11', 'ุงูุงุซููู': '24 / 11', 'ุงูุซูุงุซุงุก': '25 / 11', 'ุงูุฃุฑุจุนุงุก': '26 / 11', 'ุงูุฎููุณ': '27 / 11' } }, 
            's2_eid_adha': { name: 'ุฅุฌุงุฒุฉ ุนูุฏ ุงูุฃุถุญู', semester: 2, startDate: '27 / 11', endDate: '15 / 12', days: {}, holidayDetails: 'ุชุจุฏุฃ ุจููุงูุฉ ุฏูุงู ุงูุฎููุณ 11/27 ุฅูู ุงูุณุจุช 12/15' }, 
            's2_week15': { name: 'ุงูุฃุณุจูุน ุงูุฎุงูุณ ุนุดุฑ', semester: 2, startDate: '16 / 12', endDate: '18 / 12', days: { 'ุงูุซูุงุซุงุก': '16 / 12', 'ุงูุฃุฑุจุนุงุก': '17 / 12', 'ุงูุฎููุณ': '18 / 12' } }, 
            's2_week16': { name: 'ุงูุฃุณุจูุน ุงูุณุงุฏุณ ุนุดุฑ', semester: 2, startDate: '21 / 12', endDate: '25 / 12', days: { 'ุงูุฃุญุฏ': '21 / 12', 'ุงูุงุซููู': '22 / 12', 'ุงูุซูุงุซุงุก': '23 / 12', 'ุงูุฃุฑุจุนุงุก': '24 / 12', 'ุงูุฎููุณ': '25 / 12' } }, 
            's2_week17': { name: 'ุงูุฃุณุจูุน ุงูุณุงุจุน ุนุดุฑ', semester: 2, startDate: '28 / 12', endDate: '03 / 01', days: { 'ุงูุฃุญุฏ': '28 / 12', 'ุงูุงุซููู': '29 / 12', 'ุงูุซูุงุซุงุก': '01 / 01', 'ุงูุฃุฑุจุนุงุก': '02 / 01', 'ุงูุฎููุณ': '03 / 01' }, specialDays: { '01 / 01': { name: 'ุณูุฉ ูุฌุฑูุฉ 1448', type: 'occasion', color: 'green' } } }, 
            's2_week18': { name: 'ุงูุฃุณุจูุน ุงูุซุงูู ุนุดุฑ', semester: 2, startDate: '06 / 01', endDate: '10 / 01', days: { 'ุงูุฃุญุฏ': '06 / 01', 'ุงูุงุซููู': '07 / 01', 'ุงูุซูุงุซุงุก': '08 / 01', 'ุงูุฃุฑุจุนุงุก': '09 / 01', 'ุงูุฎููุณ': '10 / 01' } }, 
            // ุงูุฃุณุจูุน 19 ููุบุฑุจูุฉ ููุท (ุชุนููุถ)
            's2_week19': { name: 'ุงูุฃุณุจูุน ุงูุชุงุณุน ุนุดุฑ', semester: 2, startDate: '13 / 01', endDate: '17 / 01', days: { 'ุงูุฃุญุฏ': '13 / 01', 'ุงูุงุซููู': '14 / 01', 'ุงูุซูุงุซุงุก': '15 / 01', 'ุงูุฃุฑุจุนุงุก': '16 / 01', 'ุงูุฎููุณ': '17 / 01' } } 
        };

        weeksData = { ...weeksS1_Default, ...weeksS2_Default_Fixed };
        const activitiesData = [ { id: 'citizenship', title: 'ุงูููุงุทูุฉ ูุงูุญูุงุฉ', color: '#981E47',icon: 'https://k.top4top.io/p_3472ccl2l0.gif', programs: [{ name: 'ุงูุชุทูุน ุงูุทูุงุจู', sessions: { p1:4, p2:4, p3:4, p4:6, p5:6, p6:6, quran_lower: 4, quran_upper: 6, m1:5, m2:5, m3:5, h1: 5, h2:5, h3:5 } }, { name: 'ููุงุฑุงุช ุทููุญุฉ', sessions: { p1:6, p2:6, p3:6, p4:4, p5:4, p6:4, quran_lower: 6, quran_upper: 4, m1:3, m2:3, m3:3, h1: 2, h2:2, h3:2 } }, { name: 'ููููุง ุญูุงุฉ', sessions: { p4:12, p5:12, p6:12, quran_upper: 12, m1:12, m2:12, m3:12, h1: 12, h2:12, h3:12 } }] }, { id: 'culture', title: 'ุงูุซูุงูุฉ ูุงููููู', color: '#FF7145', icon: 'https://a.top4top.io/p_3472miame2.gif', programs: [{ name: 'ุงููู ุงูุณุงุจุน (ุงูุณูููุง)', sessions: { p1:8, p2:8, p3:8, p4:8, p5:8, p6:8, quran_lower: 8, quran_upper: 8, m1:8, m2:8, m3:8, h1: 8, h2:8, h3:8 } }, { name: 'ุญุฏุงุฆู ุงููู', sessions: { p1:6, p2:6, p3:6, p4:6, p5:6, p6:6, quran_lower: 6, quran_upper: 6, m1:6, m2:6, m3:6, h1: 6, h2:6, h3:6 } }, { name: 'ุงูุฃุฒูุงุก ุงูุณุนูุฏูุฉ', sessions: { p1:4, p2:4, p3:4, p4:4, p5:4, p6:4, quran_lower: 4, quran_upper: 4, m1:6, m2:6, m3:6, h1: 6, h2:6, h3:6 } }, { name: 'ุงูุซูุงูุฉ ุงูุฅุนูุงููุฉ', sessions: { p1:4, p2:4, p3:4, p4:4, p5:4, p6:4, quran_lower: 4, quran_upper: 4, m1:6, m2:6, m3:6, h1: 8, h2:8, h3:8 } }, { name: 'ุชุตุงููู ุชุฑุงุซูุฉ ูุนุงุตุฑุฉ', sessions: { p1:5, p2:5, p3:5, p4:5, p5:5, p6:5, quran_lower: 5, quran_upper: 5, m1:5, m2:5, m3:5, h1: 5, h2:5, h3:5 } }, { name: 'ุงููููู ุงููุณุฑุญูุฉ', sessions: { p1:8, p2:8, p3:8, p4:8, p5:8, p6:8, quran_lower: 8, quran_upper: 8, m1:8, m2:8, m3:8, h1: 8, h2:8, h3:8 } }, { name: 'ุงูุจุฑูุงูุฌ ุงูููุณููู (ุงูุฃูุงุดูุฏ ุงููุทููุฉ)', sessions: { p1:8, p2:8, p3:8, p4:8, p5:8, p6:8, quran_lower: 8, quran_upper: 8, m1:8, m2:8, m3:8, h1: 8, h2:8, h3:8 } }, { name: 'ุญูุงูุงุช ูุฑุฆูุฉ', sessions: { p1:6, p2:6, p3:6, p4:6, p5:6, p6:6, quran_lower: 6, quran_upper: 6, m1:11, m2:11, m3:11, h1: 11, h2:11, h3:11 } }] }, { id: 'sports', title: 'ุงูุฑูุงุถุฉ ูุงูุตุญุฉ', color: '#2FB7BD', icon: 'https://c.top4top.io/p_3472urwbn4.gif', programs: [{ name: 'ููุงุฑุงุช ุงูุฑูุงุถุงุช ุงูุฌูุงุนูุฉ', sessions: { p1:6, p2:6, p3:6, p4:8, p5:8, p6:8, quran_lower: 6, quran_upper: 8, m1:8, m2:8, m3:8, h1: 8, h2:8, h3:8 } }, { name: 'ููุงุฑุงุช ุงูุฑูุงุถุงุช ุงููุฑุฏูุฉ', sessions: { p1:8, p2:8, p3:8, p4:8, p5:8, p6:8, quran_lower: 8, quran_upper: 8, m1:8, m2:8, m3:8, h1: 6, h2:6, h3:6 } }, { name: 'ููุงุฑุงุช ุฑูุงุถุงุช ุงูุฏูุงุน ุนู ุงูููุณ', sessions: { p1:8, p2:8, p3:8, p4:8, p5:8, p6:8, quran_lower: 8, quran_upper: 8, m1:8, m2:8, m3:8, h1: 6, h2:6, h3:6 } }, { name: 'ููุงุฑุงุช ุงูุฑูุงุถุงุช ุงูุฅููุชุฑูููุฉ ูุงูุชุฑููู', sessions: { p1:8, p2:8, p3:8, p4:8, p5:8, p6:8, quran_lower: 8, quran_upper: 8, m1:6, m2:6, m3:6, h1: 8, h2:8, h3:8 } }, { name: 'ููุงุฑุงุช ุงูุฑูุงุถุงุช ุงูุฐูููุฉ', sessions: { p1:6, p2:6, p3:6, p4:8, p5:8, p6:8, quran_lower: 6, quran_upper: 8, m1:8, m2:8, m3:8, h1: 8, h2:8, h3:8 } }, { name: 'ููุงุฑุงุช ุงูุฃูููุจูุงุฏ ุงูุฑูุงุถู', sessions: { p1:6, p2:6, p3:6, p4:8, p5:8, p6:8, quran_lower: 6, quran_upper: 8, m1:8, m2:8, m3:8, h1: 8, h2:8, h3:8 } }] }, { id: 'science', title: 'ุงูุนููู ูุงูุชูููุฉ', color: '#24344D', icon: 'https://l.top4top.io/p_3472daolv1.gif', programs: [{ name: 'ุจุฑูุงูุฌ ุชุทุจููุงุช STEM', sessions: { p1:3, p2:3, p3:3, p4:5, p5:5, p6:5, quran_lower: 3, quran_upper: 5, m1:7, m2:7, m3:7, h1: 7, h2:7, h3:7 } }, { name: 'ุจุฑูุงูุฌ ุงูุชุตุงููู ุงูุนูููุฉ ุงูุชูููุฉ', sessions: { p1:2, p2:2, p3:2, p4:5, p5:5, p6:5, quran_lower: 2, quran_upper: 5, m1:7, m2:7, m3:7, h1: 7, h2:7, h3:7 } }, { name: 'ุจุฑูุงูุฌ ุฑูุงุฏ ูุถุงุก ุงููุณุชูุจู', sessions: { p1:3, p2:3, p3:3, p4:5, p5:5, p6:5, quran_lower: 3, quran_upper: 5, m1:7, m2:7, m3:7, h1: 9, h2:9, h3:9 } }, { name: 'ุจุฑูุงูุฌ ูุฏู ุงููุณุชูุจู', sessions: { p1:3, p2:3, p3:3, p4:4, p5:4, p6:4, quran_lower: 3, quran_upper: 4, m1:7, m2:7, m3:7, h1: 9, h2:9, h3:9 } }, { name: 'ุจุฑูุงูุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู', sessions: { p1:10, p2:10, p3:10, p4:10, p5:10, p6:10, quran_lower: 10, quran_upper: 10, m1:10, m2:10, m3:10, h1: 10, h2:10, h3:10 } }, { name: 'ุจุฑูุงูุฌ ุชุญุฏู ุฅูุชุฑูุช ุงูุฃุดูุงุก', sessions: { p1:3, p2:3, p3:3, p4:4, p5:4, p6:4, quran_lower: 3, quran_upper: 4, m1:7, m2:7, m3:7, h1: 9, h2:9, h3:9 } }] }, { id: 'events', title: 'ุงูุฃูุงู ูุงูููุงุณุจุงุช', color: '#583C71', icon: 'https://e.top4top.io/p_34729xucx5.gif', programs: [{ name: 'ุงูููู ุงููุทูู', date: 'ููุงูู ูก / ูค / ูกูคูคูง ูู', sessions: { p1:4, p2:4, p3:4, p4:4, p5:4, p6:4, quran_lower: 4, quran_upper: 4, m1:4, m2:4, m3:4, h1: 4, h2:4, h3:4 } }, { name: 'ููู ุงูุชุณุงูุญ ุงูุนุงููู', date: 'ููุงูู ูขูฅ / ูฅ / ูกูคูคูง ูู', sessions: { p1:2, p2:2, p3:2, p4:2, p5:2, p6:2, quran_lower: 2, quran_upper: 2, m1:1, m2:1, m3:1, h1: 1, h2:1, h3:1 } }, { name: 'ุงูููู ุงูุนุงููู ููุทูู', date: 'ููุงูู ูขูฉ / ูฅ / ูกูคูคูง ูู', sessions: { p1:2, p2:2, p3:2, p4:2, p5:2, p6:2, quran_lower: 2, quran_upper: 2 } }, { name: 'ุงูููู ุงูุนุงููู ูุฐูู ุงูุฅุนุงูุฉ', date: 'ููุงูู ูกูข / ูฆ / ูกูคูคูง ูู', sessions: { p1:2, p2:2, p3:2, p4:2, p5:2, p6:2, quran_lower: 2, quran_upper: 2, m1:2, m2:2, m3:2, h1: 2, h2:2, h3:2 } }, { name: 'ุงูููู ุงูุนุงููู ูููุบุฉ ุงูุนุฑุจูุฉ', date: 'ููุงูู ูขูง / ูฆ / ูกูคูคูง ูู', sessions: { p1:2, p2:2, p3:2, p4:2, p5:2, p6:2, quran_lower: 2, quran_upper: 2, m1:1, m2:1, m3:1, h1: 1, h2:1, h3:1 } }, { name: 'ุงูููู ุงูุนุงููู ููุชุนููู', date: 'ููุงูู ูง / ูจ / ูกูคูคูง ูู', sessions: { p1:2, p2:2, p3:2, p4:2, p5:2, p6:2, quran_lower: 2, quran_upper: 2, m1:2, m2:2, m3:2, h1: 2, h2:2, h3:2 } }, { name: 'ููู ุงูุชุฃุณูุณ', date: 'ููุงูู ูฅ / ูฉ / ูกูคูคูง ูู', sessions: { p1:4, p2:4, p3:4, p4:4, p5:4, p6:4, quran_lower: 4, quran_upper: 4, m1:4, m2:4, m3:4, h1: 4, h2:4, h3:4 } }, { name: 'ููู ุงูุนูู ุงูุณุนูุฏู', date: 'ููุงูู ูขูข / ูฉ / ูกูคูคูง ูู', sessions: { p1:3, p2:3, p3:3, p4:3, p5:3, p6:3, quran_lower: 3, quran_upper: 3, m1:2, m2:2, m3:2, h1: 2, h2:2, h3:2 } }, { name: 'ููู ุงูุณุนูุฏูุฉ ุงูุฎุถุฑุงุก', date: 'ููุงูู ูจ / ูกู / ูกูคูคูง ูู', sessions: { p1:3, p2:3, p3:3, p4:3, p5:3, p6:3, quran_lower: 3, quran_upper: 3, m1:2, m2:2, m3:2, h1: 2, h2:2, h3:2 } }, { name: 'ููู ุงูุตุญุฉ ุงูุนุงููู', date: 'ููุงูู ูกูฉ / ูกู / ูกูคูคูง ูู', sessions: { p1:2, p2:2, p3:2, p4:2, p5:2, p6:2, quran_lower: 2, quran_upper: 2, m1:2, m2:2, m3:2, h1: 2, h2:2, h3:2 } }] },
            { id: 'scouting', title: 'ุงููุดุงุท ุงููุดูู', color: '#018083', icon: 'https://b.top4top.io/p_3472h0ngk3.gif', programs: [{ name: 'ุฎููุชู ุงูุฌูููุฉ', sessions: { p1:3, p2:3, p3:3, quran_lower: 3 } }, { name: 'ุฎุดุจุฉ ูุญุจู', sessions: { p4:12, p5:12, p6:12, quran_upper: 12 } }, { name: 'ุงูููุงุญุฉ ุนูู ุงููุงุจุณ', sessions: { m1:3, m2:3, m3:3 } }, { name: 'ุฃุบุงูุฑ ูุฃูุชุดู', sessions: { h1: 5, h2:5, h3:5 } }, { name: 'ุจุฑุงุนู ุงูุจูุฆุฉ ูุงููุฌุชูุน', sessions: { p1:2, p2:2, p3:2, quran_lower: 2 } }, { name: 'ุฃุดุงุฑู ูุฌุชูุนู ูุฃุฒุฑุน ุดุฌุฑุฉ', sessions: { p4:3, p5:3, p6:3, quran_upper: 3 } }, { name: 'ูุฌุชูุนู ูุจูุฆุชู ูุณุคูููุชู', sessions: { m1:6, m2:6, m3:6 } }, { name: 'ุณููุฑ ุงูุจูุฆุฉ ูุงููุฌุชูุน', sessions: { h1: 5, h2:5, h3:5 } }, { name: 'ุจุตูุชู ุงููุดููุฉ', sessions: { p1:3, p2:2, p3:3, quran_lower: 3 } }, { name: 'ูุทูู ูู ููุจู', sessions: { p4:3, p5:3, p6:3, quran_upper: 3 } }, { name: 'ุตูุงุน ุงูุชุบููุฑ', sessions: { m1:3, m2:3, m3:3 } }, { name: 'ุณูุงุนุฏ ุงููุดููุฉ', sessions: { h1: 6, h2:6, h3:6 } }, { name: 'ุจุฑุงุนู ุงูููุฑ', sessions: { p1:2, p2:2, p3:2, quran_lower: 2 } }, { name: 'ูููุฒ ุงูุตุบุงุฑ', sessions: { p4:2, p5:2, p6:2, quran_upper: 2 } }, { name: 'ูู ูุฏู ุงููุฑุขู ูุงูุณูุฉ', sessions: { m1:3, m2:3, m3:3 } }, { name: 'ุฏุฑุจ ุงูุฅุญุณุงู', sessions: { h1: 3, h2:3, h3:3 } }, { name: 'ุจูุตูุฉ ุงูุงูุชุดุงู', sessions: { p1:3, p2:3, p3:3, quran_lower: 3 } }, { name: 'ุฎููุฉ ุงูุชุฌุงุฑุจ ุงููุณููุฉ', sessions: { p4:6, p5:6, p6:6, quran_upper: 6 } }, { name: 'ูุฎููู ุงูุชููู', sessions: { m1:10, m2:10, m3:10 } }, { name: 'ูุงุญุฉ ุงูุฅุจุฏุงุน ุงููุดูู', sessions: { h1: 4, h2:4, h3:4 } }, { name: 'ุนุงุฏุงุชู ุงูุตุญูุฉ ุงููุดููุฉ', sessions: { p1:3, p2:3, p3:3, quran_lower: 3 } }, { name: 'ุทุจูู ุงููุดูู', sessions: { p4:3, p5:3, p6:3, quran_upper: 3 } }, { name: 'ุฎุทูุงุชู ุงููุดููุฉ ุงูุตุญูุฉ', sessions: { m1:3, m2:3, m3:3 } }, { name: 'ููุฑุฌุงู ุงูุฃููุงู ุงููุดููุฉ ุงูุตุญูุฉ', sessions: { h1: 5, h2:5, h3:5 } }, { name: 'ููุงุฑุงุชู ููุดููุชู', sessions: { p1:2, p2:2, p3:2, quran_lower: 2 } }, { name: 'ุตุงูุฑุฉ ูุงุตุทูุงู', sessions: { p4:2, p5:2, p6:2, quran_upper: 2 } }, { name: 'ููุงุฑุงุชู ุงููุดููุฉ ูู ุงูุงุณุชุนุฏุงุฏ ุฅูู ุงูุฅูุฌุงุฒ', sessions: { m1:4, m2:4, m3:4 } }, { name: 'ุฃููู ุงููุดูู ุงููุงุณุน', sessions: { h1: 6, h2:6, h3:6 } }] },
        ];

        // --- ุฏูุงู ุงููุณุงุนุฏุฉ ---
        function parseDateForSort(dateStr) { const parts = dateStr.split(' '); const datePart = parts.slice(1).join(''); const dateParts = datePart.split('/'); if (dateParts.length < 2) return 9999; const day = parseInt(dateParts[0], 10); let month = parseInt(dateParts[1], 10); if (month < 3) month += 12; return month * 100 + day; }
        // ุชุนุฏูู ุตูุบุฉ ุงูุชุงุฑูุฎ ููุง: ุฅุถุงูุฉ ุญุฑู ูุฎูู ูููุน ุงูุงูุชุดุงู
        function formatDatesForDisplay(datesArray) { if (!datesArray || datesArray.length === 0) return { text: '', json: '[]' }; const sortedDates = [...datesArray].sort((a, b) => parseDateForSort(a) - parseDateForSort(b)); const firstDateStr = sortedDates[0]; const lastDateStr = sortedDates[sortedDates.length - 1]; let textContent; 
        // ูุณุชุฎุฏู ุงูุญุฑู ุงููุฎูู ZWNJ ูู ุงูุชูุงุฑูุฎ ุงูููุงุฆูุฉ ููุนุฑุถ ููุท
        const safeFirst = firstDateStr.replace(/\//g, '/\u200C');
        const safeLast = lastDateStr.replace(/\//g, '/\u200C');
        if (sortedDates.length === 1) textContent = safeFirst; else textContent = `ูู ${safeFirst} ุฅูู ${safeLast}`; return { text: textContent, json: JSON.stringify(sortedDates) }; }
        function getLabel(key) {
             if (key === 'primary_all') return 'ุงุจุชุฏุงุฆูุฉ';
             if (key === 'primary_lower') return 'ุฃูููุฉ';
             if (key === 'primary_upper') return 'ุนููุง';
             if (key === 'middle_all') return 'ูุชูุณุทุฉ';
             if (key === 'high_all') return 'ุซุงูููุฉ';
             if (key === 'quran_lower') return 'ุฃูููุฉ ุชุญููุธ';
             if (key === 'quran_upper') return 'ุนููุง ุชุญููุธ';
             if (key === 'quran_all') return 'ุงุจุชุฏุงุฆูุฉ ุชุญููุธ';
             return gradeNames[key]; 
        }

        // --- ุจูุงุก ุงููุงุฌูุฉ ---
        function createGradeSelectionUI() {
            const container = document.getElementById('grade-selection-container'); container.innerHTML = `<button onclick="handleGradeSelection('all')" id="btn-all" class="w-full max-w-sm flex items-center justify-center gap-2 px-4 py-2 rounded-full font-medium transition-all duration-300">๐ซ ุงููู</button>`;
            const stages = [ { title: 'ุงูุงุจุชุฏุงุฆูุฉ', groups: [{ label: 'ุงููู', key: 'primary_all' }, { label: 'ุงูุตููู ุงูุฃูููุฉ', key: 'primary_lower' }, { label: 'ุงูุตููู ุงูุนููุง', key: 'primary_upper' }, { label: 'ุชุญููุธ', key: 'quran_all' }], individuals: ['p1', 'p2', 'p3', 'p4', 'p5', 'p6', 'quran_lower', 'quran_upper'] }, { title: 'ุงููุชูุณุทุฉ', groups: [{ label: 'ุงููู', key: 'middle_all' }], individuals: ['m1', 'm2', 'm3'] }, { title: 'ุงูุซุงูููุฉ', groups: [{ label: 'ุงููู', key: 'high_all' }], individuals: ['h1', 'h2', 'h3'] } ];
            stages.forEach(stage => { const stageWrapper = document.createElement('div'); stageWrapper.className = 'w-full max-w-sm border p-2 rounded-lg'; stageWrapper.innerHTML = `<h4 class="font-semibold mb-2">${stage.title}</h4>`; const groupsContainer = document.createElement('div'); groupsContainer.className = 'flex flex-wrap justify-center gap-2 mb-2'; stage.groups.forEach(group => { groupsContainer.innerHTML += `<button onclick="handleGradeSelection('${group.key}')" id="btn-${group.key}" class="px-3 py-1 rounded-full text-sm font-medium transition-all duration-300">${group.label}</button>`; }); stageWrapper.appendChild(groupsContainer); const individualsContainer = document.createElement('div'); individualsContainer.className = 'flex flex-wrap justify-center gap-2 border-t pt-2 mt-2'; stage.individuals.forEach(indKey => { individualsContainer.innerHTML += `<button onclick="handleGradeSelection('${indKey}')" id="btn-${indKey}" class="px-3 py-1 rounded-full text-sm font-medium transition-all duration-300">${gradeNames[indKey]}</button>`; }); stageWrapper.appendChild(individualsContainer); container.appendChild(stageWrapper); });
        }
        function generateSections() {
            const mainContainer = document.querySelector('main'); mainContainer.innerHTML = ''; 
            activitiesData.forEach(section => { const programRows = section.programs.map((prog, index) => { const uniqueId = `${section.id}-${index}`; return `<tr data-program-id="${uniqueId}" data-program-name="${prog.name}" data-field-name="${section.title}" data-field-color="${section.color}" data-sessions='${JSON.stringify(prog.sessions)}'><td class="border border-gray-300 px-2 py-3 font-semibold" style="background-color: ${section.color}; color: white;">${section.title}</td><td class="border border-gray-300 px-2 py-3"><div>${prog.name}</div>${prog.date ? `<div class="text-sm text-blue-600 font-semibold pt-1">${prog.date}</div>` : ''}</td><td class="border border-gray-300 px-2 py-3 align-top"><div class="teacher-inputs-container space-y-2" data-program-id="${uniqueId}"></div></td><td class="border border-gray-300 px-2 py-3 align-top"><div class="space-y-1" id="selectors-container-${uniqueId}"></div></td></tr>`; }).join(''); mainContainer.innerHTML += `<section id="${section.id}" class="mb-8"><div class="bg-white rounded-lg shadow-lg overflow-hidden"><button onclick="toggleDropdown('${section.id}-dropdown')" class="w-full px-6 py-4 text-right font-bold text-lg flex justify-between items-center transition-colors hover:bg-gray-50" style="background-color: ${section.color}; color: white;"><div class="flex items-center"><div class="w-12 h-12 rounded-full bg-white flex items-center justify-center ml-4 overflow-hidden"><img src="${section.icon}" alt="${section.title}" class="w-8 h-8 object-contain"></div><span>${section.title}</span></div><svg id="${section.id}-arrow" class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="${section.id}-dropdown" class="dropdown-content"><div class="p-6"><div class="overflow-x-auto"><table class="w-full border-collapse border border-gray-300"><thead><tr class="bg-gray-100"><th class="border border-gray-300 px-2 py-3 text-right font-semibold w-[10%]">ุงููุฌุงู</th><th class="border border-gray-300 px-2 py-3 text-right font-semibold w-[40%]">ุงูุจุฑูุงูุฌ</th><th class="border border-gray-300 px-2 py-3 text-right font-semibold w-[40%]">ุงููุนูู/ุฉ ุงููููุฐ/ุฉ</th><th class="border border-gray-300 px-2 py-3 text-center font-semibold w-[10%]">ุชูุงุฑูุฎ ุงูุชูููุฐ</th></tr></thead><tbody>${programRows}</tbody></table></div></div></div></div></section>`; });
        }

        // --- ุชุญุฏูุซ ุงููุงุฌูุฉ ---
        function updateAllDateSelectors() { document.querySelectorAll('tr[data-program-id]').forEach(row => { updateDateSelectorsForRow(row); updateTeacherInputsForRow(row); }); }
        function updateTeacherInputsForRow(row) { const container = row.querySelector(`.teacher-inputs-container`); if (!container) return; const sessions = JSON.parse(row.dataset.sessions); const effectiveGrades = getEffectiveIndividualGrades().filter(grade => sessions[grade] > 0); let teacherGroupsToDisplay = []; const isAllSelected = selectedGrades.includes('all'); if (isAllSelected) { teacherGroupsToDisplay.push('all'); } else { teacherGroupsToDisplay.push(...selectedGrades); } teacherGroupsToDisplay = teacherGroupsToDisplay.filter(key => { const groupGrades = gradeGroups[key] || [key]; return groupGrades.some(g => effectiveGrades.includes(g)); }); if (teacherGroupsToDisplay.length === 0 && effectiveGrades.length > 0) { teacherGroupsToDisplay = effectiveGrades; } let newHTML = ''; teacherGroupsToDisplay.forEach(key => { const groupData = teacherInputGroups[key]; const label = (groupData ? groupData.label : gradeNames[key]) || 'ูุฑุญูุฉ ุบูุฑ ูุญุฏุฏุฉ'; newHTML += `<div class="teacher-input-group"><label class="text-xs text-gray-500 font-semibold">${label}</label><textarea placeholder="ุงุณู ุงููุนูู/ุฉ" class="teacher-input w-full p-1 border rounded text-sm" data-grade-key="${key}" rows="2" oninput="saveState()"></textarea></div>`; }); container.innerHTML = newHTML; }
        function updateDateSelectorsForRow(row) { const uniqueId = row.dataset.programId; const sessions = JSON.parse(row.dataset.sessions); const container = document.getElementById(`selectors-container-${uniqueId}`); if (!container) return; container.innerHTML = ''; const itemsToDisplay = selectedGrades.includes('all') ? ['primary_lower', 'primary_upper', 'quran_lower', 'quran_upper', 'middle_all', 'high_all'] : selectedGrades; itemsToDisplay.forEach(key => { const individualGradeKeys = gradeGroups[key] || [key]; let sessionCount = Math.max(0, ...individualGradeKeys.map(g => sessions[g] || 0)); if (sessionCount > 0) { container.innerHTML += `<div class="grade-date-selector p-2 border-t first:border-t-0" data-grade-key="${key}"><div class="flex justify-between items-center text-sm mb-1"><span class="font-semibold">${getLabel(key)}</span><span class="text-gray-500">${sessionCount} ุญุตุต</span></div><div class="flex items-center gap-1"><div class="dates-display text-xs text-gray-600 flex-grow text-right p-1 bg-gray-50 rounded min-h-[26px]" data-dates="[]"></div><div class="flex-shrink-0 flex gap-1"><button class="date-select-btn bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" onclick="openDatePicker('${uniqueId}', '${key}')">ุงุฎุชูุงุฑ</button><button class="clear-date-btn bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600" onclick="clearGradeDates('${uniqueId}', '${key}')">ูุณุญ</button></div></div></div>`; } }); }
        function getEffectiveIndividualGrades() { if (selectedGrades.includes('all')) return [...allGradeKeys]; let individuals = []; selectedGrades.forEach(item => { individuals.push(...(gradeGroups[item] || [item])); }); return [...new Set(individuals)]; }
        function handleGradeSelection(key) { if (key === 'all') selectedGrades = ['all']; else { let newSelection = selectedGrades.includes('all') ? [] : [...selectedGrades]; if (!newSelection.includes(key)) newSelection.push(key); else newSelection = newSelection.filter(item => item !== key); selectedGrades = newSelection; } updateButtonStyles(); updateTitle(); updateAllDateSelectors(); saveState(); }
        function updateButtonStyles() { document.querySelectorAll('[id^="btn-"]').forEach(btn => { if (!btn.id.includes('region')) { btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg'); btn.classList.add('bg-gray-200', 'text-gray-700'); } }); selectedGrades.forEach(key => { const btn = document.getElementById(`btn-${key}`); if(btn) { btn.classList.add('bg-blue-600', 'text-white', 'shadow-lg'); btn.classList.remove('bg-gray-200', 'text-gray-700'); } }); if (selectedGrades.includes('all')) { document.getElementById('btn-all').classList.add('bg-blue-600', 'text-white'); } }
        function selectRegion(region) { currentRegion = region; const s1 = region === 'western' ? weeksS1_Western : weeksS1_Default; const s2 = region === 'western' ? weeksS2_Western_Fixed : weeksS2_Default_Fixed; weeksData = { ...s1, ...s2 }; const btnWestern = document.getElementById('btn-western-region'); const btnOther = document.getElementById('btn-other-region'); if (region === 'western') { btnWestern.className = 'px-4 py-2 rounded-full font-medium transition-all duration-300 bg-blue-600 text-white shadow-lg'; btnOther.className = 'px-4 py-2 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700'; } else { btnOther.className = 'px-4 py-2 rounded-full font-medium transition-all duration-300 bg-blue-600 text-white shadow-lg'; btnWestern.className = 'px-4 py-2 rounded-full font-medium transition-all duration-300 bg-gray-200 text-gray-700'; } saveState(); }
        function toggleDropdown(id) { document.getElementById(id).classList.toggle('active'); document.getElementById(id.replace('-dropdown', '-arrow')).classList.toggle('rotate-arrow'); }
        
        function updateTitle() { 
            const stageTitleInput = document.getElementById('stage-title-input'); 
            let titleText = '';
            
            if (selectedGrades.includes('all')) {
                titleText = 'ูุฌููุน ุงููุฑุงุญู ุงูุฏุฑุงุณูุฉ';
            } else if (selectedGrades.length > 0) {
                const parts = [];
                const primaryGrades = ['p1', 'p2', 'p3', 'p4', 'p5', 'p6'];
                const hasLowerPrimary = selectedGrades.includes('primary_lower');
                const hasUpperPrimary = selectedGrades.includes('primary_upper');
                const hasQuranLower = selectedGrades.includes('quran_lower');
                const hasQuranUpper = selectedGrades.includes('quran_upper');
                
                if (hasLowerPrimary && hasUpperPrimary) parts.push('ูููุฑุญูุฉ ุงูุงุจุชุฏุงุฆูุฉ');
                else if (hasLowerPrimary) parts.push('ููุตููู ุงูุฃูููุฉ');
                else if (hasUpperPrimary) parts.push('ููุตููู ุงูุนููุง');

                if (hasQuranLower && hasQuranUpper) parts.push('ูููุฑุญูุฉ ุงูุงุจุชุฏุงุฆูุฉ ุชุญููุธ');
                else {
                    const quranIndividuals = selectedGrades.filter(g => g.startsWith('quran'));
                    if (quranIndividuals.length > 0) parts.push(...quranIndividuals.map(g => gradeNames[g]));
                }

                if (selectedGrades.includes('middle_all')) parts.push('ูููุฑุญูุฉ ุงููุชูุณุทุฉ');
                else {
                    const middleIndividuals = selectedGrades.filter(g => g.startsWith('m'));
                    if (middleIndividuals.length > 0) parts.push(...middleIndividuals.map(g => gradeNames[g]));
                }

                if (selectedGrades.includes('high_all')) parts.push('ูููุฑุญูุฉ ุงูุซุงูููุฉ');
                else {
                    const highIndividuals = selectedGrades.filter(g => g.startsWith('h'));
                    if (highIndividuals.length > 0) parts.push(...highIndividuals.map(g => gradeNames[g]));
                }
                
                const individualPrimary = selectedGrades.filter(g => primaryGrades.includes(g) && !hasLowerPrimary && !hasUpperPrimary);
                if (individualPrimary.length > 0) parts.push(...individualPrimary.map(g => gradeNames[g]));
                
                titleText = 'ูู ' + [...new Set(parts)].join(' ู ');
            }
            
            // ููุท ูููู ุจุงูุชุฑุงุญ ุงูุนููุงู ุฅุฐุง ูุงู ุงูุญูู ูุงุฑุบุงูุ ุฃู ูููู ุจุชุญุฏูุซู ุจุดูู ุฐูู
            if(titleText) {
               stageTitleInput.value = titleText;
            }
        }

        function clearAllFilters() { selectedGrades = []; updateButtonStyles(); updateTitle(); updateAllDateSelectors(); saveState(); }
        function clearGradeDates(programId, key) { const display = document.querySelector(`tr[data-program-id="${programId}"] .grade-date-selector[data-grade-key="${key}"] .dates-display`); if (display) { display.textContent = ''; display.dataset.dates = '[]'; saveState(); } }

        // --- ุงูููุฏุงู ---
        function openDatePicker(programId, key) { activeSelection = { programId, key }; const row = document.querySelector(`tr[data-program-id="${programId}"]`); const sessions = JSON.parse(row.dataset.sessions); const individualGradeKeys = gradeGroups[key] || [key]; const maxSessions = Math.max(0, ...individualGradeKeys.map(g => sessions[g] || 0)); document.getElementById('modal-title').textContent = `${row.dataset.programName} - ${getLabel(key)}`; const displayDiv = row.querySelector(`.grade-date-selector[data-grade-key="${key}"] .dates-display`); tempSelectedDates = displayDiv.dataset.dates ? JSON.parse(displayDiv.dataset.dates) : []; updateDatePickerCounter(maxSessions); currentModalSemester = 1; renderSemesterTab(1, maxSessions); document.getElementById('date-picker-modal').style.display = 'flex'; }
        function switchSemesterTab(semesterNum) { const row = document.querySelector(`tr[data-program-id="${activeSelection.programId}"]`); const sessions = JSON.parse(row.dataset.sessions); const individualGradeKeys = gradeGroups[activeSelection.key] || [activeSelection.key]; const maxSessions = Math.max(0, ...individualGradeKeys.map(g => sessions[g] || 0)); currentModalSemester = semesterNum; renderSemesterTab(semesterNum, maxSessions); }
        function renderSemesterTab(semesterNum, maxSessions) { document.getElementById('tab-sem-1').classList.toggle('active', semesterNum === 1); document.getElementById('tab-sem-2').classList.toggle('active', semesterNum === 2); const container = document.getElementById('modal-weeks-container'); container.innerHTML = ''; const weeksArray = Object.entries(weeksData).filter(([, data]) => data.semester === semesterNum); weeksArray.forEach(([weekKey, weekData]) => { const weekDiv = document.createElement('div'); weekDiv.className = 'p-2 border rounded-md mb-2'; weekDiv.innerHTML = `<p class="font-semibold text-center mb-2 text-sm bg-gray-100 p-1 rounded">${weekData.name} (${weekData.startDate} - ${weekData.endDate})</p>`; const weekGrid = document.createElement('div'); weekGrid.className = 'week-grid grid grid-cols-5 gap-2'; Object.entries(weekData.days).forEach(([dayName, dayDate]) => { const dayButton = document.createElement('button'); const fullDate = `${dayName} ${dayDate}`; dayButton.className = 'day p-2 border rounded-md text-xs h-16 flex flex-col items-center justify-center gap-1'; dayButton.dataset.date = fullDate; let buttonContent = `<span>${dayName}</span><span class="font-bold">${dayDate}</span>`; if (weekData.specialDays && weekData.specialDays[dayDate]) { const special = weekData.specialDays[dayDate]; buttonContent += `<span class="text-[10px] text-${special.color || 'red'}-600 leading-tight font-bold">${special.name}</span>`; if (special.type === 'holiday') { dayButton.classList.add('disabled'); dayButton.disabled = true; } else { dayButton.onclick = () => toggleDateSelection(dayButton, maxSessions); } } else if (!dayButton.disabled) { dayButton.onclick = () => toggleDateSelection(dayButton, maxSessions); } if (tempSelectedDates.includes(fullDate)) dayButton.classList.add('selected'); dayButton.innerHTML = buttonContent; weekGrid.appendChild(dayButton); }); weekDiv.appendChild(weekGrid); container.appendChild(weekDiv); }); }
        function toggleDateSelection(button, max) { const date = button.dataset.date; if (tempSelectedDates.includes(date)) { tempSelectedDates = tempSelectedDates.filter(d => d !== date); button.classList.remove('selected'); } else { if (tempSelectedDates.length >= max) { alert(`ุงูุญุฏ ุงูุฃูุตู ${max} ุญุตุต.`); return; } tempSelectedDates.push(date); button.classList.add('selected'); } updateDatePickerCounter(max); }
        function updateDatePickerCounter(max) { document.getElementById('modal-date-counter').textContent = `ุชู ุงุฎุชูุงุฑ ${tempSelectedDates.length} ูู ${max}`; }
        function closeDatePicker() { document.getElementById('date-picker-modal').style.display = 'none'; activeSelection = null; }
        function saveDates() { if (!activeSelection) return; const { programId, key } = activeSelection; const display = document.querySelector(`tr[data-program-id="${programId}"] .grade-date-selector[data-grade-key="${key}"] .dates-display`); const formatted = formatDatesForDisplay(tempSelectedDates); display.textContent = formatted.text; display.dataset.dates = formatted.json; saveState(); closeDatePicker(); }

        // --- ุฏุงูุฉ ุงููุณุฎ ูููููุฑุฉ (ุงูุญู ุงูุญูููู ููุขูููู) ---
        function copyToClipboard() {
            // 1. ุชูููุฏ ูุญุชูู ุงูุฌุฏูู ุงูุซุงูู ููุท (ุฌุฏูู ุงููุชุงุจุนุฉ) ูุฃูู ูู ุงูููู
            const state = JSON.parse(localStorage.getItem('activityPlanState'));
            let detectedSemester = 1;
            const allDates = [];
            if(state.programSelections) { Object.values(state.programSelections).forEach(p => { if(p.datesByGrade) Object.values(p.datesByGrade).forEach(arr => allDates.push(...arr)); }); }
            const s2WeekKeys = Object.keys(weeksData).filter(k => weeksData[k].semester === 2);
            for(let date of allDates) { const dateOnly = date.split(' ').slice(1).join(' '); const foundWeek = s2WeekKeys.find(wk => Object.values(weeksData[wk].days).includes(dateOnly)); if(foundWeek) { detectedSemester = 2; break; } }

            let tableHTML = `<table border="1" style="border-collapse: collapse; width: 100%; direction: rtl;">
                <thead>
                    <tr style="background-color:#f3f4f6;">
                        <th>ู</th><th>ุงููุฌุงู</th><th>ุงููุนูู ุงููููุฐ</th><th>ุงูุจุฑูุงูุฌ</th><th>ุชุงุฑูุฎ ุงูุชูููุฐ</th><th>ุญุงูุฉ ุงูุชูููุฐ</th><th>ููุงุญุธุงุช</th>
                    </tr>
                </thead>
                <tbody>`;

            let programNumber = 1;
            const getProgramAndGradeLabels = (program, sessionsByGrade) => { const programLabels = []; const effectiveSelection = state.selectedGrades; const handledGrades = new Set(); effectiveSelection.forEach(key => { let label; let sessionsCount; if (gradeGroups[key]) { label = getLabel(key); sessionsCount = Math.max(0, ...gradeGroups[key].map(g => program.sessions[g] || 0)); if (sessionsCount > 0) { programLabels.push(`${label} ${sessionsCount} ุญุตุฉ`); gradeGroups[key].forEach(g => handledGrades.add(g)); } } else if (!handledGrades.has(key)) { label = getLabel(key); sessionsCount = program.sessions[key] || 0; if (sessionsCount > 0) { programLabels.push(`${label} ${sessionsCount} ุญุตุฉ`); handledGrades.add(key); } } }); return `${program.name} (${programLabels.join(' ู ')})`; };
            const selectedPrograms = [];
            activitiesData.forEach(field => { field.programs.forEach((program, programIndex) => { const programId = `${field.id}-${programIndex}`; if (state.programSelections && state.programSelections[programId]) { selectedPrograms.push({ field, program, programId, selectionData: state.programSelections[programId] }); } }); });
            
            selectedPrograms.forEach(item => {
                const { field, program, selectionData } = item; 
                const datesByGrade = selectionData?.datesByGrade || {}; 
                const notes = selectionData?.notes || '';
                const teachersByGrade = selectionData?.teachersByGrade || {};
                const teacherNamesSet = new Set();
                Object.values(teachersByGrade).forEach(name => { if (name && name.trim() !== "") teacherNamesSet.add(name.trim()); });
                const teacherNamesText = teacherNamesSet.size > 0 ? [...teacherNamesSet].join('ุ ') : '';
                const programAndGradeText = getProgramAndGradeLabels(program, program.sessions); const allDates = Object.values(datesByGrade).flat();
                const semesterDates = allDates.filter(d => { const dateOnly = d.split(' ').slice(1).join(' '); const weekKey = Object.keys(weeksData).find(wk => Object.values(weeksData[wk].days).includes(dateOnly)); return weekKey && weeksData[weekKey].semester === detectedSemester; });
                
                if (semesterDates.length > 0) {
                    const formattedDates = formatDatesForDisplay(semesterDates).text;
                    tableHTML += `<tr>
                        <td style="padding:5px; text-align:center;">${programNumber++}</td>
                        <td style="padding:5px; text-align:center;">${field.title}</td>
                        <td style="padding:5px; text-align:center;">${teacherNamesText}</td>
                        <td style="padding:5px; text-align:right;">${program.name} <span style="font-size:0.8em; color:#666;">${programAndGradeText.replace(program.name, '')}</span></td>
                        <td style="padding:5px; text-align:right;">${formattedDates}</td>
                        <td style="padding:5px; text-align:center;">โก ููุฐ  โก ูู ูููุฐ</td>
                        <td style="padding:5px;">${notes}</td>
                    </tr>`;
                }
            });
            tableHTML += `</tbody></table>`;

            // ูุถุน ุงูุฌุฏูู ูู ุงูุญุงููุฉ ุงููุฎููุฉ ููุณุฎู
            const container = document.getElementById('clipboard-container');
            container.innerHTML = tableHTML;
            
            const range = document.createRange();
            range.selectNode(container);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            try {
                document.execCommand('copy');
                const toast = document.getElementById('copy-toast');
                toast.className = "show";
                setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
            } catch (err) {
                alert('ูุดู ุงููุณุฎ ุงูุชููุงุฆู. ูุฑุฌู ุชุญุฏูุฏ ุงูุฌุฏูู ููุณุฎู ูุฏููุงู.');
            }
            
            window.getSelection().removeAllRanges();
        }

        // --- ุงูุทุจุงุนุฉ (ููุณ ุงูููุฏ ุงูุณุงุจู ูุน ุงูุฅุตูุงุญุงุช) ---
        function printSchedule() {
            if (isPrinting) return; isPrinting = true; saveState();
            const state = JSON.parse(localStorage.getItem('activityPlanState'));
            let detectedSemester = 1;
            const allDates = [];
            if(state.programSelections) { Object.values(state.programSelections).forEach(p => { if(p.datesByGrade) Object.values(p.datesByGrade).forEach(arr => allDates.push(...arr)); }); }
            const s2WeekKeys = Object.keys(weeksData).filter(k => weeksData[k].semester === 2);
            for(let date of allDates) { const dateOnly = date.split(' ').slice(1).join(' '); const foundWeek = s2WeekKeys.find(wk => Object.values(weeksData[wk].days).includes(dateOnly)); if(foundWeek) { detectedSemester = 2; break; } }

            const row1Weeks = Object.keys(weeksData).filter(k => weeksData[k].semester === detectedSemester).slice(0, 7);
            const row2Weeks = Object.keys(weeksData).filter(k => weeksData[k].semester === detectedSemester).slice(7, 14);
            const row3Weeks = Object.keys(weeksData).filter(k => weeksData[k].semester === detectedSemester).slice(14);

            const programsByWeekAndField = {};
            const getWeekInfoForDate = (fullDateStr) => { const datePartWithSpaces = fullDateStr.split(' ').slice(1).join(' '); for (const weekKey in weeksData) { if (Object.values(weeksData[weekKey].days).includes(datePartWithSpaces)) return weeksData[weekKey]; } return null; };
            const weeklyBreakdown = {}; 
            if (state.programSelections) {
                Object.entries(state.programSelections).forEach(([id, data]) => {
                    let programInfo, fieldTitle;
                    for (const field of activitiesData) { const idx = field.programs.findIndex(p => `${field.id}-${field.programs.indexOf(p)}` === id); if (idx !== -1) { programInfo = field.programs[idx]; fieldTitle = field.title; break; } }
                    if (!programInfo) return;
                    Object.entries(data.datesByGrade || {}).forEach(([gradeKey, dateArray]) => {
                        if (selectedGrades.includes(gradeKey) || (gradeGroups[gradeKey] && selectedGrades.includes(gradeKey))) {
                            dateArray.forEach(dateStr => {
                                const weekInfo = getWeekInfoForDate(dateStr);
                                if (weekInfo && weekInfo.semester === detectedSemester) {
                                    const weekKey = Object.keys(weeksData).find(key => weeksData[key] === weekInfo);
                                    if (!weeklyBreakdown[weekKey]) weeklyBreakdown[weekKey] = {};
                                    if (!weeklyBreakdown[weekKey][programInfo.name]) { weeklyBreakdown[weekKey][programInfo.name] = { fieldTitle: fieldTitle, grades: {} }; }
                                    const label = getLabel(gradeKey);
                                    weeklyBreakdown[weekKey][programInfo.name].grades[label] = (weeklyBreakdown[weekKey][programInfo.name].grades[label] || 0) + 1;
                                }
                            });
                        }
                    });
                });
            }
            Object.keys(weeklyBreakdown).forEach(weekKey => {
                const weekData = weeklyBreakdown[weekKey];
                programsByWeekAndField[weekKey] = {}; 
                Object.keys(weekData).forEach(progName => {
                    const info = weekData[progName];
                    const details = Object.entries(info.grades).map(([gName, count]) => `${gName}: ${count}`).join('ุ ');
                    const displayText = `${progName}<br><span class="session-details">(${details})</span>`;
                    if (!programsByWeekAndField[weekKey][info.fieldTitle]) programsByWeekAndField[weekKey][info.fieldTitle] = [];
                    programsByWeekAndField[weekKey][info.fieldTitle].push(displayText);
                });
            });

            const getWeekContent = (weeks) => {
                let weekHtml = ''; let programHtml = '';
                weeks.forEach((weekKey) => {
                        const weekData = weeksData[weekKey]; if (!weekData) return;
                        let weekLabel = weekData.name; let programsContent = '';
                        if (weekData.holidayDetails) { programsContent = `<div class="holiday-details">${weekData.holidayDetails}</div>`; } 
                        else {
                            const fieldNames = Object.keys(programsByWeekAndField[weekKey] || {});
                            if (fieldNames.length > 0) { fieldNames.forEach(fieldName => { const fieldColor = activitiesData.find(a=>a.title===fieldName)?.color || 'black'; programsContent += `<strong style="color: ${fieldColor};">${fieldName}</strong><br><div class="program-entries">` + (programsByWeekAndField[weekKey][fieldName] || []).map(p => `<div class="program-entry">${p}</div>`).join('') + `</div>`; }); }
                        }
                        weekHtml += `<th class="week-header">${weekLabel}<br>(${weekData.startDate} - ${weekData.endDate})</th>`;
                        programHtml += `<td>${programsContent}</td>`;
                });
                return { weekHtml, programHtml };
            };

            const row1Data = getWeekContent(row1Weeks);
            const row2Data = getWeekContent(row2Weeks);
            const row3Data = getWeekContent(row3Weeks);
            
            const semesterTitle = detectedSemester === 1 ? 'ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู' : 'ุงููุตู ุงูุฏุฑุงุณู ุงูุซุงูู';
            const mainTitleText = document.getElementById('main-title-input').value;
            const stageTitleText = document.getElementById('stage-title-input').value;
            
            let secondTableRows = ''; let programNumber = 1;
            const getProgramAndGradeLabels = (program, sessionsByGrade) => { const programLabels = []; const effectiveSelection = state.selectedGrades; const handledGrades = new Set(); effectiveSelection.forEach(key => { let label; let sessionsCount; if (gradeGroups[key]) { label = getLabel(key); sessionsCount = Math.max(0, ...gradeGroups[key].map(g => program.sessions[g] || 0)); if (sessionsCount > 0) { programLabels.push(`${label} ${sessionsCount} ุญุตุฉ`); gradeGroups[key].forEach(g => handledGrades.add(g)); } } else if (!handledGrades.has(key)) { label = getLabel(key); sessionsCount = program.sessions[key] || 0; if (sessionsCount > 0) { programLabels.push(`${label} ${sessionsCount} ุญุตุฉ`); handledGrades.add(key); } } }); return `${program.name} (${programLabels.join(' ู ')})`; };
            const selectedPrograms = [];
            activitiesData.forEach(field => { field.programs.forEach((program, programIndex) => { const programId = `${field.id}-${programIndex}`; if (state.programSelections && state.programSelections[programId]) { selectedPrograms.push({ field, program, programId, selectionData: state.programSelections[programId] }); } }); });
            selectedPrograms.forEach(item => {
                const { field, program, selectionData } = item; 
                const datesByGrade = selectionData?.datesByGrade || {}; 
                const notes = selectionData?.notes || '';
                const teachersByGrade = selectionData?.teachersByGrade || {};
                const teacherNamesSet = new Set();
                Object.values(teachersByGrade).forEach(name => { if (name && name.trim() !== "") teacherNamesSet.add(name.trim()); });
                const teacherNamesText = teacherNamesSet.size > 0 ? [...teacherNamesSet].join('ุ ') : '';
                const programAndGradeText = getProgramAndGradeLabels(program, program.sessions); const allDates = Object.values(datesByGrade).flat();
                const semesterDates = allDates.filter(d => { const dateOnly = d.split(' ').slice(1).join(' '); const weekKey = Object.keys(weeksData).find(wk => Object.values(weeksData[wk].days).includes(dateOnly)); return weekKey && weeksData[weekKey].semester === detectedSemester; });
                if (semesterDates.length > 0) {
                    const formattedDates = formatDatesForDisplay(semesterDates).text;
                    secondTableRows += `<tr class="text-center"><td style="padding: 4px; border: 1px solid #ccc; width: 3%;">${programNumber++}</td><td style="padding: 4px; border: 1px solid #ccc; background-color: ${field.color}; color: white; font-weight: bold; text-align: center; width: 9%;">${field.title}</td><td style="padding: 4px; border: 1px solid #ccc; width: 15%;">${teacherNamesText}</td><td style="padding: 4px; border: 1px solid #ccc; text-align: right; width: 23%;">${program.name}<br><span style="font-size:9pt; color:#666;">${programAndGradeText.replace(program.name, '')}</span></td><td style="padding: 4px; border: 1px solid #ccc; text-align: right; width: 30%;">${formattedDates}</td><td style="padding: 4px; border: 1px solid #ccc; width: 10%;"><div style="display:flex; justify-content:space-around; align-items:center; gap: 2px;"><label style="display:flex; align-items:center; gap:2px;"><input type="checkbox" style="width:10px; height:10px;"> ููุฐ</label><label style="display:flex; align-items:center; gap:2px;"><input type="checkbox" style="width:10px; height:10px;"> ูู ูููุฐ</label></div></td><td style="padding: 4px; border: 1px solid #ccc; width: 10%;">${notes}</td></tr>`;
                }
            });

            const printWindow = window.open('', '_blank', 'width=1200,height=800');
            printWindow.document.write(`<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8">
            <meta name="format-detection" content="telephone=no, date=no, address=no, email=no, url=no">
            <link rel="preconnect" href="https://fonts.googleapis.com">
            <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Readex+Pro:wght@400;700&display=swap" rel="stylesheet">
            <title>ุฎุทุฉ ุงููุดุงุท</title><style>
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; box-sizing: border-box; }
            @page { size: A4 landscape; margin: 0; }
            body { margin: 0; padding: 0; font-family: 'Readex Pro', sans-serif; width: 297mm; }
            a { text-decoration: none !important; color: #000000 !important; pointer-events: none !important; cursor: default !important; }
            .print-fixed-header { position: fixed; top: 0; left: 0; width: 297mm; height: 22mm; background: white; z-index: 1000; }
            .print-fixed-footer { position: fixed; bottom: 0; left: 0; width: 297mm; height: 18mm; background: white; z-index: 1000; }
            .print-header-line { height: 15px; background: linear-gradient(135deg, #00A383 0%, #0093B5 100%); width: 100%; }
            .print-header-content { display: flex; justify-content: space-between; align-items: center; padding: 5mm 15mm 0; width: 100%; }
            .header-right-group { display: flex; align-items: center; gap: 15px; flex: 1; text-align: right; } 
            .header-right-group img { height: 45px; } 
            .school-info-text { display: flex; flex-direction: column; gap: 2px; } 
            .school-info-text p { margin: 0; font-size: 10pt; font-weight: bold; line-height: 1.2; color: #000; } 
            .title-block { text-align: center; flex: 2; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 5px; flex-wrap: nowrap; }
            .title-block h1, .title-block span { color: #00A383; margin: 0; font-size: 1.4em; font-family: 'Cairo', sans-serif; white-space: nowrap; }
            .title-block span { color: #000; font-weight: bold; }
            .title-block p.semester-text { font-size: 1.2em; font-weight: bold; color: #0093B5; margin: 0; white-space: nowrap; } 
            .header-left-spacer { flex: 1; } 
            .print-table { width: 94%; margin: 0 auto; border-collapse: collapse; table-layout: fixed; }
            .print-table th, .print-table td { border: 1px solid #999; padding: 3px; text-align: center; vertical-align: middle; word-wrap: break-word; font-size: 9pt; color: #000; }
            .print-table th { background-color: #f2f2f2; font-weight: bold; }
            .print-table td.week-label { background-color: #e6f7ff; font-weight: bold; color: #005f99; width: 8%; font-size: 10pt; }
            .print-table td.program-label { background-color: #f0f0f0; font-weight: bold; width: 8%; font-size: 10pt; }
            .print-table .week-header { background-color: #e6f7ff; font-weight: bold; color: #005f99; width: 13.14%; font-size: 11px !important; } 
            .holiday-details { font-weight: bold; color: #d32f2f; font-size: 0.85em; line-height: 1.4; padding: 5px; } 
            .program-entry { margin-bottom: 4px; border-bottom: 1px dashed #ccc; padding-bottom: 2px; font-size: 0.85em; } 
            .program-entry:last-child { border-bottom: none; } 
            .session-details { display: block; font-size: 0.9em; color: #555; margin-top: 1px; } 
            .page-break { page-break-before: always; display: block; height: 1px; width: 100%; visibility: hidden; } 
            .second-table-wrapper { width: 94%; margin: 0 auto; margin-top: 0; display: block; }
            .print-second-table { width: 100%; border-collapse: collapse; page-break-inside: auto; font-size: 0.9em; }
            .print-second-table th, .print-second-table td { border: 1px solid #999; padding: 4px; font-size: 9pt; color: #000; }
            .print-second-table th:nth-child(1) { width: 3%; }
            .print-second-table th:nth-child(2) { width: 9%; }
            .print-second-table th:nth-child(3) { width: 15%; }
            .print-second-table th:nth-child(4) { width: 23%; white-space: normal; }
            .print-second-table th:nth-child(5) { width: 30%; }
            .print-second-table th:nth-child(6) { width: 10%; }
            .print-second-table th:nth-child(7) { width: 10%; }
            .print-signatures { display: flex; justify-content: space-around; align-items: center; height: 100%; font-size: 1.1em; font-weight: bold; padding-bottom: 5px; width: 297mm; } 
            .layout-table { width: 100%; border-collapse: collapse; } 
            .layout-table thead { display: table-header-group; } 
            .layout-table tfoot { display: table-footer-group; } 
            .header-space { height: 22mm; } 
            .footer-space { height: 18mm; }</style></head><body>
            <div class="print-fixed-header"><div class="print-header-line"></div><div class="print-header-content"><div class="header-right-group"><div><img src="https://upload.wikimedia.org/wikipedia/ar/thumb/1/17/Saudi_Ministry_of_Education_Logo_2025.png/400px-Saudi_Ministry_of_Education_Logo_2025.png" alt="ุดุนุงุฑ ุงููุฒุงุฑุฉ"></div><div class="school-info-text"><p>${state.educationAdmin}</p><p>${state.educationRegion}</p><p>${state.schoolName}</p></div></div><div class="title-block"><h1>${mainTitleText}</h1><span class="stage-text">${stageTitleText}</span><p class="semester-text">${semesterTitle} ููุนุงู ุงูุฏุฑุงุณู 1447ูู</p></div><div class="header-left-spacer"></div></div></div>
            <table class="layout-table"><thead><tr><td><div class="header-space">&nbsp;</div></td></tr></thead><tbody><tr><td>
            <table class="print-table"><thead><tr><td class="week-label">ุงูุฃุณุงุจูุน</td>${row1Data.weekHtml}</tr><tr><td class="program-label">ุงูุจุฑุงูุฌ</td>${row1Data.programHtml}</tr><tr><td class="week-label">ุงูุฃุณุงุจูุน</td>${row2Data.weekHtml}</tr><tr><td class="program-label">ุงูุจุฑุงูุฌ</td>${row2Data.programHtml}</tr><tr><td class="week-label">ุงูุฃุณุงุจูุน</td>${row3Data.weekHtml}</tr><tr><td class="program-label">ุงูุจุฑุงูุฌ</td>${row3Data.programHtml}</tr></thead><tbody></tbody></table>
            <div class="page-break"></div>
            <div class="second-table-wrapper">
                <table class="print-second-table"><thead><tr class="bg-gray-100 text-gray-700" style="background-color: #f3f4f6; color: #374151;"><th>ู</th><th>ุงููุฌุงู</th><th>ุงููุนูู ุงููููุฐ</th><th>ุงูุจุฑูุงูุฌ</th><th>ุชุงุฑูุฎ ุงูุชูููุฐ</th><th>ุญุงูุฉ ุงูุชูููุฐ</th><th>ููุงุญุธุงุช</th></tr></thead><tbody>${secondTableRows}</tbody></table>
            </div>
            </td></tr></tbody><tfoot><tr><td><div class="footer-space">&nbsp;</div></td></tr></tfoot></table>
            <div class="print-fixed-footer"><div class="print-signatures"><div>${state.activityLeaderName}</div><div>${state.schoolDirectorName}</div></div></div>
            </body></html>`);
            printWindow.document.close();
            setTimeout(() => { printWindow.focus(); printWindow.print(); isPrinting = false; printWindow.close(); }, 500);
        }

        // --- ุฏุงูุฉ ุงูุชุตุฏูุฑ ุฅูู ููุฑุฏ (ุฅุตุฏุงุฑ ูุชูุฏู ูุญุงูู ุงูุชูุงูู ูุน ุงููู) ---
        function exportToWord() {
            const state = JSON.parse(localStorage.getItem('activityPlanState'));
            let detectedSemester = 1;
            const allDates = [];
            if(state.programSelections) { Object.values(state.programSelections).forEach(p => { if(p.datesByGrade) Object.values(p.datesByGrade).forEach(arr => allDates.push(...arr)); }); }
            const s2WeekKeys = Object.keys(weeksData).filter(k => weeksData[k].semester === 2);
            for(let date of allDates) { const dateOnly = date.split(' ').slice(1).join(' '); const foundWeek = s2WeekKeys.find(wk => Object.values(weeksData[wk].days).includes(dateOnly)); if(foundWeek) { detectedSemester = 2; break; } }

            const row1Weeks = Object.keys(weeksData).filter(k => weeksData[k].semester === detectedSemester).slice(0, 7);
            const row2Weeks = Object.keys(weeksData).filter(k => weeksData[k].semester === detectedSemester).slice(7, 14);
            const row3Weeks = Object.keys(weeksData).filter(k => weeksData[k].semester === detectedSemester).slice(14);

            const programsByWeekAndField = {};
            const getWeekInfoForDate = (fullDateStr) => { const datePartWithSpaces = fullDateStr.split(' ').slice(1).join(' '); for (const weekKey in weeksData) { if (Object.values(weeksData[weekKey].days).includes(datePartWithSpaces)) return weeksData[weekKey]; } return null; };
            const weeklyBreakdown = {}; 
            if (state.programSelections) {
                Object.entries(state.programSelections).forEach(([id, data]) => {
                    let programInfo, fieldTitle;
                    for (const field of activitiesData) { const idx = field.programs.findIndex(p => `${field.id}-${field.programs.indexOf(p)}` === id); if (idx !== -1) { programInfo = field.programs[idx]; fieldTitle = field.title; break; } }
                    if (!programInfo) return;
                    Object.entries(data.datesByGrade || {}).forEach(([gradeKey, dateArray]) => {
                        if (selectedGrades.includes(gradeKey) || (gradeGroups[gradeKey] && selectedGrades.includes(gradeKey))) {
                            dateArray.forEach(dateStr => {
                                const weekInfo = getWeekInfoForDate(dateStr);
                                if (weekInfo && weekInfo.semester === detectedSemester) {
                                    const weekKey = Object.keys(weeksData).find(key => weeksData[key] === weekInfo);
                                    if (!weeklyBreakdown[weekKey]) weeklyBreakdown[weekKey] = {};
                                    if (!weeklyBreakdown[weekKey][programInfo.name]) { weeklyBreakdown[weekKey][programInfo.name] = { fieldTitle: fieldTitle, grades: {} }; }
                                    const label = getLabel(gradeKey);
                                    weeklyBreakdown[weekKey][programInfo.name].grades[label] = (weeklyBreakdown[weekKey][programInfo.name].grades[label] || 0) + 1;
                                }
                            });
                        }
                    });
                });
            }
            Object.keys(weeklyBreakdown).forEach(weekKey => {
                const weekData = weeklyBreakdown[weekKey];
                programsByWeekAndField[weekKey] = {}; 
                Object.keys(weekData).forEach(progName => {
                    const info = weekData[progName];
                    const details = Object.entries(info.grades).map(([gName, count]) => `${gName}: ${count}`).join('ุ ');
                    const displayText = `${progName}<br><span style="font-size:9pt; color:#555;">(${details})</span>`;
                    if (!programsByWeekAndField[weekKey][info.fieldTitle]) programsByWeekAndField[weekKey][info.fieldTitle] = [];
                    programsByWeekAndField[weekKey][info.fieldTitle].push(displayText);
                });
            });

            const getWeekContent = (weeks) => {
                let weekHtml = ''; let programHtml = '';
                weeks.forEach((weekKey) => {
                        const weekData = weeksData[weekKey]; if (!weekData) return;
                        let weekLabel = weekData.name; let programsContent = '';
                        if (weekData.holidayDetails) { programsContent = `<div style="color:red; font-weight:bold;">${weekData.holidayDetails}</div>`; } 
                        else {
                            const fieldNames = Object.keys(programsByWeekAndField[weekKey] || {});
                            if (fieldNames.length > 0) { fieldNames.forEach(fieldName => { const fieldColor = activitiesData.find(a=>a.title===fieldName)?.color || 'black'; programsContent += `<strong style="color: ${fieldColor};">${fieldName}</strong><br>` + (programsByWeekAndField[weekKey][fieldName] || []).map(p => `<div style="border-bottom:1px dashed #ccc; margin-bottom:3px;">${p}</div>`).join(''); }); }
                        }
                        weekHtml += `<th style="background:#e6f7ff; color:#005f99; border:1px solid #000; padding:5px;">${weekLabel}<br>(${weekData.startDate} - ${weekData.endDate})</th>`;
                        programHtml += `<td style="border:1px solid #000; padding:5px; vertical-align:top;">${programsContent}</td>`;
                });
                return { weekHtml, programHtml };
            };

            const row1Data = getWeekContent(row1Weeks);
            const row2Data = getWeekContent(row2Weeks);
            const row3Data = getWeekContent(row3Weeks);

            let secondTableRows = ''; let programNumber = 1;
            const getProgramAndGradeLabels = (program, sessionsByGrade) => { const programLabels = []; const effectiveSelection = state.selectedGrades; const handledGrades = new Set(); effectiveSelection.forEach(key => { let label; let sessionsCount; if (gradeGroups[key]) { label = getLabel(key); sessionsCount = Math.max(0, ...gradeGroups[key].map(g => program.sessions[g] || 0)); if (sessionsCount > 0) { programLabels.push(`${label} ${sessionsCount} ุญุตุฉ`); gradeGroups[key].forEach(g => handledGrades.add(g)); } } else if (!handledGrades.has(key)) { label = getLabel(key); sessionsCount = program.sessions[key] || 0; if (sessionsCount > 0) { programLabels.push(`${label} ${sessionsCount} ุญุตุฉ`); handledGrades.add(key); } } }); return `${program.name} (${programLabels.join(' ู ')})`; };
            const selectedPrograms = [];
            activitiesData.forEach(field => { field.programs.forEach((program, programIndex) => { const programId = `${field.id}-${programIndex}`; if (state.programSelections && state.programSelections[programId]) { selectedPrograms.push({ field, program, programId, selectionData: state.programSelections[programId] }); } }); });
            selectedPrograms.forEach(item => {
                const { field, program, selectionData } = item; 
                const datesByGrade = selectionData?.datesByGrade || {}; 
                const notes = selectionData?.notes || '';
                const teachersByGrade = selectionData?.teachersByGrade || {};
                const teacherNamesSet = new Set();
                Object.values(teachersByGrade).forEach(name => { if (name && name.trim() !== "") teacherNamesSet.add(name.trim()); });
                const teacherNamesText = teacherNamesSet.size > 0 ? [...teacherNamesSet].join('ุ ') : '';
                const programAndGradeText = getProgramAndGradeLabels(program, program.sessions); const allDates = Object.values(datesByGrade).flat();
                const semesterDates = allDates.filter(d => { const dateOnly = d.split(' ').slice(1).join(' '); const weekKey = Object.keys(weeksData).find(wk => Object.values(weeksData[wk].days).includes(dateOnly)); return weekKey && weeksData[weekKey].semester === detectedSemester; });
                if (semesterDates.length > 0) {
                    const formattedDates = formatDatesForDisplay(semesterDates).text;
                    secondTableRows += `<tr><td style="border:1px solid #000; padding:5px; text-align:center;">${programNumber++}</td><td style="border:1px solid #000; padding:5px; text-align:center; background-color:${field.color}; color:white;">${field.title}</td><td style="border:1px solid #000; padding:5px; text-align:center;">${teacherNamesText}</td><td style="border:1px solid #000; padding:5px; text-align:right;">${program.name}<br><span style="font-size:9pt; color:#666;">${programAndGradeText.replace(program.name, '')}</span></td><td style="border:1px solid #000; padding:5px; text-align:right;">${formattedDates}</td><td style="border:1px solid #000; padding:5px; text-align:center;">โก ููุฐ โก ูู ูููุฐ</td><td style="border:1px solid #000; padding:5px;">${notes}</td></tr>`;
                }
            });

            const mainTitle = document.getElementById('main-title-input').value;
            const stageTitle = document.getElementById('stage-title-input').value;
            const semesterTitle = detectedSemester === 1 ? 'ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู' : 'ุงููุตู ุงูุฏุฑุงุณู ุงูุซุงูู';

            const content = `
            <!DOCTYPE html>
            <html lang="ar" dir="rtl">
            <head><meta charset="utf-8"><title>${mainTitle}</title></head>
            <body style="font-family: Arial; text-align: right; direction: rtl;">
                <h1 style="text-align:center; color:#00A383;">${mainTitle} ${stageTitle}</h1>
                <h3 style="text-align:center; color:#0093B5;">${semesterTitle} ููุนุงู 1447ูู</h3>
                
                <p><strong>ุงูุฅุฏุงุฑุฉ:</strong> ${state.educationAdmin}<br><strong>ุงูููุทูุฉ:</strong> ${state.educationRegion}<br><strong>ุงููุฏุฑุณุฉ:</strong> ${state.schoolName}</p>
                <hr>
                
                <table style="width:100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead><tr><th style="border:1px solid #000; padding:5px; background:#e6f7ff;">ุงูุฃุณุงุจูุน</th>${row1Data.weekHtml}</tr></thead>
                    <tbody>
                        <tr><td style="border:1px solid #000; padding:5px; background:#f0f0f0;">ุงูุจุฑุงูุฌ</td>${row1Data.programHtml}</tr>
                        <tr><td style="border:1px solid #000; padding:5px; background:#e6f7ff;">ุงูุฃุณุงุจูุน</td>${row2Data.weekHtml}</tr>
                        <tr><td style="border:1px solid #000; padding:5px; background:#f0f0f0;">ุงูุจุฑุงูุฌ</td>${row2Data.programHtml}</tr>
                        <tr><td style="border:1px solid #000; padding:5px; background:#e6f7ff;">ุงูุฃุณุงุจูุน</td>${row3Data.weekHtml}</tr>
                        <tr><td style="border:1px solid #000; padding:5px; background:#f0f0f0;">ุงูุจุฑุงูุฌ</td>${row3Data.programHtml}</tr>
                    </tbody>
                </table>

                <br style="page-break-before: always;">

                <h2 style="text-align:center;">ุฌุฏูู ุงููุชุงุจุนุฉ ูุงูุชูููุฐ</h2>
                <table style="width:100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color:#f3f4f6;">
                            <th style="border:1px solid #000; padding:5px;">ู</th>
                            <th style="border:1px solid #000; padding:5px;">ุงููุฌุงู</th>
                            <th style="border:1px solid #000; padding:5px;">ุงููุนูู ุงููููุฐ</th>
                            <th style="border:1px solid #000; padding:5px;">ุงูุจุฑูุงูุฌ</th>
                            <th style="border:1px solid #000; padding:5px;">ุชุงุฑูุฎ ุงูุชูููุฐ</th>
                            <th style="border:1px solid #000; padding:5px;">ุญุงูุฉ ุงูุชูููุฐ</th>
                            <th style="border:1px solid #000; padding:5px;">ููุงุญุธุงุช</th>
                        </tr>
                    </thead>
                    <tbody>${secondTableRows}</tbody>
                </table>
                <br>
                <p style="text-align:center;"><strong>ุฑุงุฆุฏ/ุฉ ุงููุดุงุท:</strong> ${state.activityLeaderName} &nbsp;&nbsp;&nbsp; <strong>ูุฏูุฑ/ุฉ ุงููุฏุฑุณุฉ:</strong> ${state.schoolDirectorName}</p>
            </body></html>`;

            // ุงููุญุงููุฉ ุงูุฃููู: ุชุญููู HTML ุฅูู DOCX (ููุญูุงุณูุจ)
            try {
                if (typeof htmlDocx !== 'undefined') {
                    const converted = htmlDocx.asBlob(content, { orientation: 'landscape' });
                    saveAs(converted, `ุฎุทุฉ_ุงููุดุงุท_${state.schoolName || 'ุงููุฏุฑุณุฉ'}.docx`);
                } else {
                    // ุฅุฐุง ูุดูุช ุงูููุชุจุฉุ ูุนูุฏ ููุทุฑููุฉ ุงููุฏููุฉ (HTML ูู DOC)
                    const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
                    saveAs(blob, `ุฎุทุฉ_ุงููุดุงุท_${state.schoolName || 'ุงููุฏุฑุณุฉ'}.doc`);
                }
            } catch(e) {
                alert("ุชุนุฐุฑ ุชุตุฏูุฑ ุงูููู ุชููุงุฆูุงู. ูุฑุฌู ุงุณุชุฎุฏุงู ุฒุฑ ุงููุณุฎ.");
            }
        }

        function saveBackup() { saveState(); const blob = new Blob([localStorage.getItem('activityPlanState')], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'plan_backup.json'; a.click(); }
        function handleFileUpload(e) { const reader = new FileReader(); reader.onload = (event) => { localStorage.setItem('activityPlanState', event.target.result); location.reload(); }; reader.readAsText(e.target.files[0]); }
        function saveState() {
            if (isLoading) return;
            const programSelections = {}; document.querySelectorAll('tr[data-program-id]').forEach(row => { const id = row.dataset.programId; const teachers = {}, dates = {}; row.querySelectorAll('.teacher-input').forEach(i => { if(i.value) teachers[i.dataset.gradeKey] = i.value; }); row.querySelectorAll('.dates-display').forEach(d => { const ds = JSON.parse(d.dataset.dates || '[]'); if(ds.length) dates[d.closest('.grade-date-selector').dataset.gradeKey] = ds; }); if(Object.keys(teachers).length || Object.keys(dates).length) programSelections[id] = { teachersByGrade: teachers, datesByGrade: dates }; });
            
            const customMainTitle = document.getElementById('main-title-input').value;
            const customStageTitle = document.getElementById('stage-title-input').value;

            const state = { 
                educationAdmin: document.getElementById('education-admin').value, 
                educationRegion: document.getElementById('education-region').value, 
                schoolName: document.getElementById('school-name').value, 
                activityLeaderName: document.getElementById('activity-leader-name').value, 
                schoolDirectorName: document.getElementById('school-director-name').value, 
                currentRegion, 
                selectedGrades, 
                programSelections,
                customMainTitle,
                customStageTitle
            };
            localStorage.setItem('activityPlanState', JSON.stringify(state));
        }
        function loadState() {
            isLoading = true; const state = JSON.parse(localStorage.getItem('activityPlanState') || '{}');
            document.getElementById('school-name').value = state.schoolName || ''; document.getElementById('education-admin').value = state.educationAdmin || ''; document.getElementById('education-region').value = state.educationRegion || ''; document.getElementById('activity-leader-name').value = state.activityLeaderName || ''; document.getElementById('school-director-name').value = state.schoolDirectorName || '';
            if (state.customMainTitle) document.getElementById('main-title-input').value = state.customMainTitle;
            if (state.customStageTitle) document.getElementById('stage-title-input').value = state.customStageTitle;
            selectedGrades = state.selectedGrades || [];
            selectRegion(state.currentRegion || 'other'); 
            updateButtonStyles(); updateAllDateSelectors();
            if(state.programSelections) { Object.entries(state.programSelections).forEach(([id, data]) => { const row = document.querySelector(`tr[data-program-id="${id}"]`); if(row) { if(data.teachersByGrade) Object.entries(data.teachersByGrade).forEach(([k, v]) => { const i = row.querySelector(`.teacher-input[data-grade-key="${k}"]`); if(i) i.value = v; }); if(data.datesByGrade) Object.entries(data.datesByGrade).forEach(([k, v]) => { const d = row.querySelector(`.grade-date-selector[data-grade-key="${k}"] .dates-display`); if(d) { d.textContent = formatDatesForDisplay(v).text; d.dataset.dates = JSON.stringify(v); } }); } }); }
            isLoading = false;
        }
        function resetPlan() { if(confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ูุงูุฉ ุงูุจูุงูุงุชุ')) { localStorage.removeItem('activityPlanState'); location.reload(); } }
        document.addEventListener('DOMContentLoaded', () => { createGradeSelectionUI(); generateSections(); loadState(); });
    </script>
</body>
</html>
